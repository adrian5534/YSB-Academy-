'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _entries = require('babel-runtime/core-js/object/entries');

var _entries2 = _interopRequireDefault(_entries);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

var _synchronizationListener = require('../clients/metaApi/synchronizationListener');

var _synchronizationListener2 = _interopRequireDefault(_synchronizationListener);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Responsible for storing a local copy of remote terminal state
 */
class TerminalState extends _synchronizationListener2.default {

  /**
   * Constructs the instance of terminal state class
   */
  constructor() {
    super();
    this._stateByInstanceIndex = {};
    this._waitForPriceResolves = {};
  }

  /**
   * Returns true if MetaApi have connected to MetaTrader terminal
   * @return {Boolean} true if MetaApi have connected to MetaTrader terminal
   */
  get connected() {
    return (0, _values2.default)(this._stateByInstanceIndex).reduce((acc, s) => acc || s.connected, false);
  }

  /**
   * Returns true if MetaApi have connected to MetaTrader terminal and MetaTrader terminal is connected to broker
   * @return {Boolean} true if MetaApi have connected to MetaTrader terminal and MetaTrader terminal is connected to
   * broker
   */
  get connectedToBroker() {
    return (0, _values2.default)(this._stateByInstanceIndex).reduce((acc, s) => acc || s.connectedToBroker, false);
  }

  /**
   * Returns a local copy of account information
   * @returns {MetatraderAccountInformation} local copy of account information
   */
  get accountInformation() {
    return this._getBestState().accountInformation;
  }

  /**
   * Returns a local copy of MetaTrader positions opened
   * @returns {Array<MetatraderPosition>} a local copy of MetaTrader positions opened
   */
  get positions() {
    return this._getBestState().positions;
  }

  /**
   * Returns a local copy of MetaTrader orders opened
   * @returns {Array<MetatraderOrder>} a local copy of MetaTrader orders opened
   */
  get orders() {
    return this._getBestState().orders;
  }

  /**
   * Returns a local copy of symbol specifications available in MetaTrader trading terminal
   * @returns {Array<MetatraderSymbolSpecification>} a local copy of symbol specifications available in MetaTrader
   * trading terminal
   */
  get specifications() {
    return this._getBestState().specifications;
  }

  /**
   * Returns MetaTrader symbol specification by symbol
   * @param {String} symbol symbol (e.g. currency pair or an index)
   * @return {MetatraderSymbolSpecification} MetatraderSymbolSpecification found or undefined if specification for a
   * symbol is not found
   */
  specification(symbol) {
    return this._getBestState(symbol, 'specification').specificationsBySymbol[symbol];
  }

  /**
   * Returns MetaTrader symbol price by symbol
   * @param {String} symbol symbol (e.g. currency pair or an index)
   * @return {MetatraderSymbolPrice} MetatraderSymbolPrice found or undefined if price for a symbol is not found
   */
  price(symbol) {
    return this._getBestState(symbol, 'price').pricesBySymbol[symbol];
  }

  /**
   * Waits for price to be received
   * @param {string} symbol symbol (e.g. currency pair or an index)
   * @param {number} [timeoutInSeconds] timeout in seconds, default is 30
   * @return {Promise<MetatraderSymbolPrice>} promise resolving with price or undefined if price has not been received
   */
  async waitForPrice(symbol, timeoutInSeconds = 30) {
    this._waitForPriceResolves[symbol] = this._waitForPriceResolves[symbol] || [];
    if (!this.price(symbol)) {
      await _promise2.default.race([new _promise2.default(res => this._waitForPriceResolves[symbol].push(res)), new _promise2.default(res => setTimeout(res, timeoutInSeconds * 1000))]);
    }
    return this.price(symbol);
  }

  /**
   * Invoked when connection to MetaTrader terminal established
   * @param {String} instanceIndex index of an account instance connected
   */
  onConnected(instanceIndex) {
    this._getState(instanceIndex).connected = true;
  }

  /**
   * Invoked when connection to MetaTrader terminal terminated
   * @param {String} instanceIndex index of an account instance connected
   */
  onDisconnected(instanceIndex) {
    let state = this._getState(instanceIndex);
    state.connected = false;
    state.connectedToBroker = false;
  }

  /**
   * Invoked when broker connection status have changed
   * @param {String} instanceIndex index of an account instance connected
   * @param {Boolean} connected is MetaTrader terminal is connected to broker
   */
  onBrokerConnectionStatusChanged(instanceIndex, connected) {
    this._getState(instanceIndex).connectedToBroker = connected;
  }

  /**
   * Invoked when MetaTrader terminal state synchronization is started
   * @param {String} instanceIndex index of an account instance connected
   * @return {Promise} promise which resolves when the asynchronous event is processed
   */
  onSynchronizationStarted(instanceIndex) {
    let state = this._getState(instanceIndex);
    state.accountInformation = undefined;
    state.positions = [];
    state.orders = [];
    state.specifications = [];
    state.specificationsBySymbol = {};
    state.pricesBySymbol = {};
    state.completedOrders = {};
    state.removedPositions = {};
    state.ordersInitialized = false;
    state.positionsInitialized = false;
  }

  /**
   * Invoked when MetaTrader account information is updated
   * @param {String} instanceIndex index of an account instance connected
   * @param {MetatraderAccountInformation} accountInformation updated MetaTrader account information
   */
  onAccountInformationUpdated(instanceIndex, accountInformation) {
    let state = this._getState(instanceIndex);
    state.accountInformation = accountInformation;
    state.initializationCounter = 1;
  }

  /**
   * Invoked when the positions are replaced as a result of initial terminal state synchronization
   * @param {String} instanceIndex index of an account instance connected
   * @param {Array<MetatraderPosition>} positions updated array of positions
   * @return {Promise} promise which resolves when the asynchronous event is processed
   */
  onPositionsReplaced(instanceIndex, positions) {
    let state = this._getState(instanceIndex);
    state.positions = positions;
    state.removedPositions = {};
    state.positionsInitialized = true;
    state.initializationCounter = 2;
  }

  /**
   * Invoked when MetaTrader position is updated
   * @param {String} instanceIndex index of an account instance connected
   * @param {MetatraderPosition} position updated MetaTrader position
   */
  onPositionUpdated(instanceIndex, position) {
    let state = this._getState(instanceIndex);
    let index = state.positions.findIndex(p => p.id === position.id);
    if (index !== -1) {
      state.positions[index] = position;
    } else if (!state.removedPositions[position.id]) {
      state.positions.push(position);
    }
  }

  /**
   * Invoked when MetaTrader position is removed
   * @param {String} instanceIndex index of an account instance connected
   * @param {String} positionId removed MetaTrader position id
   */
  onPositionRemoved(instanceIndex, positionId) {
    let state = this._getState(instanceIndex);
    let position = state.positions.find(p => p.id === positionId);
    if (!position) {
      for (let e of (0, _entries2.default)(state.removedPositions)) {
        if (e[1] + 5 * 60 * 1000 < Date.now()) {
          delete state.removedPositions[e[0]];
        }
      }
      state.removedPositions[positionId] = Date.now();
    } else {
      state.positions = state.positions.filter(p => p.id !== positionId);
    }
  }

  /**
   * Invoked when the orders are replaced as a result of initial terminal state synchronization
   * @param {String} instanceIndex index of an account instance connected
   * @param {Array<MetatraderOrder>} orders updated array of orders
   * @return {Promise} promise which resolves when the asynchronous event is processed
   */
  onOrdersReplaced(instanceIndex, orders) {
    let state = this._getState(instanceIndex);
    state.orders = orders;
    state.completedOrders = {};
    state.ordersInitialized = true;
    state.initializationCounter = 3;
  }

  /**
   * Invoked when MetaTrader order is updated
   * @param {String} instanceIndex index of an account instance connected
   * @param {MetatraderOrder} order updated MetaTrader order
   */
  onOrderUpdated(instanceIndex, order) {
    let state = this._getState(instanceIndex);
    let index = state.orders.findIndex(o => o.id === order.id);
    if (index !== -1) {
      state.orders[index] = order;
    } else if (!state.completedOrders[order.id]) {
      state.orders.push(order);
    }
  }

  /**
   * Invoked when MetaTrader order is completed (executed or canceled)
   * @param {String} instanceIndex index of an account instance connected
   * @param {String} orderId completed MetaTrader order id
   */
  onOrderCompleted(instanceIndex, orderId) {
    let state = this._getState(instanceIndex);
    let order = state.orders.find(o => o.id === orderId);
    if (!order) {
      for (let e of (0, _entries2.default)(state.completedOrders)) {
        if (e[1] + 5 * 60 * 1000 < Date.now()) {
          delete state.completedOrders[e[0]];
        }
      }
      state.completedOrders[orderId] = Date.now();
    } else {
      state.orders = state.orders.filter(o => o.id !== orderId);
    }
  }

  /**
   * Invoked when a symbol specification was updated
   * @param {String} instanceIndex index of account instance connected
   * @param {Array<MetatraderSymbolSpecification>} specifications updated specifications
   * @param {Array<String>} removedSymbols removed symbols
   */
  onSymbolSpecificationsUpdated(instanceIndex, specifications, removedSymbols) {
    let state = this._getState(instanceIndex);
    for (let specification of specifications) {
      let index = state.specifications.findIndex(s => s.symbol === specification.symbol);
      if (index !== -1) {
        state.specifications[index] = specification;
      } else {
        state.specifications.push(specification);
      }
      state.specificationsBySymbol[specification.symbol] = specification;
    }
    state.specifications = state.specifications.filter(s => !removedSymbols.includes(s.symbol));
    for (let symbol of removedSymbols) {
      delete state.specificationsBySymbol[symbol];
    }
    state.specificationCount = (0, _keys2.default)(state.specifications).length;
  }

  /**
   * Invoked when prices for several symbols were updated
   * @param {String} instanceIndex index of an account instance connected
   * @param {Array<MetatraderSymbolPrice>} prices updated MetaTrader symbol prices
   * @param {Number} equity account liquidation value
   * @param {Number} margin margin used
   * @param {Number} freeMargin free margin
   * @param {Number} marginLevel margin level calculated as % of equity/margin
   */
  // eslint-disable-next-line complexity
  onSymbolPricesUpdated(instanceIndex, prices, equity, margin, freeMargin, marginLevel) {
    let state = this._getState(instanceIndex);
    state.lastUpdateTime = Math.max(prices.map(p => p.time.getTime()));
    let pricesInitialized = false;
    for (let price of prices || []) {
      state.pricesBySymbol[price.symbol] = price;
      let positions = state.positions.filter(p => p.symbol === price.symbol);
      let otherPositions = state.positions.filter(p => p.symbol !== price.symbol);
      let orders = state.orders.filter(o => o.symbol === price.symbol);
      pricesInitialized = true;
      for (let position of otherPositions) {
        let p = state.pricesBySymbol[position.symbol];
        if (p) {
          if (position.unrealizedProfit === undefined) {
            this._updatePositionProfits(position, p);
          }
        } else {
          pricesInitialized = false;
        }
      }
      for (let position of positions) {
        this._updatePositionProfits(position, price);
      }
      for (let order of orders) {
        order.currentPrice = order.type === 'ORDER_TYPE_BUY' || order.type === 'ORDER_TYPE_BUY_LIMIT' || order.type === 'ORDER_TYPE_BUY_STOP' || order.type === 'ORDER_TYPE_BUY_STOP_LIMIT' ? price.ask : price.bid;
      }
      let priceResolves = this._waitForPriceResolves[price.symbol] || [];
      if (priceResolves.length) {
        for (let resolve of priceResolves) {
          resolve();
        }
        delete this._waitForPriceResolves[price.symbol];
      }
    }
    if (state.accountInformation) {
      if (state.positionsInitialized && pricesInitialized) {
        if (state.accountInformation.platform === 'mt5') {
          state.accountInformation.equity = equity !== undefined ? equity : state.accountInformation.balance + state.positions.reduce((acc, p) => acc + Math.round((p.unrealizedProfit || 0) * 100) / 100 + Math.round((p.swap || 0) * 100) / 100, 0);
        } else {
          state.accountInformation.equity = equity !== undefined ? equity : state.accountInformation.balance + state.positions.reduce((acc, p) => acc + Math.round((p.swap || 0) * 100) / 100 + Math.round((p.commission || 0) * 100) / 100 + Math.round((p.unrealizedProfit || 0) * 100) / 100, 0);
        }
        state.accountInformation.equity = Math.round(state.accountInformation.equity * 100) / 100;
      } else {
        state.accountInformation.equity = equity !== undefined ? equity : state.accountInformation.equity;
      }
      state.accountInformation.margin = margin !== undefined ? margin : state.accountInformation.margin;
      state.accountInformation.freeMargin = freeMargin !== undefined ? freeMargin : state.accountInformation.freeMargin;
      state.accountInformation.marginLevel = freeMargin !== undefined ? marginLevel : state.accountInformation.marginLevel;
    }
  }

  /**
   * Invoked when a stream for an instance index is closed
   * @param {String} instanceIndex index of an account instance connected
   * @return {Promise} promise which resolves when the asynchronous event is processed
   */
  async onStreamClosed(instanceIndex) {
    delete this._stateByInstanceIndex[instanceIndex];
  }

  // eslint-disable-next-line complexity
  _updatePositionProfits(position, price) {
    let specification = this.specification(position.symbol);
    if (specification) {
      let multiplier = Math.pow(10, specification.digits);
      if (position.profit !== undefined) {
        position.profit = Math.round(position.profit * multiplier) / multiplier;
      }
      if (position.unrealizedProfit === undefined || position.realizedProfit === undefined) {
        position.unrealizedProfit = (position.type === 'POSITION_TYPE_BUY' ? 1 : -1) * (position.currentPrice - position.openPrice) * position.currentTickValue * position.volume / specification.tickSize;
        position.unrealizedProfit = Math.round(position.unrealizedProfit * multiplier) / multiplier;
        position.realizedProfit = position.profit - position.unrealizedProfit;
      }
      let newPositionPrice = position.type === 'POSITION_TYPE_BUY' ? price.bid : price.ask;
      let isProfitable = (position.type === 'POSITION_TYPE_BUY' ? 1 : -1) * (newPositionPrice - position.openPrice);
      let currentTickValue = isProfitable > 0 ? price.profitTickValue : price.lossTickValue;
      let unrealizedProfit = (position.type === 'POSITION_TYPE_BUY' ? 1 : -1) * (newPositionPrice - position.openPrice) * currentTickValue * position.volume / specification.tickSize;
      unrealizedProfit = Math.round(unrealizedProfit * multiplier) / multiplier;
      position.unrealizedProfit = unrealizedProfit;
      position.profit = position.unrealizedProfit + position.realizedProfit;
      position.profit = Math.round(position.profit * multiplier) / multiplier;
      position.currentPrice = newPositionPrice;
      position.currentTickValue = currentTickValue;
    }
  }

  _getState(instanceIndex) {
    if (!this._stateByInstanceIndex['' + instanceIndex]) {
      this._stateByInstanceIndex['' + instanceIndex] = this._constructTerminalState(instanceIndex);
    }
    return this._stateByInstanceIndex['' + instanceIndex];
  }

  _constructTerminalState(instanceIndex) {
    return {
      instanceIndex,
      connected: false,
      connectedToBroker: false,
      accountInformation: undefined,
      positions: [],
      orders: [],
      specifications: [],
      specificationsBySymbol: {},
      pricesBySymbol: {},
      completedOrders: {},
      removedPositions: {},
      ordersInitialized: false,
      positionsInitialized: false,
      lastUpdateTime: 0,
      initializationCounter: 0,
      specificationCount: 0
    };
  }

  // eslint-disable-next-line complexity
  _getBestState(symbol, mode = 'default') {
    let result;
    let maxUpdateTime = -1;
    let maxInitializationCounter = -1;
    let maxSpecificationCount = -1;
    for (let state of (0, _values2.default)(this._stateByInstanceIndex)) {
      if (maxInitializationCounter < state.initializationCounter || maxInitializationCounter === state.initializationCounter && maxInitializationCounter === 3 && maxUpdateTime < state.lastUpdateTime || maxInitializationCounter === state.initializationCounter && maxInitializationCounter === 0 && maxSpecificationCount < state.specificationCount) {
        if (!symbol || mode === 'specification' && state.specificationsBySymbol[symbol] || mode === 'price' && state.pricesBySymbol[symbol]) {
          maxUpdateTime = state.lastUpdateTime;
          maxInitializationCounter = state.initializationCounter;
          maxSpecificationCount = state.specificationCount;
          result = state;
        }
      }
    }
    return result || this._constructTerminalState();
  }

}
exports.default = TerminalState;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL3Rlcm1pbmFsU3RhdGUuZXM2Il0sIm5hbWVzIjpbIlRlcm1pbmFsU3RhdGUiLCJTeW5jaHJvbml6YXRpb25MaXN0ZW5lciIsImNvbnN0cnVjdG9yIiwiX3N0YXRlQnlJbnN0YW5jZUluZGV4IiwiX3dhaXRGb3JQcmljZVJlc29sdmVzIiwiY29ubmVjdGVkIiwicmVkdWNlIiwiYWNjIiwicyIsImNvbm5lY3RlZFRvQnJva2VyIiwiYWNjb3VudEluZm9ybWF0aW9uIiwiX2dldEJlc3RTdGF0ZSIsInBvc2l0aW9ucyIsIm9yZGVycyIsInNwZWNpZmljYXRpb25zIiwic3BlY2lmaWNhdGlvbiIsInN5bWJvbCIsInNwZWNpZmljYXRpb25zQnlTeW1ib2wiLCJwcmljZSIsInByaWNlc0J5U3ltYm9sIiwid2FpdEZvclByaWNlIiwidGltZW91dEluU2Vjb25kcyIsInJhY2UiLCJyZXMiLCJwdXNoIiwic2V0VGltZW91dCIsIm9uQ29ubmVjdGVkIiwiaW5zdGFuY2VJbmRleCIsIl9nZXRTdGF0ZSIsIm9uRGlzY29ubmVjdGVkIiwic3RhdGUiLCJvbkJyb2tlckNvbm5lY3Rpb25TdGF0dXNDaGFuZ2VkIiwib25TeW5jaHJvbml6YXRpb25TdGFydGVkIiwidW5kZWZpbmVkIiwiY29tcGxldGVkT3JkZXJzIiwicmVtb3ZlZFBvc2l0aW9ucyIsIm9yZGVyc0luaXRpYWxpemVkIiwicG9zaXRpb25zSW5pdGlhbGl6ZWQiLCJvbkFjY291bnRJbmZvcm1hdGlvblVwZGF0ZWQiLCJpbml0aWFsaXphdGlvbkNvdW50ZXIiLCJvblBvc2l0aW9uc1JlcGxhY2VkIiwib25Qb3NpdGlvblVwZGF0ZWQiLCJwb3NpdGlvbiIsImluZGV4IiwiZmluZEluZGV4IiwicCIsImlkIiwib25Qb3NpdGlvblJlbW92ZWQiLCJwb3NpdGlvbklkIiwiZmluZCIsImUiLCJEYXRlIiwibm93IiwiZmlsdGVyIiwib25PcmRlcnNSZXBsYWNlZCIsIm9uT3JkZXJVcGRhdGVkIiwib3JkZXIiLCJvIiwib25PcmRlckNvbXBsZXRlZCIsIm9yZGVySWQiLCJvblN5bWJvbFNwZWNpZmljYXRpb25zVXBkYXRlZCIsInJlbW92ZWRTeW1ib2xzIiwiaW5jbHVkZXMiLCJzcGVjaWZpY2F0aW9uQ291bnQiLCJsZW5ndGgiLCJvblN5bWJvbFByaWNlc1VwZGF0ZWQiLCJwcmljZXMiLCJlcXVpdHkiLCJtYXJnaW4iLCJmcmVlTWFyZ2luIiwibWFyZ2luTGV2ZWwiLCJsYXN0VXBkYXRlVGltZSIsIk1hdGgiLCJtYXgiLCJtYXAiLCJ0aW1lIiwiZ2V0VGltZSIsInByaWNlc0luaXRpYWxpemVkIiwib3RoZXJQb3NpdGlvbnMiLCJ1bnJlYWxpemVkUHJvZml0IiwiX3VwZGF0ZVBvc2l0aW9uUHJvZml0cyIsImN1cnJlbnRQcmljZSIsInR5cGUiLCJhc2siLCJiaWQiLCJwcmljZVJlc29sdmVzIiwicmVzb2x2ZSIsInBsYXRmb3JtIiwiYmFsYW5jZSIsInJvdW5kIiwic3dhcCIsImNvbW1pc3Npb24iLCJvblN0cmVhbUNsb3NlZCIsIm11bHRpcGxpZXIiLCJwb3ciLCJkaWdpdHMiLCJwcm9maXQiLCJyZWFsaXplZFByb2ZpdCIsIm9wZW5QcmljZSIsImN1cnJlbnRUaWNrVmFsdWUiLCJ2b2x1bWUiLCJ0aWNrU2l6ZSIsIm5ld1Bvc2l0aW9uUHJpY2UiLCJpc1Byb2ZpdGFibGUiLCJwcm9maXRUaWNrVmFsdWUiLCJsb3NzVGlja1ZhbHVlIiwiX2NvbnN0cnVjdFRlcm1pbmFsU3RhdGUiLCJtb2RlIiwicmVzdWx0IiwibWF4VXBkYXRlVGltZSIsIm1heEluaXRpYWxpemF0aW9uQ291bnRlciIsIm1heFNwZWNpZmljYXRpb25Db3VudCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7Ozs7O0FBRUE7OztBQUdlLE1BQU1BLGFBQU4sU0FBNEJDLGlDQUE1QixDQUFvRDs7QUFFakU7OztBQUdBQyxnQkFBYztBQUNaO0FBQ0EsU0FBS0MscUJBQUwsR0FBNkIsRUFBN0I7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QUFZMkYsU0FBUyxlQUFULElBQTRCN0UsTUFBTWIsc0JBQU4sQ0FBNkJELE1BQTdCLENBQXhDLElBQ0QyRixTQUFTLE9BQVQsSUFBb0I3RSxNQUFNWCxjQUFOLENBQXFCSCxNQUFyQixDQUR2QixFQUNzRDtBQUNwRDZGLDBCQUFnQi9FLE1BQU15QyxjQUF0QjtBQUNBdUMscUNBQTJCaEYsTUFBTVMscUJBQWpDO0FBQ0F3RSxrQ0FBd0JqRixNQUFNaUMsa0JBQTlCO0FBQ0E2QyxtQkFBUzlFLEtBQVQ7QUFDRDtBQUNGO0FBQ0Y7QUFDRCxXQUFPOEUsVUFBVSxLQUFLRix1QkFBTCxFQUFqQjtBQUNEOztBQWhiZ0U7a0JBQTlDMUcsYSIsImZpbGUiOiJ0ZXJtaW5hbFN0YXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgU3luY2hyb25pemF0aW9uTGlzdGVuZXIgZnJvbSAnLi4vY2xpZW50cy9tZXRhQXBpL3N5bmNocm9uaXphdGlvbkxpc3RlbmVyJztcblxuLyoqXG4gKiBSZXNwb25zaWJsZSBmb3Igc3RvcmluZyBhIGxvY2FsIGNvcHkgb2YgcmVtb3RlIHRlcm1pbmFsIHN0YXRlXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRlcm1pbmFsU3RhdGUgZXh0ZW5kcyBTeW5jaHJvbml6YXRpb25MaXN0ZW5lciB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgdGhlIGluc3RhbmNlIG9mIHRlcm1pbmFsIHN0YXRlIGNsYXNzXG4gICAqL1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3N0YXRlQnlJbnN0YW5jZUluZGV4ID0ge307XG4gICAgdGhpcy5fd2FpdEZvclByaWNlUmVzb2x2ZXMgPSB7fTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRydWUgaWYgTWV0YUFwaSBoYXZlIGNvbm5lY3RlZCB0byBNZXRhVHJhZGVyIHRlcm1pbmFsXG4gICAqIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgTWV0YUFwaSBoYXZlIGNvbm5lY3RlZCB0byBNZXRhVHJhZGVyIHRlcm1pbmFsXG4gICAqL1xuICBnZXQgY29ubmVjdGVkKCkge1xuICAgIHJldHVybiBPYmplY3QudmFsdWVzKHRoaXMuX3N0YXRlQnlJbnN0YW5jZUluZGV4KS5yZWR1Y2UoKGFjYywgcykgPT4gYWNjIHx8IHMuY29ubmVjdGVkLCBmYWxzZSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0cnVlIGlmIE1ldGFBcGkgaGF2ZSBjb25uZWN0ZWQgdG8gTWV0YVRyYWRlciB0ZXJtaW5hbCBhbmQgTWV0YVRyYWRlciB0ZXJtaW5hbCBpcyBjb25uZWN0ZWQgdG8gYnJva2VyXG4gICAqIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgTWV0YUFwaSBoYXZlIGNvbm5lY3RlZCB0byBNZXRhVHJhZGVyIHRlcm1pbmFsIGFuZCBNZXRhVHJhZGVyIHRlcm1pbmFsIGlzIGNvbm5lY3RlZCB0b1xuICAgKiBicm9rZXJcbiAgICovXG4gIGdldCBjb25uZWN0ZWRUb0Jyb2tlcigpIHtcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLl9zdGF0ZUJ5SW5zdGFuY2VJbmRleCkucmVkdWNlKChhY2MsIHMpID0+IGFjYyB8fCBzLmNvbm5lY3RlZFRvQnJva2VyLCBmYWxzZSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIGxvY2FsIGNvcHkgb2YgYWNjb3VudCBpbmZvcm1hdGlvblxuICAgKiBAcmV0dXJucyB7TWV0YXRyYWRlckFjY291bnRJbmZvcm1hdGlvbn0gbG9jYWwgY29weSBvZiBhY2NvdW50IGluZm9ybWF0aW9uXG4gICAqL1xuICBnZXQgYWNjb3VudEluZm9ybWF0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9nZXRCZXN0U3RhdGUoKS5hY2NvdW50SW5mb3JtYXRpb247XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIGxvY2FsIGNvcHkgb2YgTWV0YVRyYWRlciBwb3NpdGlvbnMgb3BlbmVkXG4gICAqIEByZXR1cm5zIHtBcnJheTxNZXRhdHJhZGVyUG9zaXRpb24+fSBhIGxvY2FsIGNvcHkgb2YgTWV0YVRyYWRlciBwb3NpdGlvbnMgb3BlbmVkXG4gICAqL1xuICBnZXQgcG9zaXRpb25zKCkge1xuICAgIHJldHVybiB0aGlzLl9nZXRCZXN0U3RhdGUoKS5wb3NpdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIGxvY2FsIGNvcHkgb2YgTWV0YVRyYWRlciBvcmRlcnMgb3BlbmVkXG4gICAqIEByZXR1cm5zIHtBcnJheTxNZXRhdHJhZGVyT3JkZXI+fSBhIGxvY2FsIGNvcHkgb2YgTWV0YVRyYWRlciBvcmRlcnMgb3BlbmVkXG4gICAqL1xuICBnZXQgb3JkZXJzKCkge1xuICAgIHJldHVybiB0aGlzLl9nZXRCZXN0U3RhdGUoKS5vcmRlcnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIGxvY2FsIGNvcHkgb2Ygc3ltYm9sIHNwZWNpZmljYXRpb25zIGF2YWlsYWJsZSBpbiBNZXRhVHJhZGVyIHRyYWRpbmcgdGVybWluYWxcbiAgICogQHJldHVybnMge0FycmF5PE1ldGF0cmFkZXJTeW1ib2xTcGVjaWZpY2F0aW9uPn0gYSBsb2NhbCBjb3B5IG9mIHN5bWJvbCBzcGVjaWZpY2F0aW9ucyBhdmFpbGFibGUgaW4gTWV0YVRyYWRlclxuICAgKiB0cmFkaW5nIHRlcm1pbmFsXG4gICAqL1xuICBnZXQgc3BlY2lmaWNhdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dldEJlc3RTdGF0ZSgpLnNwZWNpZmljYXRpb25zO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgTWV0YVRyYWRlciBzeW1ib2wgc3BlY2lmaWNhdGlvbiBieSBzeW1ib2xcbiAgICogQHBhcmFtIHtTdHJpbmd9IHN5bWJvbCBzeW1ib2wgKGUuZy4gY3VycmVuY3kgcGFpciBvciBhbiBpbmRleClcbiAgICogQHJldHVybiB7TWV0YXRyYWRlclN5bWJvbFNwZWNpZmljYXRpb259IE1ldGF0cmFkZXJTeW1ib2xTcGVjaWZpY2F0aW9uIGZvdW5kIG9yIHVuZGVmaW5lZCBpZiBzcGVjaWZpY2F0aW9uIGZvciBhXG4gICAqIHN5bWJvbCBpcyBub3QgZm91bmRcbiAgICovXG4gIHNwZWNpZmljYXRpb24oc3ltYm9sKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dldEJlc3RTdGF0ZShzeW1ib2wsICdzcGVjaWZpY2F0aW9uJykuc3BlY2lmaWNhdGlvbnNCeVN5bWJvbFtzeW1ib2xdO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgTWV0YVRyYWRlciBzeW1ib2wgcHJpY2UgYnkgc3ltYm9sXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBzeW1ib2wgc3ltYm9sIChlLmcuIGN1cnJlbmN5IHBhaXIgb3IgYW4gaW5kZXgpXG4gICAqIEByZXR1cm4ge01ldGF0cmFkZXJTeW1ib2xQcmljZX0gTWV0YXRyYWRlclN5bWJvbFByaWNlIGZvdW5kIG9yIHVuZGVmaW5lZCBpZiBwcmljZSBmb3IgYSBzeW1ib2wgaXMgbm90IGZvdW5kXG4gICAqL1xuICBwcmljZShzeW1ib2wpIHtcbiAgICByZXR1cm4gdGhpcy5fZ2V0QmVzdFN0YXRlKHN5bWJvbCwgJ3ByaWNlJykucHJpY2VzQnlTeW1ib2xbc3ltYm9sXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXYWl0cyBmb3IgcHJpY2UgdG8gYmUgcmVjZWl2ZWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN5bWJvbCBzeW1ib2wgKGUuZy4gY3VycmVuY3kgcGFpciBvciBhbiBpbmRleClcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0SW5TZWNvbmRzXSB0aW1lb3V0IGluIHNlY29uZHMsIGRlZmF1bHQgaXMgMzBcbiAgICogQHJldHVybiB7UHJvbWlzZTxNZXRhdHJhZGVyU3ltYm9sUHJpY2U+fSBwcm9taXNlIHJlc29sdmluZyB3aXRoIHByaWNlIG9yIHVuZGVmaW5lZCBpZiBwcmljZSBoYXMgbm90IGJlZW4gcmVjZWl2ZWRcbiAgICovXG4gIGFzeW5jIHdhaXRGb3JQcmljZShzeW1ib2wsIHRpbWVvdXRJblNlY29uZHMgPSAzMCkge1xuICAgIHRoaXMuX3dhaXRGb3JQcmljZVJlc29sdmVzW3N5bWJvbF0gPSB0aGlzLl93YWl0Rm9yUHJpY2VSZXNvbHZlc1tzeW1ib2xdIHx8IFtdO1xuICAgIGlmICghdGhpcy5wcmljZShzeW1ib2wpKSB7XG4gICAgICBhd2FpdCBQcm9taXNlLnJhY2UoW1xuICAgICAgICBuZXcgUHJvbWlzZShyZXMgPT4gdGhpcy5fd2FpdEZvclByaWNlUmVzb2x2ZXNbc3ltYm9sXS5wdXNoKHJlcykpLFxuICAgICAgICBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIHRpbWVvdXRJblNlY29uZHMgKiAxMDAwKSlcbiAgICAgIF0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcmljZShzeW1ib2wpO1xuICB9XG5cbiAgLyoqXG4gICAqIEludm9rZWQgd2hlbiBjb25uZWN0aW9uIHRvIE1ldGFUcmFkZXIgdGVybWluYWwgZXN0YWJsaXNoZWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlSW5kZXggaW5kZXggb2YgYW4gYWNjb3VudCBpbnN0YW5jZSBjb25uZWN0ZWRcbiAgICovXG4gIG9uQ29ubmVjdGVkKGluc3RhbmNlSW5kZXgpIHtcbiAgICB0aGlzLl9nZXRTdGF0ZShpbnN0YW5jZUluZGV4KS5jb25uZWN0ZWQgPSB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEludm9rZWQgd2hlbiBjb25uZWN0aW9uIHRvIE1ldGFUcmFkZXIgdGVybWluYWwgdGVybWluYXRlZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJbmRleCBpbmRleCBvZiBhbiBhY2NvdW50IGluc3RhbmNlIGNvbm5lY3RlZFxuICAgKi9cbiAgb25EaXNjb25uZWN0ZWQoaW5zdGFuY2VJbmRleCkge1xuICAgIGxldCBzdGF0ZSA9IHRoaXMuX2dldFN0YXRlKGluc3RhbmNlSW5kZXgpO1xuICAgIHN0YXRlLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgIHN0YXRlLmNvbm5lY3RlZFRvQnJva2VyID0gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGJyb2tlciBjb25uZWN0aW9uIHN0YXR1cyBoYXZlIGNoYW5nZWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlSW5kZXggaW5kZXggb2YgYW4gYWNjb3VudCBpbnN0YW5jZSBjb25uZWN0ZWRcbiAgICogQHBhcmFtIHtCb29sZWFufSBjb25uZWN0ZWQgaXMgTWV0YVRyYWRlciB0ZXJtaW5hbCBpcyBjb25uZWN0ZWQgdG8gYnJva2VyXG4gICAqL1xuICBvbkJyb2tlckNvbm5lY3Rpb25TdGF0dXNDaGFuZ2VkKGluc3RhbmNlSW5kZXgsIGNvbm5lY3RlZCkge1xuICAgIHRoaXMuX2dldFN0YXRlKGluc3RhbmNlSW5kZXgpLmNvbm5lY3RlZFRvQnJva2VyID0gY29ubmVjdGVkO1xuICB9XG5cbiAgLyoqXG4gICAqIEludm9rZWQgd2hlbiBNZXRhVHJhZGVyIHRlcm1pbmFsIHN0YXRlIHN5bmNocm9uaXphdGlvbiBpcyBzdGFydGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZUluZGV4IGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2Ugd2hpY2ggcmVzb2x2ZXMgd2hlbiB0aGUgYXN5bmNocm9ub3VzIGV2ZW50IGlzIHByb2Nlc3NlZFxuICAgKi9cbiAgb25TeW5jaHJvbml6YXRpb25TdGFydGVkKGluc3RhbmNlSW5kZXgpIHtcbiAgICBsZXQgc3RhdGUgPSB0aGlzLl9nZXRTdGF0ZShpbnN0YW5jZUluZGV4KTtcbiAgICBzdGF0ZS5hY2NvdW50SW5mb3JtYXRpb24gPSB1bmRlZmluZWQ7XG4gICAgc3RhdGUucG9zaXRpb25zID0gW107XG4gICAgc3RhdGUub3JkZXJzID0gW107XG4gICAgc3RhdGUuc3BlY2lmaWNhdGlvbnMgPSBbXTtcbiAgICBzdGF0ZS5zcGVjaWZpY2F0aW9uc0J5U3ltYm9sID0ge307XG4gICAgc3RhdGUucHJpY2VzQnlTeW1ib2wgPSB7fTtcbiAgICBzdGF0ZS5jb21wbGV0ZWRPcmRlcnMgPSB7fTtcbiAgICBzdGF0ZS5yZW1vdmVkUG9zaXRpb25zID0ge307XG4gICAgc3RhdGUub3JkZXJzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICBzdGF0ZS5wb3NpdGlvbnNJbml0aWFsaXplZCA9IGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIEludm9rZWQgd2hlbiBNZXRhVHJhZGVyIGFjY291bnQgaW5mb3JtYXRpb24gaXMgdXBkYXRlZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJbmRleCBpbmRleCBvZiBhbiBhY2NvdW50IGluc3RhbmNlIGNvbm5lY3RlZFxuICAgKiBAcGFyYW0ge01ldGF0cmFkZXJBY2NvdW50SW5mb3JtYXRpb259IGFjY291bnRJbmZvcm1hdGlvbiB1cGRhdGVkIE1ldGFUcmFkZXIgYWNjb3VudCBpbmZvcm1hdGlvblxuICAgKi9cbiAgb25BY2NvdW50SW5mb3JtYXRpb25VcGRhdGVkKGluc3RhbmNlSW5kZXgsIGFjY291bnRJbmZvcm1hdGlvbikge1xuICAgIGxldCBzdGF0ZSA9IHRoaXMuX2dldFN0YXRlKGluc3RhbmNlSW5kZXgpO1xuICAgIHN0YXRlLmFjY291bnRJbmZvcm1hdGlvbiA9IGFjY291bnRJbmZvcm1hdGlvbjtcbiAgICBzdGF0ZS5pbml0aWFsaXphdGlvbkNvdW50ZXIgPSAxO1xuICB9XG5cbiAgLyoqXG4gICAqIEludm9rZWQgd2hlbiB0aGUgcG9zaXRpb25zIGFyZSByZXBsYWNlZCBhcyBhIHJlc3VsdCBvZiBpbml0aWFsIHRlcm1pbmFsIHN0YXRlIHN5bmNocm9uaXphdGlvblxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJbmRleCBpbmRleCBvZiBhbiBhY2NvdW50IGluc3RhbmNlIGNvbm5lY3RlZFxuICAgKiBAcGFyYW0ge0FycmF5PE1ldGF0cmFkZXJQb3NpdGlvbj59IHBvc2l0aW9ucyB1cGRhdGVkIGFycmF5IG9mIHBvc2l0aW9uc1xuICAgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHdoaWNoIHJlc29sdmVzIHdoZW4gdGhlIGFzeW5jaHJvbm91cyBldmVudCBpcyBwcm9jZXNzZWRcbiAgICovXG4gIG9uUG9zaXRpb25zUmVwbGFjZWQoaW5zdGFuY2VJbmRleCwgcG9zaXRpb25zKSB7XG4gICAgbGV0IHN0YXRlID0gdGhpcy5fZ2V0U3RhdGUoaW5zdGFuY2VJbmRleCk7XG4gICAgc3RhdGUucG9zaXRpb25zID0gcG9zaXRpb25zO1xuICAgIHN0YXRlLnJlbW92ZWRQb3NpdGlvbnMgPSB7fTtcbiAgICBzdGF0ZS5wb3NpdGlvbnNJbml0aWFsaXplZCA9IHRydWU7XG4gICAgc3RhdGUuaW5pdGlhbGl6YXRpb25Db3VudGVyID0gMjtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gTWV0YVRyYWRlciBwb3NpdGlvbiBpcyB1cGRhdGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZUluZGV4IGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqIEBwYXJhbSB7TWV0YXRyYWRlclBvc2l0aW9ufSBwb3NpdGlvbiB1cGRhdGVkIE1ldGFUcmFkZXIgcG9zaXRpb25cbiAgICovXG4gIG9uUG9zaXRpb25VcGRhdGVkKGluc3RhbmNlSW5kZXgsIHBvc2l0aW9uKSB7XG4gICAgbGV0IHN0YXRlID0gdGhpcy5fZ2V0U3RhdGUoaW5zdGFuY2VJbmRleCk7XG4gICAgbGV0IGluZGV4ID0gc3RhdGUucG9zaXRpb25zLmZpbmRJbmRleChwID0+IHAuaWQgPT09IHBvc2l0aW9uLmlkKTtcbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICBzdGF0ZS5wb3NpdGlvbnNbaW5kZXhdID0gcG9zaXRpb247XG4gICAgfSBlbHNlIGlmICghc3RhdGUucmVtb3ZlZFBvc2l0aW9uc1twb3NpdGlvbi5pZF0pIHtcbiAgICAgIHN0YXRlLnBvc2l0aW9ucy5wdXNoKHBvc2l0aW9uKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIE1ldGFUcmFkZXIgcG9zaXRpb24gaXMgcmVtb3ZlZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJbmRleCBpbmRleCBvZiBhbiBhY2NvdW50IGluc3RhbmNlIGNvbm5lY3RlZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gcG9zaXRpb25JZCByZW1vdmVkIE1ldGFUcmFkZXIgcG9zaXRpb24gaWRcbiAgICovXG4gIG9uUG9zaXRpb25SZW1vdmVkKGluc3RhbmNlSW5kZXgsIHBvc2l0aW9uSWQpIHtcbiAgICBsZXQgc3RhdGUgPSB0aGlzLl9nZXRTdGF0ZShpbnN0YW5jZUluZGV4KTtcbiAgICBsZXQgcG9zaXRpb24gPSBzdGF0ZS5wb3NpdGlvbnMuZmluZChwID0+IHAuaWQgPT09IHBvc2l0aW9uSWQpO1xuICAgIGlmICghcG9zaXRpb24pIHtcbiAgICAgIGZvciAobGV0IGUgb2YgT2JqZWN0LmVudHJpZXMoc3RhdGUucmVtb3ZlZFBvc2l0aW9ucykpIHtcbiAgICAgICAgaWYgKGVbMV0gKyA1ICogNjAgKiAxMDAwIDwgRGF0ZS5ub3coKSkge1xuICAgICAgICAgIGRlbGV0ZSBzdGF0ZS5yZW1vdmVkUG9zaXRpb25zW2VbMF1dO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBzdGF0ZS5yZW1vdmVkUG9zaXRpb25zW3Bvc2l0aW9uSWRdID0gRGF0ZS5ub3coKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3RhdGUucG9zaXRpb25zID0gc3RhdGUucG9zaXRpb25zLmZpbHRlcihwID0+IHAuaWQgIT09IHBvc2l0aW9uSWQpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gdGhlIG9yZGVycyBhcmUgcmVwbGFjZWQgYXMgYSByZXN1bHQgb2YgaW5pdGlhbCB0ZXJtaW5hbCBzdGF0ZSBzeW5jaHJvbml6YXRpb25cbiAgICogQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlSW5kZXggaW5kZXggb2YgYW4gYWNjb3VudCBpbnN0YW5jZSBjb25uZWN0ZWRcbiAgICogQHBhcmFtIHtBcnJheTxNZXRhdHJhZGVyT3JkZXI+fSBvcmRlcnMgdXBkYXRlZCBhcnJheSBvZiBvcmRlcnNcbiAgICogQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB3aGljaCByZXNvbHZlcyB3aGVuIHRoZSBhc3luY2hyb25vdXMgZXZlbnQgaXMgcHJvY2Vzc2VkXG4gICAqL1xuICBvbk9yZGVyc1JlcGxhY2VkKGluc3RhbmNlSW5kZXgsIG9yZGVycykge1xuICAgIGxldCBzdGF0ZSA9IHRoaXMuX2dldFN0YXRlKGluc3RhbmNlSW5kZXgpO1xuICAgIHN0YXRlLm9yZGVycyA9IG9yZGVycztcbiAgICBzdGF0ZS5jb21wbGV0ZWRPcmRlcnMgPSB7fTtcbiAgICBzdGF0ZS5vcmRlcnNJbml0aWFsaXplZCA9IHRydWU7XG4gICAgc3RhdGUuaW5pdGlhbGl6YXRpb25Db3VudGVyID0gMztcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gTWV0YVRyYWRlciBvcmRlciBpcyB1cGRhdGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZUluZGV4IGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqIEBwYXJhbSB7TWV0YXRyYWRlck9yZGVyfSBvcmRlciB1cGRhdGVkIE1ldGFUcmFkZXIgb3JkZXJcbiAgICovXG4gIG9uT3JkZXJVcGRhdGVkKGluc3RhbmNlSW5kZXgsIG9yZGVyKSB7XG4gICAgbGV0IHN0YXRlID0gdGhpcy5fZ2V0U3RhdGUoaW5zdGFuY2VJbmRleCk7XG4gICAgbGV0IGluZGV4ID0gc3RhdGUub3JkZXJzLmZpbmRJbmRleChvID0+IG8uaWQgPT09IG9yZGVyLmlkKTtcbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICBzdGF0ZS5vcmRlcnNbaW5kZXhdID0gb3JkZXI7XG4gICAgfSBlbHNlIGlmICghc3RhdGUuY29tcGxldGVkT3JkZXJzW29yZGVyLmlkXSkge1xuICAgICAgc3RhdGUub3JkZXJzLnB1c2gob3JkZXIpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gTWV0YVRyYWRlciBvcmRlciBpcyBjb21wbGV0ZWQgKGV4ZWN1dGVkIG9yIGNhbmNlbGVkKVxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJbmRleCBpbmRleCBvZiBhbiBhY2NvdW50IGluc3RhbmNlIGNvbm5lY3RlZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gb3JkZXJJZCBjb21wbGV0ZWQgTWV0YVRyYWRlciBvcmRlciBpZFxuICAgKi9cbiAgb25PcmRlckNvbXBsZXRlZChpbnN0YW5jZUluZGV4LCBvcmRlcklkKSB7XG4gICAgbGV0IHN0YXRlID0gdGhpcy5fZ2V0U3RhdGUoaW5zdGFuY2VJbmRleCk7XG4gICAgbGV0IG9yZGVyID0gc3RhdGUub3JkZXJzLmZpbmQobyA9PiBvLmlkID09PSBvcmRlcklkKTtcbiAgICBpZiAoIW9yZGVyKSB7XG4gICAgICBmb3IgKGxldCBlIG9mIE9iamVjdC5lbnRyaWVzKHN0YXRlLmNvbXBsZXRlZE9yZGVycykpIHtcbiAgICAgICAgaWYgKGVbMV0gKyA1ICogNjAgKiAxMDAwIDwgRGF0ZS5ub3coKSkge1xuICAgICAgICAgIGRlbGV0ZSBzdGF0ZS5jb21wbGV0ZWRPcmRlcnNbZVswXV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHN0YXRlLmNvbXBsZXRlZE9yZGVyc1tvcmRlcklkXSA9IERhdGUubm93KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXRlLm9yZGVycyA9IHN0YXRlLm9yZGVycy5maWx0ZXIobyA9PiBvLmlkICE9PSBvcmRlcklkKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGEgc3ltYm9sIHNwZWNpZmljYXRpb24gd2FzIHVwZGF0ZWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlSW5kZXggaW5kZXggb2YgYWNjb3VudCBpbnN0YW5jZSBjb25uZWN0ZWRcbiAgICogQHBhcmFtIHtBcnJheTxNZXRhdHJhZGVyU3ltYm9sU3BlY2lmaWNhdGlvbj59IHNwZWNpZmljYXRpb25zIHVwZGF0ZWQgc3BlY2lmaWNhdGlvbnNcbiAgICogQHBhcmFtIHtBcnJheTxTdHJpbmc+fSByZW1vdmVkU3ltYm9scyByZW1vdmVkIHN5bWJvbHNcbiAgICovXG4gIG9uU3ltYm9sU3BlY2lmaWNhdGlvbnNVcGRhdGVkKGluc3RhbmNlSW5kZXgsIHNwZWNpZmljYXRpb25zLCByZW1vdmVkU3ltYm9scykge1xuICAgIGxldCBzdGF0ZSA9IHRoaXMuX2dldFN0YXRlKGluc3RhbmNlSW5kZXgpO1xuICAgIGZvciAobGV0IHNwZWNpZmljYXRpb24gb2Ygc3BlY2lmaWNhdGlvbnMpIHtcbiAgICAgIGxldCBpbmRleCA9IHN0YXRlLnNwZWNpZmljYXRpb25zLmZpbmRJbmRleChzID0+IHMuc3ltYm9sID09PSBzcGVjaWZpY2F0aW9uLnN5bWJvbCk7XG4gICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgIHN0YXRlLnNwZWNpZmljYXRpb25zW2luZGV4XSA9IHNwZWNpZmljYXRpb247XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzdGF0ZS5zcGVjaWZpY2F0aW9ucy5wdXNoKHNwZWNpZmljYXRpb24pO1xuICAgICAgfVxuICAgICAgc3RhdGUuc3BlY2lmaWNhdGlvbnNCeVN5bWJvbFtzcGVjaWZpY2F0aW9uLnN5bWJvbF0gPSBzcGVjaWZpY2F0aW9uO1xuICAgIH1cbiAgICBzdGF0ZS5zcGVjaWZpY2F0aW9ucyA9IHN0YXRlLnNwZWNpZmljYXRpb25zLmZpbHRlcihzID0+ICFyZW1vdmVkU3ltYm9scy5pbmNsdWRlcyhzLnN5bWJvbCkpO1xuICAgIGZvciAobGV0IHN5bWJvbCBvZiByZW1vdmVkU3ltYm9scykge1xuICAgICAgZGVsZXRlIHN0YXRlLnNwZWNpZmljYXRpb25zQnlTeW1ib2xbc3ltYm9sXTtcbiAgICB9XG4gICAgc3RhdGUuc3BlY2lmaWNhdGlvbkNvdW50ID0gT2JqZWN0LmtleXMoc3RhdGUuc3BlY2lmaWNhdGlvbnMpLmxlbmd0aDtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gcHJpY2VzIGZvciBzZXZlcmFsIHN5bWJvbHMgd2VyZSB1cGRhdGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZUluZGV4IGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqIEBwYXJhbSB7QXJyYXk8TWV0YXRyYWRlclN5bWJvbFByaWNlPn0gcHJpY2VzIHVwZGF0ZWQgTWV0YVRyYWRlciBzeW1ib2wgcHJpY2VzXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBlcXVpdHkgYWNjb3VudCBsaXF1aWRhdGlvbiB2YWx1ZVxuICAgKiBAcGFyYW0ge051bWJlcn0gbWFyZ2luIG1hcmdpbiB1c2VkXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBmcmVlTWFyZ2luIGZyZWUgbWFyZ2luXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBtYXJnaW5MZXZlbCBtYXJnaW4gbGV2ZWwgY2FsY3VsYXRlZCBhcyAlIG9mIGVxdWl0eS9tYXJnaW5cbiAgICovXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjb21wbGV4aXR5XG4gIG9uU3ltYm9sUHJpY2VzVXBkYXRlZChpbnN0YW5jZUluZGV4LCBwcmljZXMsIGVxdWl0eSwgbWFyZ2luLCBmcmVlTWFyZ2luLCBtYXJnaW5MZXZlbCkge1xuICAgIGxldCBzdGF0ZSA9IHRoaXMuX2dldFN0YXRlKGluc3RhbmNlSW5kZXgpO1xuICAgIHN0YXRlLmxhc3RVcGRhdGVUaW1lID0gTWF0aC5tYXgocHJpY2VzLm1hcChwID0+IHAudGltZS5nZXRUaW1lKCkpKTtcbiAgICBsZXQgcHJpY2VzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICBmb3IgKGxldCBwcmljZSBvZiBwcmljZXMgfHwgW10pIHtcbiAgICAgIHN0YXRlLnByaWNlc0J5U3ltYm9sW3ByaWNlLnN5bWJvbF0gPSBwcmljZTtcbiAgICAgIGxldCBwb3NpdGlvbnMgPSBzdGF0ZS5wb3NpdGlvbnMuZmlsdGVyKHAgPT4gcC5zeW1ib2wgPT09IHByaWNlLnN5bWJvbCk7XG4gICAgICBsZXQgb3RoZXJQb3NpdGlvbnMgPSBzdGF0ZS5wb3NpdGlvbnMuZmlsdGVyKHAgPT4gcC5zeW1ib2wgIT09IHByaWNlLnN5bWJvbCk7XG4gICAgICBsZXQgb3JkZXJzID0gc3RhdGUub3JkZXJzLmZpbHRlcihvID0+IG8uc3ltYm9sID09PSBwcmljZS5zeW1ib2wpO1xuICAgICAgcHJpY2VzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgZm9yIChsZXQgcG9zaXRpb24gb2Ygb3RoZXJQb3NpdGlvbnMpIHtcbiAgICAgICAgbGV0IHAgPSBzdGF0ZS5wcmljZXNCeVN5bWJvbFtwb3NpdGlvbi5zeW1ib2xdO1xuICAgICAgICBpZiAocCkge1xuICAgICAgICAgIGlmIChwb3NpdGlvbi51bnJlYWxpemVkUHJvZml0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBvc2l0aW9uUHJvZml0cyhwb3NpdGlvbiwgcCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHByaWNlc0luaXRpYWxpemVkID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGZvciAobGV0IHBvc2l0aW9uIG9mIHBvc2l0aW9ucykge1xuICAgICAgICB0aGlzLl91cGRhdGVQb3NpdGlvblByb2ZpdHMocG9zaXRpb24sIHByaWNlKTtcbiAgICAgIH1cbiAgICAgIGZvciAobGV0IG9yZGVyIG9mIG9yZGVycykge1xuICAgICAgICBvcmRlci5jdXJyZW50UHJpY2UgPSBvcmRlci50eXBlID09PSAnT1JERVJfVFlQRV9CVVknIHx8IG9yZGVyLnR5cGUgPT09ICdPUkRFUl9UWVBFX0JVWV9MSU1JVCcgfHxcbiAgICAgICAgICBvcmRlci50eXBlID09PSAnT1JERVJfVFlQRV9CVVlfU1RPUCcgfHwgb3JkZXIudHlwZSA9PT0gJ09SREVSX1RZUEVfQlVZX1NUT1BfTElNSVQnID8gcHJpY2UuYXNrIDogcHJpY2UuYmlkO1xuICAgICAgfVxuICAgICAgbGV0IHByaWNlUmVzb2x2ZXMgPSB0aGlzLl93YWl0Rm9yUHJpY2VSZXNvbHZlc1twcmljZS5zeW1ib2xdIHx8IFtdO1xuICAgICAgaWYgKHByaWNlUmVzb2x2ZXMubGVuZ3RoKSB7XG4gICAgICAgIGZvciAobGV0IHJlc29sdmUgb2YgcHJpY2VSZXNvbHZlcykge1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfVxuICAgICAgICBkZWxldGUgdGhpcy5fd2FpdEZvclByaWNlUmVzb2x2ZXNbcHJpY2Uuc3ltYm9sXTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHN0YXRlLmFjY291bnRJbmZvcm1hdGlvbikge1xuICAgICAgaWYgKHN0YXRlLnBvc2l0aW9uc0luaXRpYWxpemVkICYmIHByaWNlc0luaXRpYWxpemVkKSB7XG4gICAgICAgIGlmIChzdGF0ZS5hY2NvdW50SW5mb3JtYXRpb24ucGxhdGZvcm0gPT09ICdtdDUnKSB7XG4gICAgICAgICAgc3RhdGUuYWNjb3VudEluZm9ybWF0aW9uLmVxdWl0eSA9IGVxdWl0eSAhPT0gdW5kZWZpbmVkID8gZXF1aXR5IDogc3RhdGUuYWNjb3VudEluZm9ybWF0aW9uLmJhbGFuY2UgK1xuICAgICAgICAgICAgc3RhdGUucG9zaXRpb25zLnJlZHVjZSgoYWNjLCBwKSA9PiBhY2MgK1xuICAgICAgICAgICAgICBNYXRoLnJvdW5kKChwLnVucmVhbGl6ZWRQcm9maXQgfHwgMCkgKiAxMDApIC8gMTAwICsgTWF0aC5yb3VuZCgocC5zd2FwIHx8IDApICogMTAwKSAvIDEwMCwgMCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc3RhdGUuYWNjb3VudEluZm9ybWF0aW9uLmVxdWl0eSA9IGVxdWl0eSAhPT0gdW5kZWZpbmVkID8gZXF1aXR5IDogc3RhdGUuYWNjb3VudEluZm9ybWF0aW9uLmJhbGFuY2UgK1xuICAgICAgICAgICAgc3RhdGUucG9zaXRpb25zLnJlZHVjZSgoYWNjLCBwKSA9PiBhY2MgKyBNYXRoLnJvdW5kKChwLnN3YXAgfHwgMCkgKiAxMDApIC8gMTAwICtcbiAgICAgICAgICAgICAgTWF0aC5yb3VuZCgocC5jb21taXNzaW9uIHx8IDApICogMTAwKSAvIDEwMCArIE1hdGgucm91bmQoKHAudW5yZWFsaXplZFByb2ZpdCB8fCAwKSAqIDEwMCkgLyAxMDAsIDApO1xuICAgICAgICB9XG4gICAgICAgIHN0YXRlLmFjY291bnRJbmZvcm1hdGlvbi5lcXVpdHkgPSBNYXRoLnJvdW5kKHN0YXRlLmFjY291bnRJbmZvcm1hdGlvbi5lcXVpdHkgKiAxMDApIC8gMTAwO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3RhdGUuYWNjb3VudEluZm9ybWF0aW9uLmVxdWl0eSA9IGVxdWl0eSAhPT0gdW5kZWZpbmVkID8gZXF1aXR5IDogc3RhdGUuYWNjb3VudEluZm9ybWF0aW9uLmVxdWl0eTtcbiAgICAgIH1cbiAgICAgIHN0YXRlLmFjY291bnRJbmZvcm1hdGlvbi5tYXJnaW4gPSBtYXJnaW4gIT09IHVuZGVmaW5lZCA/IG1hcmdpbiA6IHN0YXRlLmFjY291bnRJbmZvcm1hdGlvbi5tYXJnaW47XG4gICAgICBzdGF0ZS5hY2NvdW50SW5mb3JtYXRpb24uZnJlZU1hcmdpbiA9IGZyZWVNYXJnaW4gIT09IHVuZGVmaW5lZCA/IGZyZWVNYXJnaW4gOiBzdGF0ZS5hY2NvdW50SW5mb3JtYXRpb24uZnJlZU1hcmdpbjtcbiAgICAgIHN0YXRlLmFjY291bnRJbmZvcm1hdGlvbi5tYXJnaW5MZXZlbCA9IGZyZWVNYXJnaW4gIT09IHVuZGVmaW5lZCA/IG1hcmdpbkxldmVsIDpcbiAgICAgICAgc3RhdGUuYWNjb3VudEluZm9ybWF0aW9uLm1hcmdpbkxldmVsO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gYSBzdHJlYW0gZm9yIGFuIGluc3RhbmNlIGluZGV4IGlzIGNsb3NlZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJbmRleCBpbmRleCBvZiBhbiBhY2NvdW50IGluc3RhbmNlIGNvbm5lY3RlZFxuICAgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHdoaWNoIHJlc29sdmVzIHdoZW4gdGhlIGFzeW5jaHJvbm91cyBldmVudCBpcyBwcm9jZXNzZWRcbiAgICovXG4gIGFzeW5jIG9uU3RyZWFtQ2xvc2VkKGluc3RhbmNlSW5kZXgpIHtcbiAgICBkZWxldGUgdGhpcy5fc3RhdGVCeUluc3RhbmNlSW5kZXhbaW5zdGFuY2VJbmRleF07XG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY29tcGxleGl0eVxuICBfdXBkYXRlUG9zaXRpb25Qcm9maXRzKHBvc2l0aW9uLCBwcmljZSkge1xuICAgIGxldCBzcGVjaWZpY2F0aW9uID0gdGhpcy5zcGVjaWZpY2F0aW9uKHBvc2l0aW9uLnN5bWJvbCk7XG4gICAgaWYgKHNwZWNpZmljYXRpb24pIHtcbiAgICAgIGxldCBtdWx0aXBsaWVyID0gTWF0aC5wb3coMTAsIHNwZWNpZmljYXRpb24uZGlnaXRzKTtcbiAgICAgIGlmIChwb3NpdGlvbi5wcm9maXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBwb3NpdGlvbi5wcm9maXQgPSBNYXRoLnJvdW5kKHBvc2l0aW9uLnByb2ZpdCAqIG11bHRpcGxpZXIpIC8gbXVsdGlwbGllcjtcbiAgICAgIH1cbiAgICAgIGlmIChwb3NpdGlvbi51bnJlYWxpemVkUHJvZml0ID09PSB1bmRlZmluZWQgfHwgcG9zaXRpb24ucmVhbGl6ZWRQcm9maXQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBwb3NpdGlvbi51bnJlYWxpemVkUHJvZml0ID0gKHBvc2l0aW9uLnR5cGUgPT09ICdQT1NJVElPTl9UWVBFX0JVWScgPyAxIDogLTEpICpcbiAgICAgICAgICAocG9zaXRpb24uY3VycmVudFByaWNlIC0gcG9zaXRpb24ub3BlblByaWNlKSAqIHBvc2l0aW9uLmN1cnJlbnRUaWNrVmFsdWUgKlxuICAgICAgICAgIHBvc2l0aW9uLnZvbHVtZSAvIHNwZWNpZmljYXRpb24udGlja1NpemU7XG4gICAgICAgIHBvc2l0aW9uLnVucmVhbGl6ZWRQcm9maXQgPSBNYXRoLnJvdW5kKHBvc2l0aW9uLnVucmVhbGl6ZWRQcm9maXQgKiBtdWx0aXBsaWVyKSAvIG11bHRpcGxpZXI7XG4gICAgICAgIHBvc2l0aW9uLnJlYWxpemVkUHJvZml0ID0gcG9zaXRpb24ucHJvZml0IC0gcG9zaXRpb24udW5yZWFsaXplZFByb2ZpdDtcbiAgICAgIH1cbiAgICAgIGxldCBuZXdQb3NpdGlvblByaWNlID0gcG9zaXRpb24udHlwZSA9PT0gJ1BPU0lUSU9OX1RZUEVfQlVZJyA/IHByaWNlLmJpZCA6IHByaWNlLmFzaztcbiAgICAgIGxldCBpc1Byb2ZpdGFibGUgPSAocG9zaXRpb24udHlwZSA9PT0gJ1BPU0lUSU9OX1RZUEVfQlVZJyA/IDEgOiAtMSkgKiAobmV3UG9zaXRpb25QcmljZSAtIHBvc2l0aW9uLm9wZW5QcmljZSk7XG4gICAgICBsZXQgY3VycmVudFRpY2tWYWx1ZSA9IChpc1Byb2ZpdGFibGUgPiAwID8gcHJpY2UucHJvZml0VGlja1ZhbHVlIDogcHJpY2UubG9zc1RpY2tWYWx1ZSk7XG4gICAgICBsZXQgdW5yZWFsaXplZFByb2ZpdCA9IChwb3NpdGlvbi50eXBlID09PSAnUE9TSVRJT05fVFlQRV9CVVknID8gMSA6IC0xKSAqXG4gICAgICAgIChuZXdQb3NpdGlvblByaWNlIC0gcG9zaXRpb24ub3BlblByaWNlKSAqIGN1cnJlbnRUaWNrVmFsdWUgKlxuICAgICAgICBwb3NpdGlvbi52b2x1bWUgLyBzcGVjaWZpY2F0aW9uLnRpY2tTaXplO1xuICAgICAgdW5yZWFsaXplZFByb2ZpdCA9IE1hdGgucm91bmQodW5yZWFsaXplZFByb2ZpdCAqIG11bHRpcGxpZXIpIC8gbXVsdGlwbGllcjtcbiAgICAgIHBvc2l0aW9uLnVucmVhbGl6ZWRQcm9maXQgPSB1bnJlYWxpemVkUHJvZml0O1xuICAgICAgcG9zaXRpb24ucHJvZml0ID0gcG9zaXRpb24udW5yZWFsaXplZFByb2ZpdCArIHBvc2l0aW9uLnJlYWxpemVkUHJvZml0O1xuICAgICAgcG9zaXRpb24ucHJvZml0ID0gTWF0aC5yb3VuZChwb3NpdGlvbi5wcm9maXQgKiBtdWx0aXBsaWVyKSAvIG11bHRpcGxpZXI7XG4gICAgICBwb3NpdGlvbi5jdXJyZW50UHJpY2UgPSBuZXdQb3NpdGlvblByaWNlO1xuICAgICAgcG9zaXRpb24uY3VycmVudFRpY2tWYWx1ZSA9IGN1cnJlbnRUaWNrVmFsdWU7XG4gICAgfVxuICB9XG4gIFxuICBfZ2V0U3RhdGUoaW5zdGFuY2VJbmRleCkge1xuICAgIGlmICghdGhpcy5fc3RhdGVCeUluc3RhbmNlSW5kZXhbJycgKyBpbnN0YW5jZUluZGV4XSkge1xuICAgICAgdGhpcy5fc3RhdGVCeUluc3RhbmNlSW5kZXhbJycgKyBpbnN0YW5jZUluZGV4XSA9IHRoaXMuX2NvbnN0cnVjdFRlcm1pbmFsU3RhdGUoaW5zdGFuY2VJbmRleCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9zdGF0ZUJ5SW5zdGFuY2VJbmRleFsnJyArIGluc3RhbmNlSW5kZXhdO1xuICB9XG5cbiAgX2NvbnN0cnVjdFRlcm1pbmFsU3RhdGUoaW5zdGFuY2VJbmRleCkge1xuICAgIHJldHVybiB7XG4gICAgICBpbnN0YW5jZUluZGV4LFxuICAgICAgY29ubmVjdGVkOiBmYWxzZSxcbiAgICAgIGNvbm5lY3RlZFRvQnJva2VyOiBmYWxzZSxcbiAgICAgIGFjY291bnRJbmZvcm1hdGlvbjogdW5kZWZpbmVkLFxuICAgICAgcG9zaXRpb25zOiBbXSxcbiAgICAgIG9yZGVyczogW10sXG4gICAgICBzcGVjaWZpY2F0aW9uczogW10sXG4gICAgICBzcGVjaWZpY2F0aW9uc0J5U3ltYm9sOiB7fSxcbiAgICAgIHByaWNlc0J5U3ltYm9sOiB7fSxcbiAgICAgIGNvbXBsZXRlZE9yZGVyczoge30sXG4gICAgICByZW1vdmVkUG9zaXRpb25zOiB7fSxcbiAgICAgIG9yZGVyc0luaXRpYWxpemVkOiBmYWxzZSxcbiAgICAgIHBvc2l0aW9uc0luaXRpYWxpemVkOiBmYWxzZSxcbiAgICAgIGxhc3RVcGRhdGVUaW1lOiAwLFxuICAgICAgaW5pdGlhbGl6YXRpb25Db3VudGVyOiAwLFxuICAgICAgc3BlY2lmaWNhdGlvbkNvdW50OiAwXG4gICAgfTtcbiAgfVxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjb21wbGV4aXR5XG4gIF9nZXRCZXN0U3RhdGUoc3ltYm9sLCBtb2RlID0gJ2RlZmF1bHQnKSB7XG4gICAgbGV0IHJlc3VsdDtcbiAgICBsZXQgbWF4VXBkYXRlVGltZSA9IC0xO1xuICAgIGxldCBtYXhJbml0aWFsaXphdGlvbkNvdW50ZXIgPSAtMTtcbiAgICBsZXQgbWF4U3BlY2lmaWNhdGlvbkNvdW50ID0gLTE7XG4gICAgZm9yIChsZXQgc3RhdGUgb2YgT2JqZWN0LnZhbHVlcyh0aGlzLl9zdGF0ZUJ5SW5zdGFuY2VJbmRleCkpIHtcbiAgICAgIGlmIChtYXhJbml0aWFsaXphdGlvbkNvdW50ZXIgPCBzdGF0ZS5pbml0aWFsaXphdGlvbkNvdW50ZXIgfHxcbiAgICAgICAgbWF4SW5pdGlhbGl6YXRpb25Db3VudGVyID09PSBzdGF0ZS5pbml0aWFsaXphdGlvbkNvdW50ZXIgJiYgbWF4SW5pdGlhbGl6YXRpb25Db3VudGVyID09PSAzICYmXG4gICAgICAgIG1heFVwZGF0ZVRpbWUgPCBzdGF0ZS5sYXN0VXBkYXRlVGltZSB8fFxuICAgICAgICBtYXhJbml0aWFsaXphdGlvbkNvdW50ZXIgPT09IHN0YXRlLmluaXRpYWxpemF0aW9uQ291bnRlciAmJiBtYXhJbml0aWFsaXphdGlvbkNvdW50ZXIgPT09IDAgJiZcbiAgICAgICAgbWF4U3BlY2lmaWNhdGlvbkNvdW50IDwgc3RhdGUuc3BlY2lmaWNhdGlvbkNvdW50KSB7XG4gICAgICAgIGlmICghc3ltYm9sIHx8IChtb2RlID09PSAnc3BlY2lmaWNhdGlvbicgJiYgc3RhdGUuc3BlY2lmaWNhdGlvbnNCeVN5bWJvbFtzeW1ib2xdKSB8fFxuICAgICAgICAgIChtb2RlID09PSAncHJpY2UnICYmIHN0YXRlLnByaWNlc0J5U3ltYm9sW3N5bWJvbF0pKSB7XG4gICAgICAgICAgbWF4VXBkYXRlVGltZSA9IHN0YXRlLmxhc3RVcGRhdGVUaW1lO1xuICAgICAgICAgIG1heEluaXRpYWxpemF0aW9uQ291bnRlciA9IHN0YXRlLmluaXRpYWxpemF0aW9uQ291bnRlcjtcbiAgICAgICAgICBtYXhTcGVjaWZpY2F0aW9uQ291bnQgPSBzdGF0ZS5zcGVjaWZpY2F0aW9uQ291bnQ7XG4gICAgICAgICAgcmVzdWx0ID0gc3RhdGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdCB8fCB0aGlzLl9jb25zdHJ1Y3RUZXJtaW5hbFN0YXRlKCk7XG4gIH1cbiAgXG59XG4iXX0=