'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

var _historyStorage = require('./historyStorage');

var _historyStorage2 = _interopRequireDefault(_historyStorage);

var _index = require('./historyFileManager/index');

var _index2 = _interopRequireDefault(_index);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * History storage which stores MetaTrader history in RAM
 */
class MemoryHistoryStorage extends _historyStorage2.default {

  /**
   * Constructs the in-memory history store instance
   */
  constructor(accountId, application = 'MetaApi') {
    super();
    this._accountId = accountId;
    this._fileManager = new _index2.default(accountId, application, this);
    this._deals = [];
    this._historyOrders = [];
    this._lastDealTimeByInstanceIndex = {};
    this._lastHistoryOrderTimeByInstanceIndex = {};
    this._fileManager.startUpdateJob();
  }

  /**
   * Initializes the storage and loads required data from a persistent storage
   */
  async initialize() {
    await this.loadDataFromDisk();
  }

  /**
   * Returns all deals stored in history storage
   * @return {Array<MetatraderDeal>} all deals stored in history storage
   */
  get deals() {
    return this._deals;
  }

  /**
   * Returns all history orders stored in history storage
   * @return {Array<MetatraderOrder>} all history orders stored in history storage
   */
  get historyOrders() {
    return this._historyOrders;
  }

  /**
   * Returns times of last deals by instance indices
   * @return {Object} dictionary of last deal times by instance indices
   */
  get lastDealTimeByInstanceIndex() {
    return this._lastDealTimeByInstanceIndex;
  }

  /**
   * Returns times of last history orders by instance indices
   * @return {Object} dictionary of last history orders times by instance indices
   */
  get lastHistoryOrderTimeByInstanceIndex() {
    return this._lastHistoryOrderTimeByInstanceIndex;
  }

  /**
   * Resets the storage. Intended for use in tests
   */
  async clear() {
    this._deals = [];
    this._historyOrders = [];
    this._lastDealTimeByInstanceIndex = {};
    this._lastHistoryOrderTimeByInstanceIndex = {};
    await this._fileManager.deleteStorageFromDisk();
  }

  /**
   * Loads history data from the file manager
   * @return {Promise} promise which resolves when the history is loaded
   */
  async loadDataFromDisk() {
    const history = await this._fileManager.getHistoryFromDisk();
    this._deals = history.deals;
    this._historyOrders = history.historyOrders;
    this._lastDealTimeByInstanceIndex = history.lastDealTimeByInstanceIndex || {};
    this._lastHistoryOrderTimeByInstanceIndex = history.lastHistoryOrderTimeByInstanceIndex || {};
  }

  /**
   * Saves unsaved history items to disk storage
   */
  async updateDiskStorage() {
    await this._fileManager.updateDiskStorage();
  }

  /**
   * Returns the time of the last history order record stored in the history storage
   * @param {Number} [instanceNumber] index of an account instance connected
   * @returns {Date} the time of the last history order record stored in the history storage
   */
  lastHistoryOrderTime(instanceNumber) {
    if (instanceNumber !== undefined) {
      return new Date(this._lastHistoryOrderTimeByInstanceIndex['' + instanceNumber] || 0);
    } else {
      return new Date((0, _values2.default)(this._lastHistoryOrderTimeByInstanceIndex).reduce((acc, time) => time > acc ? time : acc, 0));
    }
  }

  /**
   * Returns the time of the last history deal record stored in the history storage
   * @param {Number} [instanceNumber] index of an account instance connected
   * @returns {Date} the time of the last history deal record stored in the history storage
   */
  lastDealTime(instanceNumber) {
    if (instanceNumber !== undefined) {
      return new Date(this._lastDealTimeByInstanceIndex['' + instanceNumber] || 0);
    } else {
      return new Date((0, _values2.default)(this._lastDealTimeByInstanceIndex).reduce((acc, time) => time > acc ? time : acc, 0));
    }
  }

  /**
   * Invoked when a new MetaTrader history order is added
   * @param {String} instanceIndex index of an account instance connected
   * @param {MetatraderOrder} historyOrder new MetaTrader history order
   */
  // eslint-disable-next-line complexity
  onHistoryOrderAdded(instanceIndex, historyOrder) {
    const instance = this.getInstanceNumber(instanceIndex);
    let insertIndex = 0;
    let replacementIndex = -1;
    const newHistoryOrderTime = (historyOrder.doneTime || new Date(0)).getTime();
    if (!this._lastHistoryOrderTimeByInstanceIndex['' + instance] || this._lastHistoryOrderTimeByInstanceIndex['' + instance] < newHistoryOrderTime) {
      this._lastHistoryOrderTimeByInstanceIndex['' + instance] = newHistoryOrderTime;
    }
    for (let i = this._historyOrders.length - 1; i >= 0; i--) {
      const order = this._historyOrders[i];
      const historyOrderTime = (order.doneTime || new Date(0)).getTime();
      if (historyOrderTime < newHistoryOrderTime || historyOrderTime === newHistoryOrderTime && order.id <= historyOrder.id) {
        if (historyOrderTime === newHistoryOrderTime && order.id === historyOrder.id && order.type === historyOrder.type) {
          replacementIndex = i;
        } else {
          insertIndex = i + 1;
        }
        break;
      }
    }
    if (replacementIndex !== -1) {
      this._historyOrders[replacementIndex] = historyOrder;
      this._fileManager.setStartNewOrderIndex(replacementIndex);
    } else {
      this._historyOrders.splice(insertIndex, 0, historyOrder);
      this._fileManager.setStartNewOrderIndex(insertIndex);
    }
  }

  /**
   * Invoked when a new MetaTrader history deal is added
   * @param {String} instanceIndex index of an account instance connected
   * @param {MetatraderDeal} deal new MetaTrader history deal
   */
  // eslint-disable-next-line complexity
  onDealAdded(instanceIndex, deal) {
    const instance = this.getInstanceNumber(instanceIndex);
    let insertIndex = 0;
    let replacementIndex = -1;
    const newDealTime = (deal.time || new Date(0)).getTime();
    if (!this._lastDealTimeByInstanceIndex['' + instance] || this._lastDealTimeByInstanceIndex['' + instance] < newDealTime) {
      this._lastDealTimeByInstanceIndex['' + instance] = newDealTime;
    }
    for (let i = this._deals.length - 1; i >= 0; i--) {
      const d = this._deals[i];
      const dealTime = (d.time || new Date(0)).getTime();
      if (dealTime < newDealTime || dealTime === newDealTime && d.id <= deal.id || dealTime === newDealTime && d.id === deal.id && d.entryType <= deal.entryType) {
        if (dealTime === newDealTime && d.id === deal.id && d.entryType === deal.entryType) {
          replacementIndex = i;
        } else {
          insertIndex = i + 1;
        }
        break;
      }
    }
    if (replacementIndex !== -1) {
      this._deals[replacementIndex] = deal;
      this._fileManager.setStartNewDealIndex(replacementIndex);
    } else {
      this._deals.splice(insertIndex, 0, deal);
      this._fileManager.setStartNewDealIndex(insertIndex);
    }
  }

  /**
   * Invoked when a synchronization of history deals on a MetaTrader account have finished
   * @param {String} instanceIndex index of an account instance connected
   */
  async onDealSynchronizationFinished(instanceIndex, synchronizationId) {
    const instance = this.getInstanceNumber(instanceIndex);
    this._dealSynchronizationFinished[instance] = true;
    await this.updateDiskStorage();
  }

}
exports.default = MemoryHistoryStorage;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL21lbW9yeUhpc3RvcnlTdG9yYWdlLmVzNiJdLCJuYW1lcyI6WyJNZW1vcnlIaXN0b3J5U3RvcmFnZSIsIkhpc3RvcnlTdG9yYWdlIiwiY29uc3RydWN0b3IiLCJhY2NvdW50SWQiLCJhcHBsaWNhdGlvbiIsIl9hY2NvdW50SWQiLCJfZmlsZU1hbmFnZXIiLCJIaXN0b3J5RmlsZU1hbmFnZXIiLCJfZGVhbHMiLCJfaGlzdG9yeU9yZGVycyIsIl9sYXN0RGVhbFRpbWVCeUluc3RhbmNlSW5kZXgiLCJfbGFzdEhpc3RvcnlPcmRlclRpbWVCeUluc3RhbmNlSW5kZXgiLCJzdGFydFVwZGF0ZUpvYiIsImluaXRpYWxpemUiLCJsb2FkRGF0YUZyb21EaXNrIiwiZGVhbHMiLCJoaXN0b3J5T3JkZXJzIiwibGFzdERlYWxUaW1lQnlJbnN0YW5jZUluZGV4IiwibGFzdEhpc3RvcnlPcmRlclRpbWVCeUluc3RhbmNlSW5kZXgiLCJjbGVhciIsImRlbGV0ZVN0b3JhZ2VGcm9tRGlzayIsImhpc3RvcnkiLCJnZXRIaXN0b3J5RnJvbURpc2siLCJ1cGRhdGVEaXNrU3RvcmFnZSIsImxhc3RIaXN0b3J5T3JkZXJUaW1lIiwiaW5zdGFuY2VOdW1iZXIiLCJ1bmRlZmluZWQiLCJEYXRlIiwicmVkdWNlIiwiYWNjIiwidGltZSIsImxhc3REZWFsVGltZSIsIm9uSGlzdG9yeU9yZGVyQWRkZWQiLCJpbnN0YW5jZUluZGV4IiwiaGlzdG9yeU9yZGVyIiwiaW5zdGFuY2UiLCJnZXRJbnN0YW5jZU51bWJlciIsImluc2VydEluZGV4IiwicmVwbGFjZW1lbnRJbmRleCIsIm5ld0hpc3RvcnlPcmRlclRpbWUiLCJkb25lVGltZSIsImdldFRpbWUiLCJpIiwibGVuZ3RoIiwib3JkZXIiLCJoaXN0b3J5T3JkZXJUaW1lIiwiaWQiLCJ0eXBlIiwic2V0U3RhcnROZXdPcmRlckluZGV4Iiwic3BsaWNlIiwib25EZWFsQWRkZWQiLCJkZWFsIiwibmV3RGVhbFRpbWUiLCJkIiwiZGVhbFRpbWUiLCJlbnRyeVR5cGUiLCJzZXRTdGFydE5ld0RlYWxJbmRleCIsIm9uRGVhbFN5bmNocm9uaXphdGlvbkZpbmlzaGVkIiwic3luY2hyb25pemF0aW9uSWQiLCJfZGVhbFN5bmNocm9uaXphdGlvbkZpbmlzaGVkIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7OztBQUVBOzs7O0FBQ0E7Ozs7OztBQUVBOzs7QUFHZSxNQUFNQSxvQkFBTixTQUFtQ0Msd0JBQW5DLENBQWtEOztBQUUvRDs7O0FBR0FDLGNBQVlDLFNBQVosRUFBdUJDLGNBQWMsU0FBckMsRUFBZ0Q7QUFDOUM7QUFDQSxTQUFLQyxVQUFMLEdBQWtCRixTQUFsQjtBQUNBLFNBQUtHLFlBQUwsR0FBb0IsSUFBSUMsZUFBSixDQUF1QkosU0FBdkIsRUFBa0NDLFdBQWxDLEVBQStDLElBQS9DLENBQXBCO0FBQ0EsU0FBS0ksTUFBTCxHQUFjLEVBQWQ7QUFDQSxTQUFLQyxjQUFMLEdBQXNCLEVBQXRCO0FBQ0EsU0FBS0MsNEJBQUwsR0FBb0MsRUFBcEM7QUFDQSxTQUFLQyxvQ0FBTCxHQUE0QyxFQUE1QztBQUNBLFNBQUtMLFlBQUwsQ0FBa0JNLGNBQWxCO0FBQ0Q7O0FBRUQ7OztBQUdBLFFBQU1DLFVBQU4sR0FBbUI7QUFDakIsVUFBTSxLQUFLQyxnQkFBTCxFQUFOO0FBQ0Q7O0FBRUQ7Ozs7QUFJQSxNQUFJQyxLQUFKLEdBQVk7QUFDVixXQUFPLEtBQUtQLE1BQVo7QUFDRDs7QUFFRDs7OztBQUlBLE1BQUlRLGFBQUosR0FBb0I7QUFDbEIsV0FBTyxLQUFLUCxjQUFaO0FBQ0Q7O0FBRUQ7Ozs7QUFJQSxNQUFJUSwyQkFBSixHQUFrQztBQUNoQyxXQUFPLEtBQUtQLDRCQUFaO0FBQ0Q7O0FBRUQ7Ozs7QUFJQSxNQUFJUSxtQ0FBSixHQUEwQztBQUN4QyxXQUFPLEtBQUtQLG9DQUFaO0FBQ0Q7O0FBRUQ7OztBQUdBLFFBQU1RLEtBQU4sR0FBYztBQUNaLFNBQUtYLE1BQUwsR0FBYyxFQUFkO0FBQ0EsU0FBS0MsY0FB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SCxhQUF2QixDQUFqQjtBQUNBLFNBQUswQiw0QkFBTCxDQUFrQ3hCLFFBQWxDLElBQThDLElBQTlDO0FBQ0EsVUFBTSxLQUFLWixpQkFBTCxFQUFOO0FBQ0Q7O0FBcE04RDtrQkFBNUN2QixvQiIsImZpbGUiOiJtZW1vcnlIaXN0b3J5U3RvcmFnZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IEhpc3RvcnlTdG9yYWdlIGZyb20gJy4vaGlzdG9yeVN0b3JhZ2UnO1xuaW1wb3J0IEhpc3RvcnlGaWxlTWFuYWdlciBmcm9tICcuL2hpc3RvcnlGaWxlTWFuYWdlci9pbmRleCc7XG5cbi8qKlxuICogSGlzdG9yeSBzdG9yYWdlIHdoaWNoIHN0b3JlcyBNZXRhVHJhZGVyIGhpc3RvcnkgaW4gUkFNXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1lbW9yeUhpc3RvcnlTdG9yYWdlIGV4dGVuZHMgSGlzdG9yeVN0b3JhZ2Uge1xuXG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIHRoZSBpbi1tZW1vcnkgaGlzdG9yeSBzdG9yZSBpbnN0YW5jZVxuICAgKi9cbiAgY29uc3RydWN0b3IoYWNjb3VudElkLCBhcHBsaWNhdGlvbiA9ICdNZXRhQXBpJykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fYWNjb3VudElkID0gYWNjb3VudElkO1xuICAgIHRoaXMuX2ZpbGVNYW5hZ2VyID0gbmV3IEhpc3RvcnlGaWxlTWFuYWdlcihhY2NvdW50SWQsIGFwcGxpY2F0aW9uLCB0aGlzKTtcbiAgICB0aGlzLl9kZWFscyA9IFtdO1xuICAgIHRoaXMuX2hpc3RvcnlPcmRlcnMgPSBbXTtcbiAgICB0aGlzLl9sYXN0RGVhbFRpbWVCeUluc3RhbmNlSW5kZXggPSB7fTtcbiAgICB0aGlzLl9sYXN0SGlzdG9yeU9yZGVyVGltZUJ5SW5zdGFuY2VJbmRleCA9IHt9O1xuICAgIHRoaXMuX2ZpbGVNYW5hZ2VyLnN0YXJ0VXBkYXRlSm9iKCk7XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZXMgdGhlIHN0b3JhZ2UgYW5kIGxvYWRzIHJlcXVpcmVkIGRhdGEgZnJvbSBhIHBlcnNpc3RlbnQgc3RvcmFnZVxuICAgKi9cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpIHtcbiAgICBhd2FpdCB0aGlzLmxvYWREYXRhRnJvbURpc2soKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFsbCBkZWFscyBzdG9yZWQgaW4gaGlzdG9yeSBzdG9yYWdlXG4gICAqIEByZXR1cm4ge0FycmF5PE1ldGF0cmFkZXJEZWFsPn0gYWxsIGRlYWxzIHN0b3JlZCBpbiBoaXN0b3J5IHN0b3JhZ2VcbiAgICovXG4gIGdldCBkZWFscygpIHtcbiAgICByZXR1cm4gdGhpcy5fZGVhbHM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbGwgaGlzdG9yeSBvcmRlcnMgc3RvcmVkIGluIGhpc3Rvcnkgc3RvcmFnZVxuICAgKiBAcmV0dXJuIHtBcnJheTxNZXRhdHJhZGVyT3JkZXI+fSBhbGwgaGlzdG9yeSBvcmRlcnMgc3RvcmVkIGluIGhpc3Rvcnkgc3RvcmFnZVxuICAgKi9cbiAgZ2V0IGhpc3RvcnlPcmRlcnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2hpc3RvcnlPcmRlcnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aW1lcyBvZiBsYXN0IGRlYWxzIGJ5IGluc3RhbmNlIGluZGljZXNcbiAgICogQHJldHVybiB7T2JqZWN0fSBkaWN0aW9uYXJ5IG9mIGxhc3QgZGVhbCB0aW1lcyBieSBpbnN0YW5jZSBpbmRpY2VzXG4gICAqL1xuICBnZXQgbGFzdERlYWxUaW1lQnlJbnN0YW5jZUluZGV4KCkge1xuICAgIHJldHVybiB0aGlzLl9sYXN0RGVhbFRpbWVCeUluc3RhbmNlSW5kZXg7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aW1lcyBvZiBsYXN0IGhpc3Rvcnkgb3JkZXJzIGJ5IGluc3RhbmNlIGluZGljZXNcbiAgICogQHJldHVybiB7T2JqZWN0fSBkaWN0aW9uYXJ5IG9mIGxhc3QgaGlzdG9yeSBvcmRlcnMgdGltZXMgYnkgaW5zdGFuY2UgaW5kaWNlc1xuICAgKi9cbiAgZ2V0IGxhc3RIaXN0b3J5T3JkZXJUaW1lQnlJbnN0YW5jZUluZGV4KCkge1xuICAgIHJldHVybiB0aGlzLl9sYXN0SGlzdG9yeU9yZGVyVGltZUJ5SW5zdGFuY2VJbmRleDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldHMgdGhlIHN0b3JhZ2UuIEludGVuZGVkIGZvciB1c2UgaW4gdGVzdHNcbiAgICovXG4gIGFzeW5jIGNsZWFyKCkge1xuICAgIHRoaXMuX2RlYWxzID0gW107XG4gICAgdGhpcy5faGlzdG9yeU9yZGVycyA9IFtdO1xuICAgIHRoaXMuX2xhc3REZWFsVGltZUJ5SW5zdGFuY2VJbmRleCA9IHt9O1xuICAgIHRoaXMuX2xhc3RIaXN0b3J5T3JkZXJUaW1lQnlJbnN0YW5jZUluZGV4ID0ge307XG4gICAgYXdhaXQgdGhpcy5fZmlsZU1hbmFnZXIuZGVsZXRlU3RvcmFnZUZyb21EaXNrKCk7XG4gIH1cblxuICAvKipcbiAgICogTG9hZHMgaGlzdG9yeSBkYXRhIGZyb20gdGhlIGZpbGUgbWFuYWdlclxuICAgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHdoaWNoIHJlc29sdmVzIHdoZW4gdGhlIGhpc3RvcnkgaXMgbG9hZGVkXG4gICAqL1xuICBhc3luYyBsb2FkRGF0YUZyb21EaXNrKCkge1xuICAgIGNvbnN0IGhpc3RvcnkgPSBhd2FpdCB0aGlzLl9maWxlTWFuYWdlci5nZXRIaXN0b3J5RnJvbURpc2soKTtcbiAgICB0aGlzLl9kZWFscyA9IGhpc3RvcnkuZGVhbHM7XG4gICAgdGhpcy5faGlzdG9yeU9yZGVycyA9IGhpc3RvcnkuaGlzdG9yeU9yZGVycztcbiAgICB0aGlzLl9sYXN0RGVhbFRpbWVCeUluc3RhbmNlSW5kZXggPSBoaXN0b3J5Lmxhc3REZWFsVGltZUJ5SW5zdGFuY2VJbmRleCB8fCB7fTtcbiAgICB0aGlzLl9sYXN0SGlzdG9yeU9yZGVyVGltZUJ5SW5zdGFuY2VJbmRleCA9IGhpc3RvcnkubGFzdEhpc3RvcnlPcmRlclRpbWVCeUluc3RhbmNlSW5kZXggfHwge307XG4gIH1cblxuICAvKipcbiAgICogU2F2ZXMgdW5zYXZlZCBoaXN0b3J5IGl0ZW1zIHRvIGRpc2sgc3RvcmFnZVxuICAgKi9cbiAgYXN5bmMgdXBkYXRlRGlza1N0b3JhZ2UoKSB7XG4gICAgYXdhaXQgdGhpcy5fZmlsZU1hbmFnZXIudXBkYXRlRGlza1N0b3JhZ2UoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB0aW1lIG9mIHRoZSBsYXN0IGhpc3Rvcnkgb3JkZXIgcmVjb3JkIHN0b3JlZCBpbiB0aGUgaGlzdG9yeSBzdG9yYWdlXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBbaW5zdGFuY2VOdW1iZXJdIGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqIEByZXR1cm5zIHtEYXRlfSB0aGUgdGltZSBvZiB0aGUgbGFzdCBoaXN0b3J5IG9yZGVyIHJlY29yZCBzdG9yZWQgaW4gdGhlIGhpc3Rvcnkgc3RvcmFnZVxuICAgKi9cbiAgbGFzdEhpc3RvcnlPcmRlclRpbWUoaW5zdGFuY2VOdW1iZXIpIHtcbiAgICBpZiAoaW5zdGFuY2VOdW1iZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMuX2xhc3RIaXN0b3J5T3JkZXJUaW1lQnlJbnN0YW5jZUluZGV4WycnICsgaW5zdGFuY2VOdW1iZXJdIHx8IDApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV3IERhdGUoT2JqZWN0LnZhbHVlcyh0aGlzLl9sYXN0SGlzdG9yeU9yZGVyVGltZUJ5SW5zdGFuY2VJbmRleClcbiAgICAgICAgLnJlZHVjZSgoYWNjLCB0aW1lKSA9PiB0aW1lID4gYWNjID8gdGltZSA6IGFjYywgMCkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB0aW1lIG9mIHRoZSBsYXN0IGhpc3RvcnkgZGVhbCByZWNvcmQgc3RvcmVkIGluIHRoZSBoaXN0b3J5IHN0b3JhZ2VcbiAgICogQHBhcmFtIHtOdW1iZXJ9IFtpbnN0YW5jZU51bWJlcl0gaW5kZXggb2YgYW4gYWNjb3VudCBpbnN0YW5jZSBjb25uZWN0ZWRcbiAgICogQHJldHVybnMge0RhdGV9IHRoZSB0aW1lIG9mIHRoZSBsYXN0IGhpc3RvcnkgZGVhbCByZWNvcmQgc3RvcmVkIGluIHRoZSBoaXN0b3J5IHN0b3JhZ2VcbiAgICovXG4gIGxhc3REZWFsVGltZShpbnN0YW5jZU51bWJlcikge1xuICAgIGlmIChpbnN0YW5jZU51bWJlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gbmV3IERhdGUodGhpcy5fbGFzdERlYWxUaW1lQnlJbnN0YW5jZUluZGV4WycnICsgaW5zdGFuY2VOdW1iZXJdIHx8IDApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV3IERhdGUoT2JqZWN0LnZhbHVlcyh0aGlzLl9sYXN0RGVhbFRpbWVCeUluc3RhbmNlSW5kZXgpLnJlZHVjZSgoYWNjLCB0aW1lKSA9PiB0aW1lID4gYWNjID8gdGltZSA6IGFjYyxcbiAgICAgICAgMCkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gYSBuZXcgTWV0YVRyYWRlciBoaXN0b3J5IG9yZGVyIGlzIGFkZGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZUluZGV4IGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqIEBwYXJhbSB7TWV0YXRyYWRlck9yZGVyfSBoaXN0b3J5T3JkZXIgbmV3IE1ldGFUcmFkZXIgaGlzdG9yeSBvcmRlclxuICAgKi9cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbXBsZXhpdHlcbiAgb25IaXN0b3J5T3JkZXJBZGRlZChpbnN0YW5jZUluZGV4LCBoaXN0b3J5T3JkZXIpIHtcbiAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMuZ2V0SW5zdGFuY2VOdW1iZXIoaW5zdGFuY2VJbmRleCk7XG4gICAgbGV0IGluc2VydEluZGV4ID0gMDtcbiAgICBsZXQgcmVwbGFjZW1lbnRJbmRleCA9IC0xO1xuICAgIGNvbnN0IG5ld0hpc3RvcnlPcmRlclRpbWUgPSAoaGlzdG9yeU9yZGVyLmRvbmVUaW1lIHx8IG5ldyBEYXRlKDApKS5nZXRUaW1lKCk7XG4gICAgaWYgKCF0aGlzLl9sYXN0SGlzdG9yeU9yZGVyVGltZUJ5SW5zdGFuY2VJbmRleFsnJyArIGluc3RhbmNlXSB8fFxuICAgICAgdGhpcy5fbGFzdEhpc3RvcnlPcmRlclRpbWVCeUluc3RhbmNlSW5kZXhbJycgKyBpbnN0YW5jZV0gPCBuZXdIaXN0b3J5T3JkZXJUaW1lKSB7XG4gICAgICB0aGlzLl9sYXN0SGlzdG9yeU9yZGVyVGltZUJ5SW5zdGFuY2VJbmRleFsnJyArIGluc3RhbmNlXSA9IG5ld0hpc3RvcnlPcmRlclRpbWU7XG4gICAgfVxuICAgIGZvcihsZXQgaSA9IHRoaXMuX2hpc3RvcnlPcmRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIGNvbnN0IG9yZGVyID0gdGhpcy5faGlzdG9yeU9yZGVyc1tpXTtcbiAgICAgIGNvbnN0IGhpc3RvcnlPcmRlclRpbWUgPSAob3JkZXIuZG9uZVRpbWUgfHwgbmV3IERhdGUoMCkpLmdldFRpbWUoKTtcbiAgICAgIGlmIChoaXN0b3J5T3JkZXJUaW1lIDwgbmV3SGlzdG9yeU9yZGVyVGltZSB8fFxuICAgICAgICAoaGlzdG9yeU9yZGVyVGltZSA9PT0gbmV3SGlzdG9yeU9yZGVyVGltZSAmJiBvcmRlci5pZCA8PSBoaXN0b3J5T3JkZXIuaWQpKSB7XG4gICAgICAgIGlmIChoaXN0b3J5T3JkZXJUaW1lID09PSBuZXdIaXN0b3J5T3JkZXJUaW1lICYmIG9yZGVyLmlkID09PSBoaXN0b3J5T3JkZXIuaWQgJiYgXG4gICAgICAgICAgb3JkZXIudHlwZSA9PT0gaGlzdG9yeU9yZGVyLnR5cGUpIHtcbiAgICAgICAgICByZXBsYWNlbWVudEluZGV4ID0gaTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpbnNlcnRJbmRleCA9IGkgKyAxO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAocmVwbGFjZW1lbnRJbmRleCAhPT0gLTEpIHtcbiAgICAgIHRoaXMuX2hpc3RvcnlPcmRlcnNbcmVwbGFjZW1lbnRJbmRleF0gPSBoaXN0b3J5T3JkZXI7XG4gICAgICB0aGlzLl9maWxlTWFuYWdlci5zZXRTdGFydE5ld09yZGVySW5kZXgocmVwbGFjZW1lbnRJbmRleCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2hpc3RvcnlPcmRlcnMuc3BsaWNlKGluc2VydEluZGV4LCAwLCBoaXN0b3J5T3JkZXIpO1xuICAgICAgdGhpcy5fZmlsZU1hbmFnZXIuc2V0U3RhcnROZXdPcmRlckluZGV4KGluc2VydEluZGV4KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGEgbmV3IE1ldGFUcmFkZXIgaGlzdG9yeSBkZWFsIGlzIGFkZGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZUluZGV4IGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqIEBwYXJhbSB7TWV0YXRyYWRlckRlYWx9IGRlYWwgbmV3IE1ldGFUcmFkZXIgaGlzdG9yeSBkZWFsXG4gICAqL1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY29tcGxleGl0eVxuICBvbkRlYWxBZGRlZChpbnN0YW5jZUluZGV4LCBkZWFsKSB7XG4gICAgY29uc3QgaW5zdGFuY2UgPSB0aGlzLmdldEluc3RhbmNlTnVtYmVyKGluc3RhbmNlSW5kZXgpO1xuICAgIGxldCBpbnNlcnRJbmRleCA9IDA7XG4gICAgbGV0IHJlcGxhY2VtZW50SW5kZXggPSAtMTtcbiAgICBjb25zdCBuZXdEZWFsVGltZSA9IChkZWFsLnRpbWUgfHwgbmV3IERhdGUoMCkpLmdldFRpbWUoKTtcbiAgICBpZiAoIXRoaXMuX2xhc3REZWFsVGltZUJ5SW5zdGFuY2VJbmRleFsnJyArIGluc3RhbmNlXSB8fFxuICAgICAgdGhpcy5fbGFzdERlYWxUaW1lQnlJbnN0YW5jZUluZGV4WycnICsgaW5zdGFuY2VdIDwgbmV3RGVhbFRpbWUpIHtcbiAgICAgIHRoaXMuX2xhc3REZWFsVGltZUJ5SW5zdGFuY2VJbmRleFsnJyArIGluc3RhbmNlXSA9IG5ld0RlYWxUaW1lO1xuICAgIH1cbiAgICBmb3IobGV0IGkgPSB0aGlzLl9kZWFscy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgY29uc3QgZCA9IHRoaXMuX2RlYWxzW2ldO1xuICAgICAgY29uc3QgZGVhbFRpbWUgPSAoZC50aW1lIHx8IG5ldyBEYXRlKDApKS5nZXRUaW1lKCk7XG4gICAgICBpZiAoKGRlYWxUaW1lIDwgbmV3RGVhbFRpbWUpIHx8IChkZWFsVGltZSA9PT0gbmV3RGVhbFRpbWUgJiYgZC5pZCA8PSBkZWFsLmlkKSB8fFxuICAgICAgICAoZGVhbFRpbWUgPT09IG5ld0RlYWxUaW1lICYmIGQuaWQgPT09IGRlYWwuaWQgJiYgZC5lbnRyeVR5cGUgPD0gZGVhbC5lbnRyeVR5cGUpKSB7XG4gICAgICAgIGlmIChkZWFsVGltZSA9PT0gbmV3RGVhbFRpbWUgJiYgZC5pZCA9PT0gZGVhbC5pZCAmJiBkLmVudHJ5VHlwZSA9PT0gZGVhbC5lbnRyeVR5cGUpIHtcbiAgICAgICAgICByZXBsYWNlbWVudEluZGV4ID0gaTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpbnNlcnRJbmRleCA9IGkgKyAxO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAocmVwbGFjZW1lbnRJbmRleCAhPT0gLTEpIHtcbiAgICAgIHRoaXMuX2RlYWxzW3JlcGxhY2VtZW50SW5kZXhdID0gZGVhbDtcbiAgICAgIHRoaXMuX2ZpbGVNYW5hZ2VyLnNldFN0YXJ0TmV3RGVhbEluZGV4KHJlcGxhY2VtZW50SW5kZXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9kZWFscy5zcGxpY2UoaW5zZXJ0SW5kZXgsIDAsIGRlYWwpO1xuICAgICAgdGhpcy5fZmlsZU1hbmFnZXIuc2V0U3RhcnROZXdEZWFsSW5kZXgoaW5zZXJ0SW5kZXgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gYSBzeW5jaHJvbml6YXRpb24gb2YgaGlzdG9yeSBkZWFscyBvbiBhIE1ldGFUcmFkZXIgYWNjb3VudCBoYXZlIGZpbmlzaGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZUluZGV4IGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqL1xuICBhc3luYyBvbkRlYWxTeW5jaHJvbml6YXRpb25GaW5pc2hlZChpbnN0YW5jZUluZGV4LCBzeW5jaHJvbml6YXRpb25JZCkge1xuICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy5nZXRJbnN0YW5jZU51bWJlcihpbnN0YW5jZUluZGV4KTtcbiAgICB0aGlzLl9kZWFsU3luY2hyb25pemF0aW9uRmluaXNoZWRbaW5zdGFuY2VdID0gdHJ1ZTtcbiAgICBhd2FpdCB0aGlzLnVwZGF0ZURpc2tTdG9yYWdlKCk7XG4gIH1cblxufVxuIl19