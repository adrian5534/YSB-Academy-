'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _httpClient = require('../clients/httpClient');

var _httpClient2 = _interopRequireDefault(_httpClient);

var _provisioningProfile = require('../clients/metaApi/provisioningProfile.client');

var _provisioningProfile2 = _interopRequireDefault(_provisioningProfile);

var _provisioningProfileApi = require('./provisioningProfileApi');

var _provisioningProfileApi2 = _interopRequireDefault(_provisioningProfileApi);

var _metaApiWebsocket = require('../clients/metaApi/metaApiWebsocket.client');

var _metaApiWebsocket2 = _interopRequireDefault(_metaApiWebsocket);

var _metatraderAccountApi = require('./metatraderAccountApi');

var _metatraderAccountApi2 = _interopRequireDefault(_metatraderAccountApi);

var _metatraderAccount = require('../clients/metaApi/metatraderAccount.client');

var _metatraderAccount2 = _interopRequireDefault(_metatraderAccount);

var _metatraderDemoAccountApi = require('./metatraderDemoAccountApi');

var _metatraderDemoAccountApi2 = _interopRequireDefault(_metatraderDemoAccountApi);

var _metatraderDemoAccount = require('../clients/metaApi/metatraderDemoAccount.client');

var _metatraderDemoAccount2 = _interopRequireDefault(_metatraderDemoAccount);

var _historicalMarketData = require('../clients/metaApi/historicalMarketData.client');

var _historicalMarketData2 = _interopRequireDefault(_historicalMarketData);

var _connectionRegistry = require('./connectionRegistry');

var _connectionRegistry2 = _interopRequireDefault(_connectionRegistry);

var _errorHandler = require('../clients/errorHandler');

var _optionsValidator = require('../clients/optionsValidator');

var _optionsValidator2 = _interopRequireDefault(_optionsValidator);

var _latencyMonitor = require('./latencyMonitor');

var _latencyMonitor2 = _interopRequireDefault(_latencyMonitor);

var _expertAdvisor = require('../clients/metaApi/expertAdvisor.client');

var _expertAdvisor2 = _interopRequireDefault(_expertAdvisor);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Request retry options
 * @typedef {Object} RetryOpts
 * @property {Number} [retries] maximum amount of request retries, default value is 5
 * @property {Number} [minDelayInSeconds] minimum delay in seconds until request retry, default value is 1
 * @property {Number} [maxDelayInSeconds] maximum delay in seconds until request retry, default value is 30
 */

/**
 * Options for processing websocket client events
 * @typedef {Object} EventProcessingOpts
 * @property {Boolean} [sequentialProcessing] an option to process synchronization events after finishing
 * previous ones
 */

/**
 * MetaApi options
 * @typedef {Object} MetaApiOpts
 * @property {String} [application] application id
 * @property {String} [domain] domain to connect to, default is agiliumtrade.agiliumtrade.ai
 * @property {Number} [requestTimeout] timeout for socket requests in seconds
 * @property {Number} [connectTimeout] timeout for connecting to server in seconds
 * @property {Number} [packetOrderingTimeout] packet ordering timeout in seconds
 * @property {PacketLoggerOpts} [packetLogger] packet logger options
 * @property {Boolean} [enableLatencyMonitor] an option to enable latency tracking
 * @property {Boolean} [enableLatencyTracking] an option to enable latency tracking
 * @property {SynchronizationThrottlerOpts} [synchronizationThrottler] options for synchronization throttler
 * @property {RetryOpts} [retryOpts] options for request retries
 * @property {EventProcessingOpts} [eventProcessing] options for request retries
 * @property {Boolean} [useSharedClientApi] option to use a shared server
 */

/**
 * MetaApi MetaTrader API SDK
 */
class MetaApi {

  /**
   * Constructs MetaApi class instance
   * @param {String} token authorization token
   * @param {MetaApiOpts} opts application options
   */
  // eslint-disable-next-line complexity
  constructor(token, opts) {
    const validator = new _optionsValidator2.default();
    opts = opts || {};
    const application = opts.application || 'MetaApi';
    const domain = opts.domain || 'agiliumtrade.agiliumtrade.ai';
    const requestTimeout = validator.validateNonZero(opts.requestTimeout, 60, 'requestTimeout');
    const historicalMarketDataRequestTimeout = validator.validateNonZero(opts.historicalMarketDataRequestTimeout, 240, 'historicalMarketDataRequestTimeout');
    const connectTimeout = validator.validateNonZero(opts.connectTimeout, 60, 'connectTimeout');
    const packetOrderingTimeout = validator.validateNonZero(opts.packetOrderingTimeout, 60, 'packetOrderingTimeout');
    const retryOpts = opts.retryOpts || {};
    const packetLogger = opts.packetLogger || {};
    const synchronizationThrottler = opts.synchronizationThrottler || {};
    const demoAccountRequestTimeout = validator.validateNonZero(opts.demoAccountRequestTimeout, 240, 'demoAccountRequestTimeout');
    if (!application.match(/[a-zA-Z0-9_]+/)) {
      throw new _errorHandler.ValidationError('Application name must be non-empty string consisting from letters, digits and _ only');
    }
    const eventProcessing = opts.eventProcessing;
    const useSharedClientApi = opts.useSharedClientApi || false;
    let httpClient = new _httpClient2.default(requestTimeout, retryOpts);
    let historicalMarketDataHttpClient = new _httpClient2.default(historicalMarketDataRequestTimeout, retryOpts);
    let demoAccountHttpClient = new _httpClient2.default(demoAccountRequestTimeout, retryOpts);
    this._metaApiWebsocketClient = new _metaApiWebsocket2.default(httpClient, token, { application, domain, requestTimeout,
      connectTimeout, packetLogger, packetOrderingTimeout, synchronizationThrottler, retryOpts,
      eventProcessing, useSharedClientApi });
    this._provisioningProfileApi = new _provisioningProfileApi2.default(new _provisioningProfile2.default(httpClient, token, domain));
    this._connectionRegistry = new _connectionRegistry2.default(this._metaApiWebsocketClient, application);
    let historicalMarketDataClient = new _historicalMarketData2.default(historicalMarketDataHttpClient, token, domain);
    this._metatraderAccountApi = new _metatraderAccountApi2.default(new _metatraderAccount2.default(httpClient, token, domain), this._metaApiWebsocketClient, this._connectionRegistry, new _expertAdvisor2.default(httpClient, token, domain), historicalMarketDataClient);
    this._metatraderDemoAccountApi = new _metatraderDemoAccountApi2.default(new _metatraderDemoAccount2.default(demoAccountHttpClient, token, domain));
    if (opts.enableLatencyTracking || opts.enableLatencyMonitor) {
      this._latencyMonitor = new _latencyMonitor2.default();
      this._metaApiWebsocketClient.addLatencyListener(this._latencyMonitor);
    }
  }

  /**
   * Returns provisioning profile API
   * @returns {ProvisioningProfileApi} provisioning profile API
   */
  get provisioningProfileApi() {
    return this._provisioningProfileApi;
  }

  /**
   * Returns MetaTrader account API
   * @return {MetatraderAccountApi} MetaTrader account API
   */
  get metatraderAccountApi() {
    return this._metatraderAccountApi;
  }

  /**
   * Returns MetaTrader demo account API
   * @return {MetatraderDemoAccountApi} MetaTrader demo account API
   */
  get metatraderDemoAccountApi() {
    return this._metatraderDemoAccountApi;
  }

  /**
   * Returns MetaApi application latency monitor
   * @return {LatencyMonitor} latency monitor
   */
  get latencyMonitor() {
    return this._latencyMonitor;
  }

  /**
   * Closes all clients and connections
   */
  close() {
    this._metaApiWebsocketClient.removeLatencyListener(this._latencyMonitor);
    this._metaApiWebsocketClient.close();
  }

}
exports.default = MetaApi;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL21ldGFBcGkuZXM2Il0sIm5hbWVzIjpbIk1ldGFBcGkiLCJjb25zdHJ1Y3RvciIsInRva2VuIiwib3B0cyIsInZhbGlkYXRvciIsIk9wdGlvbnNWYWxpZGF0b3IiLCJhcHBsaWNhdGlvbiIsImRvbWFpbiIsInJlcXVlc3RUaW1lb3V0IiwidmFsaWRhdGVOb25aZXJvIiwiaGlzdG9yaWNhbE1hcmtldERhdGFSZXF1ZXN0VGltZW91dCIsImNvbm5lY3RUaW1lb3V0IiwicGFja2V0T3JkZXJpbmdUaW1lb3V0IiwicmV0cnlPcHRzIiwicGFja2V0TG9nZ2VyIiwic3luY2hyb25pemF0aW9uVGhyb3R0bGVyIiwiZGVtb0FjY291bnRSZXF1ZXN0VGltZW91dCIsIm1hdGNoIiwiVmFsaWRhdGlvbkVycm9yIiwiZXZlbnRQcm9jZXNzaW5nIiwidXNlU2hhcmVkQ2xpZW50QXBpIiwiaHR0cENsaWVudCIsIkh0dHBDbGllbnQiLCJoaXN0b3JpY2FsTWFya2V0RGF0YUh0dHBDbGllbnQiLCJkZW1vQWNjb3VudEh0dHBDbGllbnQiLCJfbWV0YUFwaVdlYnNvY2tldENsaWVudCIsIk1ldGFBcGlXZWJzb2NrZXRDbGllbnQiLCJfcHJvdmlzaW9uaW5nUHJvZmlsZUFwaSIsIlByb3Zpc2lvbmluZ1Byb2ZpbGVBcGkiLCJQcm92aXNpb25pbmdQcm9maWxlQ2xpZW50IiwiX2Nvbm5lY3Rpb25SZWdpc3RyeSIsIkNvbm5lY3Rpb25SZWdpc3RyeSIsImhpc3RvcmljYWxNYXJrZXREYXRhQ2xpZW50IiwiSGlzdG9yaWNhbE1hcmtldERhdGFDbGllbnQiLCJfbWV0YXRyYWRlckFjY291bnRBcGkiLCJNZXRhdHJhZGVyQWNjb3VudEFwaSIsIk1ldGF0cmFkZXJBY2NvdW50Q2xpZW50IiwiRXhwZXJ0QWR2aXNvckNsaWVudCIsIl9tZXRhdHJhZGVyRGVtb0FjY291bnRBcGkiLCJNZXRhdHJhZGVyRGVtb0FjY291bnRBcGkiLCJNZXRhdHJhZGVyRGVtb0FjY291bnRDbGllbnQiLCJlbmFibGVMYXRlbmN5VHJhY2tpbmciLCJlbmFibGVMYXRlbmN5TW9uaXRvciIsIl9sYXRlbmN5TW9uaXRvciIsIkxhdGVuY3lNb25pdG9yIiwiYWRkTGF0ZW5jeUxpc3RlbmVyIiwicHJvdmlzaW9uaW5nUHJvZmlsZUFwaSIsIm1ldGF0cmFkZXJBY2NvdW50QXBpIiwibWV0YXRyYWRlckRlbW9BY2NvdW50QXBpIiwibGF0ZW5jeU1vbml0b3IiLCJjbG9zZSIsInJlbW92ZUxhdGVuY3lMaXN0ZW5lciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQTs7Ozs7Ozs7QUFRQTs7Ozs7OztBQU9BOzs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQTs7O0FBR2UsTUFBTUEsT0FBTixDQUFjOztBQUUzQjs7Ozs7QUFLQTtBQUNBQyxjQUFZQyxLQUFaLEVBQW1CQyxJQUFuQixFQUF5QjtBQUN2QixVQUFNQyxZQUFZLElBQUlDLDBCQUFKLEVBQWxCO0FBQ0FGLFdBQU9BLFFBQVEsRUFBZjtBQUNBLFVBQU1HLGNBQWNILEtBQUtHLFdBQUwsSUFBb0IsU0FBeEM7QUFDQSxVQUFNQyxTQUFTSixLQUFLSSxNQUFMLElBQWUsOEJBQTlCO0FBQ0EsVUFBTUMsaUJBQWlCSixVQUFVSyxlQUFWLENBQTBCTixLQUFLSyxjQUEvQixFQUErQyxFQUEvQyxFQUFtRCxnQkFBbkQsQ0FBdkI7QUFDQSxVQUFNRSxxQ0FBcUNOLFVBQVVLLGVBQVYsQ0FDekNOLEtBQUtPLGtDQURvQyxFQUNBLEdBREEsRUFDSyxvQ0FETCxDQUEzQztBQUVBLFVBQU1DLGlCQUFpQlAsVUFBVUssZUFBVixDQUEwQk4sS0FBS1EsY0FBL0IsRUFBK0MsRUFBL0MsRUFBbUQsZ0JBQW5ELENBQXZCO0FBQ0EsVUFBTUMsd0JBQXdCUixVQUFVSyxl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QUNEOztBQUVEOzs7QUFHQU8sVUFBUTtBQUNOLFNBQUt6Qix1QkFBTCxDQUE2QjBCLHFCQUE3QixDQUFtRCxLQUFLUixlQUF4RDtBQUNBLFNBQUtsQix1QkFBTCxDQUE2QnlCLEtBQTdCO0FBQ0Q7O0FBdEYwQjtrQkFBUmxELE8iLCJmaWxlIjoibWV0YUFwaS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IEh0dHBDbGllbnQgZnJvbSAnLi4vY2xpZW50cy9odHRwQ2xpZW50JztcbmltcG9ydCBQcm92aXNpb25pbmdQcm9maWxlQ2xpZW50IGZyb20gJy4uL2NsaWVudHMvbWV0YUFwaS9wcm92aXNpb25pbmdQcm9maWxlLmNsaWVudCc7XG5pbXBvcnQgUHJvdmlzaW9uaW5nUHJvZmlsZUFwaSBmcm9tICcuL3Byb3Zpc2lvbmluZ1Byb2ZpbGVBcGknO1xuaW1wb3J0IE1ldGFBcGlXZWJzb2NrZXRDbGllbnQgZnJvbSAnLi4vY2xpZW50cy9tZXRhQXBpL21ldGFBcGlXZWJzb2NrZXQuY2xpZW50JztcbmltcG9ydCBNZXRhdHJhZGVyQWNjb3VudEFwaSBmcm9tICcuL21ldGF0cmFkZXJBY2NvdW50QXBpJztcbmltcG9ydCBNZXRhdHJhZGVyQWNjb3VudENsaWVudCBmcm9tICcuLi9jbGllbnRzL21ldGFBcGkvbWV0YXRyYWRlckFjY291bnQuY2xpZW50JztcbmltcG9ydCBNZXRhdHJhZGVyRGVtb0FjY291bnRBcGkgZnJvbSAnLi9tZXRhdHJhZGVyRGVtb0FjY291bnRBcGknO1xuaW1wb3J0IE1ldGF0cmFkZXJEZW1vQWNjb3VudENsaWVudCBmcm9tICcuLi9jbGllbnRzL21ldGFBcGkvbWV0YXRyYWRlckRlbW9BY2NvdW50LmNsaWVudCc7XG5pbXBvcnQgSGlzdG9yaWNhbE1hcmtldERhdGFDbGllbnQgZnJvbSAnLi4vY2xpZW50cy9tZXRhQXBpL2hpc3RvcmljYWxNYXJrZXREYXRhLmNsaWVudCc7XG5pbXBvcnQgQ29ubmVjdGlvblJlZ2lzdHJ5IGZyb20gJy4vY29ubmVjdGlvblJlZ2lzdHJ5JztcbmltcG9ydCB7VmFsaWRhdGlvbkVycm9yfSBmcm9tICcuLi9jbGllbnRzL2Vycm9ySGFuZGxlcic7XG5pbXBvcnQgT3B0aW9uc1ZhbGlkYXRvciBmcm9tICcuLi9jbGllbnRzL29wdGlvbnNWYWxpZGF0b3InO1xuaW1wb3J0IExhdGVuY3lNb25pdG9yIGZyb20gJy4vbGF0ZW5jeU1vbml0b3InO1xuaW1wb3J0IEV4cGVydEFkdmlzb3JDbGllbnQgZnJvbSAnLi4vY2xpZW50cy9tZXRhQXBpL2V4cGVydEFkdmlzb3IuY2xpZW50JztcblxuLyoqXG4gKiBSZXF1ZXN0IHJldHJ5IG9wdGlvbnNcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFJldHJ5T3B0c1xuICogQHByb3BlcnR5IHtOdW1iZXJ9IFtyZXRyaWVzXSBtYXhpbXVtIGFtb3VudCBvZiByZXF1ZXN0IHJldHJpZXMsIGRlZmF1bHQgdmFsdWUgaXMgNVxuICogQHByb3BlcnR5IHtOdW1iZXJ9IFttaW5EZWxheUluU2Vjb25kc10gbWluaW11bSBkZWxheSBpbiBzZWNvbmRzIHVudGlsIHJlcXVlc3QgcmV0cnksIGRlZmF1bHQgdmFsdWUgaXMgMVxuICogQHByb3BlcnR5IHtOdW1iZXJ9IFttYXhEZWxheUluU2Vjb25kc10gbWF4aW11bSBkZWxheSBpbiBzZWNvbmRzIHVudGlsIHJlcXVlc3QgcmV0cnksIGRlZmF1bHQgdmFsdWUgaXMgMzBcbiAqL1xuXG4vKipcbiAqIE9wdGlvbnMgZm9yIHByb2Nlc3Npbmcgd2Vic29ja2V0IGNsaWVudCBldmVudHNcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEV2ZW50UHJvY2Vzc2luZ09wdHNcbiAqIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gW3NlcXVlbnRpYWxQcm9jZXNzaW5nXSBhbiBvcHRpb24gdG8gcHJvY2VzcyBzeW5jaHJvbml6YXRpb24gZXZlbnRzIGFmdGVyIGZpbmlzaGluZ1xuICogcHJldmlvdXMgb25lc1xuICovXG5cbi8qKlxuICogTWV0YUFwaSBvcHRpb25zXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBNZXRhQXBpT3B0c1xuICogQHByb3BlcnR5IHtTdHJpbmd9IFthcHBsaWNhdGlvbl0gYXBwbGljYXRpb24gaWRcbiAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBbZG9tYWluXSBkb21haW4gdG8gY29ubmVjdCB0bywgZGVmYXVsdCBpcyBhZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpXG4gKiBAcHJvcGVydHkge051bWJlcn0gW3JlcXVlc3RUaW1lb3V0XSB0aW1lb3V0IGZvciBzb2NrZXQgcmVxdWVzdHMgaW4gc2Vjb25kc1xuICogQHByb3BlcnR5IHtOdW1iZXJ9IFtjb25uZWN0VGltZW91dF0gdGltZW91dCBmb3IgY29ubmVjdGluZyB0byBzZXJ2ZXIgaW4gc2Vjb25kc1xuICogQHByb3BlcnR5IHtOdW1iZXJ9IFtwYWNrZXRPcmRlcmluZ1RpbWVvdXRdIHBhY2tldCBvcmRlcmluZyB0aW1lb3V0IGluIHNlY29uZHNcbiAqIEBwcm9wZXJ0eSB7UGFja2V0TG9nZ2VyT3B0c30gW3BhY2tldExvZ2dlcl0gcGFja2V0IGxvZ2dlciBvcHRpb25zXG4gKiBAcHJvcGVydHkge0Jvb2xlYW59IFtlbmFibGVMYXRlbmN5TW9uaXRvcl0gYW4gb3B0aW9uIHRvIGVuYWJsZSBsYXRlbmN5IHRyYWNraW5nXG4gKiBAcHJvcGVydHkge0Jvb2xlYW59IFtlbmFibGVMYXRlbmN5VHJhY2tpbmddIGFuIG9wdGlvbiB0byBlbmFibGUgbGF0ZW5jeSB0cmFja2luZ1xuICogQHByb3BlcnR5IHtTeW5jaHJvbml6YXRpb25UaHJvdHRsZXJPcHRzfSBbc3luY2hyb25pemF0aW9uVGhyb3R0bGVyXSBvcHRpb25zIGZvciBzeW5jaHJvbml6YXRpb24gdGhyb3R0bGVyXG4gKiBAcHJvcGVydHkge1JldHJ5T3B0c30gW3JldHJ5T3B0c10gb3B0aW9ucyBmb3IgcmVxdWVzdCByZXRyaWVzXG4gKiBAcHJvcGVydHkge0V2ZW50UHJvY2Vzc2luZ09wdHN9IFtldmVudFByb2Nlc3NpbmddIG9wdGlvbnMgZm9yIHJlcXVlc3QgcmV0cmllc1xuICogQHByb3BlcnR5IHtCb29sZWFufSBbdXNlU2hhcmVkQ2xpZW50QXBpXSBvcHRpb24gdG8gdXNlIGEgc2hhcmVkIHNlcnZlclxuICovXG5cbi8qKlxuICogTWV0YUFwaSBNZXRhVHJhZGVyIEFQSSBTREtcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTWV0YUFwaSB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgTWV0YUFwaSBjbGFzcyBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge1N0cmluZ30gdG9rZW4gYXV0aG9yaXphdGlvbiB0b2tlblxuICAgKiBAcGFyYW0ge01ldGFBcGlPcHRzfSBvcHRzIGFwcGxpY2F0aW9uIG9wdGlvbnNcbiAgICovXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjb21wbGV4aXR5XG4gIGNvbnN0cnVjdG9yKHRva2VuLCBvcHRzKSB7XG4gICAgY29uc3QgdmFsaWRhdG9yID0gbmV3IE9wdGlvbnNWYWxpZGF0b3IoKTtcbiAgICBvcHRzID0gb3B0cyB8fCB7fTtcbiAgICBjb25zdCBhcHBsaWNhdGlvbiA9IG9wdHMuYXBwbGljYXRpb24gfHwgJ01ldGFBcGknO1xuICAgIGNvbnN0IGRvbWFpbiA9IG9wdHMuZG9tYWluIHx8ICdhZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpJztcbiAgICBjb25zdCByZXF1ZXN0VGltZW91dCA9IHZhbGlkYXRvci52YWxpZGF0ZU5vblplcm8ob3B0cy5yZXF1ZXN0VGltZW91dCwgNjAsICdyZXF1ZXN0VGltZW91dCcpO1xuICAgIGNvbnN0IGhpc3RvcmljYWxNYXJrZXREYXRhUmVxdWVzdFRpbWVvdXQgPSB2YWxpZGF0b3IudmFsaWRhdGVOb25aZXJvKFxuICAgICAgb3B0cy5oaXN0b3JpY2FsTWFya2V0RGF0YVJlcXVlc3RUaW1lb3V0LCAyNDAsICdoaXN0b3JpY2FsTWFya2V0RGF0YVJlcXVlc3RUaW1lb3V0Jyk7XG4gICAgY29uc3QgY29ubmVjdFRpbWVvdXQgPSB2YWxpZGF0b3IudmFsaWRhdGVOb25aZXJvKG9wdHMuY29ubmVjdFRpbWVvdXQsIDYwLCAnY29ubmVjdFRpbWVvdXQnKTtcbiAgICBjb25zdCBwYWNrZXRPcmRlcmluZ1RpbWVvdXQgPSB2YWxpZGF0b3IudmFsaWRhdGVOb25aZXJvKG9wdHMucGFja2V0T3JkZXJpbmdUaW1lb3V0LCA2MCwgJ3BhY2tldE9yZGVyaW5nVGltZW91dCcpO1xuICAgIGNvbnN0IHJldHJ5T3B0cyA9IG9wdHMucmV0cnlPcHRzIHx8IHt9O1xuICAgIGNvbnN0IHBhY2tldExvZ2dlciA9IG9wdHMucGFja2V0TG9nZ2VyIHx8IHt9O1xuICAgIGNvbnN0IHN5bmNocm9uaXphdGlvblRocm90dGxlciA9IG9wdHMuc3luY2hyb25pemF0aW9uVGhyb3R0bGVyIHx8IHt9O1xuICAgIGNvbnN0IGRlbW9BY2NvdW50UmVxdWVzdFRpbWVvdXQgPSB2YWxpZGF0b3IudmFsaWRhdGVOb25aZXJvKG9wdHMuZGVtb0FjY291bnRSZXF1ZXN0VGltZW91dCwgMjQwLFxuICAgICAgJ2RlbW9BY2NvdW50UmVxdWVzdFRpbWVvdXQnKTtcbiAgICBpZiAoIWFwcGxpY2F0aW9uLm1hdGNoKC9bYS16QS1aMC05X10rLykpIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ0FwcGxpY2F0aW9uIG5hbWUgbXVzdCBiZSBub24tZW1wdHkgc3RyaW5nIGNvbnNpc3RpbmcgZnJvbSBsZXR0ZXJzLCBkaWdpdHMgYW5kIF8gb25seScpO1xuICAgIH1cbiAgICBjb25zdCBldmVudFByb2Nlc3NpbmcgPSBvcHRzLmV2ZW50UHJvY2Vzc2luZztcbiAgICBjb25zdCB1c2VTaGFyZWRDbGllbnRBcGkgPSBvcHRzLnVzZVNoYXJlZENsaWVudEFwaSB8fCBmYWxzZTtcbiAgICBsZXQgaHR0cENsaWVudCA9IG5ldyBIdHRwQ2xpZW50KHJlcXVlc3RUaW1lb3V0LCByZXRyeU9wdHMpO1xuICAgIGxldCBoaXN0b3JpY2FsTWFya2V0RGF0YUh0dHBDbGllbnQgPSBuZXcgSHR0cENsaWVudChoaXN0b3JpY2FsTWFya2V0RGF0YVJlcXVlc3RUaW1lb3V0LCByZXRyeU9wdHMpO1xuICAgIGxldCBkZW1vQWNjb3VudEh0dHBDbGllbnQgPSBuZXcgSHR0cENsaWVudChkZW1vQWNjb3VudFJlcXVlc3RUaW1lb3V0LCByZXRyeU9wdHMpO1xuICAgIHRoaXMuX21ldGFBcGlXZWJzb2NrZXRDbGllbnQgPSBuZXcgTWV0YUFwaVdlYnNvY2tldENsaWVudChodHRwQ2xpZW50LCB0b2tlbiwge2FwcGxpY2F0aW9uLCBkb21haW4sIHJlcXVlc3RUaW1lb3V0LFxuICAgICAgY29ubmVjdFRpbWVvdXQsIHBhY2tldExvZ2dlciwgcGFja2V0T3JkZXJpbmdUaW1lb3V0LCBzeW5jaHJvbml6YXRpb25UaHJvdHRsZXIsIHJldHJ5T3B0cywgXG4gICAgICBldmVudFByb2Nlc3NpbmcsIHVzZVNoYXJlZENsaWVudEFwaX0pO1xuICAgIHRoaXMuX3Byb3Zpc2lvbmluZ1Byb2ZpbGVBcGkgPSBuZXcgUHJvdmlzaW9uaW5nUHJvZmlsZUFwaShuZXcgUHJvdmlzaW9uaW5nUHJvZmlsZUNsaWVudChodHRwQ2xpZW50LCB0b2tlbiwgZG9tYWluKSk7XG4gICAgdGhpcy5fY29ubmVjdGlvblJlZ2lzdHJ5ID0gbmV3IENvbm5lY3Rpb25SZWdpc3RyeSh0aGlzLl9tZXRhQXBpV2Vic29ja2V0Q2xpZW50LCBhcHBsaWNhdGlvbik7XG4gICAgbGV0IGhpc3RvcmljYWxNYXJrZXREYXRhQ2xpZW50ID0gbmV3IEhpc3RvcmljYWxNYXJrZXREYXRhQ2xpZW50KGhpc3RvcmljYWxNYXJrZXREYXRhSHR0cENsaWVudCwgdG9rZW4sIGRvbWFpbik7XG4gICAgdGhpcy5fbWV0YXRyYWRlckFjY291bnRBcGkgPSBuZXcgTWV0YXRyYWRlckFjY291bnRBcGkobmV3IE1ldGF0cmFkZXJBY2NvdW50Q2xpZW50KGh0dHBDbGllbnQsIHRva2VuLCBkb21haW4pLFxuICAgICAgdGhpcy5fbWV0YUFwaVdlYnNvY2tldENsaWVudCwgdGhpcy5fY29ubmVjdGlvblJlZ2lzdHJ5LCBcbiAgICAgIG5ldyBFeHBlcnRBZHZpc29yQ2xpZW50KGh0dHBDbGllbnQsIHRva2VuLCBkb21haW4pLCBoaXN0b3JpY2FsTWFya2V0RGF0YUNsaWVudCk7XG4gICAgdGhpcy5fbWV0YXRyYWRlckRlbW9BY2NvdW50QXBpID0gbmV3IE1ldGF0cmFkZXJEZW1vQWNjb3VudEFwaShcbiAgICAgIG5ldyBNZXRhdHJhZGVyRGVtb0FjY291bnRDbGllbnQoZGVtb0FjY291bnRIdHRwQ2xpZW50LCB0b2tlbiwgZG9tYWluKSk7XG4gICAgaWYgKG9wdHMuZW5hYmxlTGF0ZW5jeVRyYWNraW5nIHx8IG9wdHMuZW5hYmxlTGF0ZW5jeU1vbml0b3IpIHtcbiAgICAgIHRoaXMuX2xhdGVuY3lNb25pdG9yID0gbmV3IExhdGVuY3lNb25pdG9yKCk7XG4gICAgICB0aGlzLl9tZXRhQXBpV2Vic29ja2V0Q2xpZW50LmFkZExhdGVuY3lMaXN0ZW5lcih0aGlzLl9sYXRlbmN5TW9uaXRvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgcHJvdmlzaW9uaW5nIHByb2ZpbGUgQVBJXG4gICAqIEByZXR1cm5zIHtQcm92aXNpb25pbmdQcm9maWxlQXBpfSBwcm92aXNpb25pbmcgcHJvZmlsZSBBUElcbiAgICovXG4gIGdldCBwcm92aXNpb25pbmdQcm9maWxlQXBpKCkge1xuICAgIHJldHVybiB0aGlzLl9wcm92aXNpb25pbmdQcm9maWxlQXBpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgTWV0YVRyYWRlciBhY2NvdW50IEFQSVxuICAgKiBAcmV0dXJuIHtNZXRhdHJhZGVyQWNjb3VudEFwaX0gTWV0YVRyYWRlciBhY2NvdW50IEFQSVxuICAgKi9cbiAgZ2V0IG1ldGF0cmFkZXJBY2NvdW50QXBpKCkge1xuICAgIHJldHVybiB0aGlzLl9tZXRhdHJhZGVyQWNjb3VudEFwaTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIE1ldGFUcmFkZXIgZGVtbyBhY2NvdW50IEFQSVxuICAgKiBAcmV0dXJuIHtNZXRhdHJhZGVyRGVtb0FjY291bnRBcGl9IE1ldGFUcmFkZXIgZGVtbyBhY2NvdW50IEFQSVxuICAgKi9cbiAgZ2V0IG1ldGF0cmFkZXJEZW1vQWNjb3VudEFwaSgpIHtcbiAgICByZXR1cm4gdGhpcy5fbWV0YXRyYWRlckRlbW9BY2NvdW50QXBpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgTWV0YUFwaSBhcHBsaWNhdGlvbiBsYXRlbmN5IG1vbml0b3JcbiAgICogQHJldHVybiB7TGF0ZW5jeU1vbml0b3J9IGxhdGVuY3kgbW9uaXRvclxuICAgKi9cbiAgZ2V0IGxhdGVuY3lNb25pdG9yKCkge1xuICAgIHJldHVybiB0aGlzLl9sYXRlbmN5TW9uaXRvcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbG9zZXMgYWxsIGNsaWVudHMgYW5kIGNvbm5lY3Rpb25zXG4gICAqL1xuICBjbG9zZSgpIHtcbiAgICB0aGlzLl9tZXRhQXBpV2Vic29ja2V0Q2xpZW50LnJlbW92ZUxhdGVuY3lMaXN0ZW5lcih0aGlzLl9sYXRlbmN5TW9uaXRvcik7XG4gICAgdGhpcy5fbWV0YUFwaVdlYnNvY2tldENsaWVudC5jbG9zZSgpO1xuICB9XG5cbn1cbiJdfQ==