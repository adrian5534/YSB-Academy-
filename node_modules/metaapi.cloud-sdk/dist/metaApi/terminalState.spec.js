'use strict';

var _should = require('should');

var _should2 = _interopRequireDefault(_should);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _terminalState = require('./terminalState');

var _terminalState2 = _interopRequireDefault(_terminalState);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {TerminalState}
 */
describe('TerminalState', () => {

  let state;

  beforeEach(() => {
    state = new _terminalState2.default();
  });

  /**
   * @test {TerminalState#onConnected}
   * @test {TerminalState#onDisconnected}
   * @test {TerminalState#connected}
   */
  it('should return connection state', () => {
    state.connected.should.be.false();
    state.onConnected('1:ps-mpa-1');
    state.connected.should.be.true();
    state.onDisconnected('1:ps-mpa-1');
    state.connected.should.be.false();
  });

  /**
   * @test {TerminalState#onBrokerConnectionStatus}
   * @test {TerminalState#connectedToBroker}
   */
  it('should return broker connection state', async () => {
    const clock = _sinon2.default.useFakeTimers();
    state.connectedToBroker.should.be.false();
    state.onBrokerConnectionStatusChanged('1:ps-mpa-1', true);
    state.connectedToBroker.should.be.true();
    state.onBrokerConnectionStatusChanged('1:ps-mpa-1', false);
    state.connectedToBroker.should.be.false();
    state.onBrokerConnectionStatusChanged('1:ps-mpa-1', true);
    state.onDisconnected('1:ps-mpa-1');
    state.connectedToBroker.should.be.false();
    await clock.tickAsync(65000);
    clock.restore();
  });

  /**
   * @test {TerminalState#onAccountInformationUpdated}
   * @test {TerminalState#accountInformation}
   */
  it('should return account information', () => {
    _should2.default.not.exist(state.accountInformation);
    state.onAccountInformationUpdated('1:ps-mpa-1', { balance: 1000 });
    state.accountInformation.should.match({ balance: 1000 });
  });

  /**
   * @test {TerminalState#onPositionUpdated}
   * @test {TerminalState#onPositionRemoved}
   * @test {TerminalState#positions}
   */
  it('should return positions', () => {
    state.positions.length.should.equal(0);
    state.onPositionUpdated('1:ps-mpa-1', { id: '1', profit: 10 });
    state.onPositionUpdated('1:ps-mpa-1', { id: '2' });
    state.onPositionUpdated('1:ps-mpa-1', { id: '1', profit: 11 });
    state.onPositionRemoved('1:ps-mpa-1', '2');
    state.positions.length.should.equal(1);
    state.positions.should.match([{ id: '1', profit: 11 }]);
  });

  /**
   * @test {TerminalState#onOrderUpdated}
   * @test {TerminalState#onOrderCompleted}
   * @test {TerminalState#orders}
   */
  it('should return orders', async () => {
    state.orders.length.should.equal(0);
    await state.onOrderUpdated('1:ps-mpa-1', { id: '1', openPrice: 10 });
    await state.onOrderUpdated('1:ps-mpa-1', { id: '2' });
    await state.onOrderUpdated('1:ps-mpa-1', { id: '1', openPrice: 11 });
    state.orders.length.should.equal(2);
    await state.onOrderCompleted('1:ps-mpa-1', '2');
    state.orders.length.should.equal(1);
    state.orders.should.match([{ id: '1', openPrice: 11 }]);
  });

  /**
   * @test {TerminalState#onSymbolSpecificationsUpdated}
   * @test {TerminalState#specifications}
   * @test {TerminalState#specification}
   */
  it('should return specifications', () => {
    state.specifications.length.should.equal(0);
    state.onSymbolSpecificationsUpdated('1:ps-mpa-1', [{ symbol: 'EURUSD', tickSize: 0.00001 }, { symbol: 'GBPUSD' }], []);
    state.onSymbolSpecificationsUpdated('1:ps-mpa-1', [{ symbol: 'AUDNZD' }, { symbol: 'EURUSD',
      tickSize: 0.0001 }], ['AUDNZD']);
    state.specifications.length.should.equal(2);
    state.specifications.should.match([{ symbol: 'EURUSD', tickSize: 0.0001 }, { symbol: 'GBPUSD' }]);
    state.specification('EURUSD').should.match({ symbol: 'EURUSD', tickSize: 0.0001 });
  });

  /**
   * @test {TerminalState#onSymbolPricesUpdated}
   * @test {TerminalState#price}
   */
  it('should return price', () => {
    _should2.default.not.exist(state.price('EURUSD'));
    state.onSymbolPricesUpdated('1:ps-mpa-1', [{ time: new Date(), symbol: 'EURUSD', bid: 1, ask: 1.1 }]);
    state.onSymbolPricesUpdated('1:ps-mpa-1', [{ time: new Date(), symbol: 'GBPUSD' }]);
    state.onSymbolPricesUpdated('1:ps-mpa-1', [{ time: new Date(), symbol: 'EURUSD', bid: 1, ask: 1.2 }]);
    state.price('EURUSD').should.match({ symbol: 'EURUSD', bid: 1, ask: 1.2 });
  });

  /**
   * @test {TerminalState#onSymbolPricesUpdated}
   * @test {TerminalState#price}
   */
  it('should wait for price', async () => {
    _should2.default.not.exist(state.price('EURUSD'));
    let promise = state.waitForPrice('EURUSD');
    state.onSymbolPricesUpdated('1:ps-mpa-1', [{ time: new Date(), symbol: 'EURUSD', bid: 1, ask: 1.1 }]);
    (await promise).should.match({ symbol: 'EURUSD', bid: 1, ask: 1.1 });
  });

  /**
   * @test {TerminalState#onSymbolPricesUpdated}
   * @test {TerminalState#accountInformation}
   * @test {TerminalState#positions}
   */
  it('should update account equity and position profit on price update', () => {
    state.onAccountInformationUpdated('1:ps-mpa-1', { equity: 1000, balance: 800 });
    state.onPositionsReplaced('1:ps-mpa-1', [{
      id: '1',
      symbol: 'EURUSD',
      type: 'POSITION_TYPE_BUY',
      currentPrice: 9,
      currentTickValue: 0.5,
      openPrice: 8,
      profit: 100,
      volume: 2
    }]);
    state.onPositionUpdated('1:ps-mpa-1', {
      id: '2',
      symbol: 'AUDUSD',
      type: 'POSITION_TYPE_BUY',
      currentPrice: 9,
      currentTickValue: 0.5,
      openPrice: 8,
      profit: 100,
      volume: 2
    });
    state.onSymbolSpecificationsUpdated('1:ps-mpa-1', [{ symbol: 'EURUSD', tickSize: 0.01, digits: 5 }, { symbol: 'AUDUSD', tickSize: 0.01, digits: 5 }], []);
    state.onSymbolPricesUpdated('1:ps-mpa-1', [{
      time: new Date(),
      symbol: 'EURUSD',
      profitTickValue: 0.5,
      lossTickValue: 0.5,
      bid: 10,
      ask: 11
    }, {
      time: new Date(),
      symbol: 'AUDUSD',
      profitTickValue: 0.5,
      lossTickValue: 0.5,
      bid: 10,
      ask: 11
    }]);
    state.positions.map(p => p.profit).should.match([200, 200]);
    state.positions.map(p => p.unrealizedProfit).should.match([200, 200]);
    state.positions.map(p => p.currentPrice).should.match([10, 10]);
    state.accountInformation.equity.should.equal(1200);
  });

  /**
   * @test {TerminalState#onSymbolPricesUpdated}
   * @test {TerminalState#accountInformation}
   * @test {TerminalState#positions}
   */
  it('should update margin fields on price update', () => {
    state.onAccountInformationUpdated('1:ps-mpa-1', { equity: 1000, balance: 800 });
    state.onSymbolPricesUpdated('1:ps-mpa-1', [], 100, 200, 400, 40000);
    state.accountInformation.equity.should.equal(100);
    state.accountInformation.margin.should.equal(200);
    state.accountInformation.freeMargin.should.equal(400);
    state.accountInformation.marginLevel.should.equal(40000);
  });

  /**
   * @test {TerminalState#onSymbolPriceUpdated}
   * @test {TerminalState#orders}
   */
  it('should update order currentPrice on price update', () => {
    state.onOrderUpdated('1:ps-mpa-1', {
      id: '1',
      symbol: 'EURUSD',
      type: 'ORDER_TYPE_BUY_LIMIT',
      currentPrice: 9
    });
    state.onOrderUpdated('1:ps-mpa-1', {
      id: '2',
      symbol: 'AUDUSD',
      type: 'ORDER_TYPE_SELL_LIMIT',
      currentPrice: 9
    });
    state.onSymbolSpecificationsUpdated('1:ps-mpa-1', [{ symbol: 'EURUSD', tickSize: 0.01 }], []);
    state.onSymbolPricesUpdated('1:ps-mpa-1', [{
      time: new Date(),
      symbol: 'EURUSD',
      profitTickValue: 0.5,
      lossTickValue: 0.5,
      bid: 10,
      ask: 11
    }]);
    state.orders.map(o => o.currentPrice).should.match([11, 9]);
  });

  /**
   * @test {TerminalState#onStreamClosed}
   */
  it('should remove state on closed stream', async () => {
    _sinon2.default.assert.match(state.price('EURUSD'), undefined);
    await state.onSymbolPricesUpdated('1:ps-mpa-1', [{ time: new Date(), symbol: 'EURUSD', bid: 1, ask: 1.1 }]);
    _sinon2.default.assert.match(state.price('EURUSD'), { time: new Date(), symbol: 'EURUSD', bid: 1, ask: 1.1 });
    await state.onStreamClosed('1:ps-mpa-1');
    _sinon2.default.assert.match(state.price('EURUSD'), undefined);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL3Rlcm1pbmFsU3RhdGUuc3BlYy5lczYiXSwibmFtZXMiOlsiZGVzY3JpYmUiLCJzdGF0ZSIsImJlZm9yZUVhY2giLCJUZXJtaW5hbFN0YXRlIiwiaXQiLCJjb25uZWN0ZWQiLCJzaG91bGQiLCJiZSIsImZhbHNlIiwib25Db25uZWN0ZWQiLCJ0cnVlIiwib25EaXNjb25uZWN0ZWQiLCJjbG9jayIsInNpbm9uIiwidXNlRmFrZVRpbWVycyIsImNvbm5lY3RlZFRvQnJva2VyIiwib25Ccm9rZXJDb25uZWN0aW9uU3RhdHVzQ2hhbmdlZCIsInRpY2tBc3luYyIsInJlc3RvcmUiLCJub3QiLCJleGlzdCIsImFjY291bnRJbmZvcm1hdGlvbiIsIm9uQWNjb3VudEluZm9ybWF0aW9uVXBkYXRlZCIsImJhbGFuY2UiLCJtYXRjaCIsInBvc2l0aW9ucyIsImxlbmd0aCIsImVxdWFsIiwib25Qb3NpdGlvblVwZGF0ZWQiLCJpZCIsInByb2ZpdCIsIm9uUG9zaXRpb25SZW1vdmVkIiwib3JkZXJzIiwib25PcmRlclVwZGF0ZWQiLCJvcGVuUHJpY2UiLCJvbk9yZGVyQ29tcGxldGVkIiwic3BlY2lmaWNhdGlvbnMiLCJvblN5bWJvbFNwZWNpZmljYXRpb25zVXBkYXRlZCIsInN5bWJvbCIsInRpY2tTaXplIiwic3BlY2lmaWNhdGlvbiIsInByaWNlIiwib25TeW1ib2xQcmljZXNVcGRhdGVkIiwidGltZSIsIkRhdGUiLCJiaWQiLCJhc2siLCJwcm9taXNlIiwid2FpdEZvclByaWNlIiwiZXF1aXR5Iiwib25Qb3NpdGlvbnNSZXBsYWNlZCIsInR5cGUiLCJjdXJyZW50UHJpY2UiLCJjdXJyZW50VGlja1ZhbHVlIiwidm9sdW1lIiwiZGlnaXRzIiwicHJvZml0VGlja1ZhbHVlIiwibG9zc1RpY2tWYWx1ZSIsIm1hcCIsInAiLCJ1bnJlYWxpemVkUHJvZml0IiwibWFyZ2luIiwiZnJlZU1hcmdpbiIsIm1hcmdpbkxldmVsIiwibyIsImFzc2Vy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LE1BQU1rRSxjQUFOLENBQXFCLFlBQXJCLENBQU47QUFDQXRELG9CQUFNb0QsTUFBTixDQUFhekMsS0FBYixDQUFtQnZCLE1BQU13QyxLQUFOLENBQVksUUFBWixDQUFuQixFQUEwQ3lCLFNBQTFDO0FBQ0QsR0FORDtBQVFELENBak9EIiwiZmlsZSI6InRlcm1pbmFsU3RhdGUuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHNob3VsZCBmcm9tICdzaG91bGQnO1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCBUZXJtaW5hbFN0YXRlIGZyb20gJy4vdGVybWluYWxTdGF0ZSc7XG5cbi8qKlxuICogQHRlc3Qge1Rlcm1pbmFsU3RhdGV9XG4gKi9cbmRlc2NyaWJlKCdUZXJtaW5hbFN0YXRlJywgKCkgPT4ge1xuXG4gIGxldCBzdGF0ZTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBzdGF0ZSA9IG5ldyBUZXJtaW5hbFN0YXRlKCk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7VGVybWluYWxTdGF0ZSNvbkNvbm5lY3RlZH1cbiAgICogQHRlc3Qge1Rlcm1pbmFsU3RhdGUjb25EaXNjb25uZWN0ZWR9XG4gICAqIEB0ZXN0IHtUZXJtaW5hbFN0YXRlI2Nvbm5lY3RlZH1cbiAgICovXG4gIGl0KCdzaG91bGQgcmV0dXJuIGNvbm5lY3Rpb24gc3RhdGUnLCAoKSA9PiB7XG4gICAgc3RhdGUuY29ubmVjdGVkLnNob3VsZC5iZS5mYWxzZSgpO1xuICAgIHN0YXRlLm9uQ29ubmVjdGVkKCcxOnBzLW1wYS0xJyk7XG4gICAgc3RhdGUuY29ubmVjdGVkLnNob3VsZC5iZS50cnVlKCk7XG4gICAgc3RhdGUub25EaXNjb25uZWN0ZWQoJzE6cHMtbXBhLTEnKTtcbiAgICBzdGF0ZS5jb25uZWN0ZWQuc2hvdWxkLmJlLmZhbHNlKCk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7VGVybWluYWxTdGF0ZSNvbkJyb2tlckNvbm5lY3Rpb25TdGF0dXN9XG4gICAqIEB0ZXN0IHtUZXJtaW5hbFN0YXRlI2Nvbm5lY3RlZFRvQnJva2VyfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZXR1cm4gYnJva2VyIGNvbm5lY3Rpb24gc3RhdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgY2xvY2sgPSBzaW5vbi51c2VGYWtlVGltZXJzKCk7XG4gICAgc3RhdGUuY29ubmVjdGVkVG9Ccm9rZXIuc2hvdWxkLmJlLmZhbHNlKCk7XG4gICAgc3RhdGUub25Ccm9rZXJDb25uZWN0aW9uU3RhdHVzQ2hhbmdlZCgnMTpwcy1tcGEtMScsIHRydWUpO1xuICAgIHN0YXRlLmNvbm5lY3RlZFRvQnJva2VyLnNob3VsZC5iZS50cnVlKCk7XG4gICAgc3RhdGUub25Ccm9rZXJDb25uZWN0aW9uU3RhdHVzQ2hhbmdlZCgnMTpwcy1tcGEtMScsIGZhbHNlKTtcbiAgICBzdGF0ZS5jb25uZWN0ZWRUb0Jyb2tlci5zaG91bGQuYmUuZmFsc2UoKTtcbiAgICBzdGF0ZS5vbkJyb2tlckNvbm5lY3Rpb25TdGF0dXNDaGFuZ2VkKCcxOnBzLW1wYS0xJywgdHJ1ZSk7XG4gICAgc3RhdGUub25EaXNjb25uZWN0ZWQoJzE6cHMtbXBhLTEnKTtcbiAgICBzdGF0ZS5jb25uZWN0ZWRUb0Jyb2tlci5zaG91bGQuYmUuZmFsc2UoKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoNjUwMDApO1xuICAgIGNsb2NrLnJlc3RvcmUoKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtUZXJtaW5hbFN0YXRlI29uQWNjb3VudEluZm9ybWF0aW9uVXBkYXRlZH1cbiAgICogQHRlc3Qge1Rlcm1pbmFsU3RhdGUjYWNjb3VudEluZm9ybWF0aW9ufVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZXR1cm4gYWNjb3VudCBpbmZvcm1hdGlvbicsICgpID0+IHtcbiAgICBzaG91bGQubm90LmV4aXN0KHN0YXRlLmFjY291bnRJbmZvcm1hdGlvbik7XG4gICAgc3RhdGUub25BY2NvdW50SW5mb3JtYXRpb25VcGRhdGVkKCcxOnBzLW1wYS0xJywge2JhbGFuY2U6IDEwMDB9KTtcbiAgICBzdGF0ZS5hY2NvdW50SW5mb3JtYXRpb24uc2hvdWxkLm1hdGNoKHtiYWxhbmNlOiAxMDAwfSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7VGVybWluYWxTdGF0ZSNvblBvc2l0aW9uVXBkYXRlZH1cbiAgICogQHRlc3Qge1Rlcm1pbmFsU3RhdGUjb25Qb3NpdGlvblJlbW92ZWR9XG4gICAqIEB0ZXN0IHtUZXJtaW5hbFN0YXRlI3Bvc2l0aW9uc31cbiAgICovXG4gIGl0KCdzaG91bGQgcmV0dXJuIHBvc2l0aW9ucycsICgpID0+IHtcbiAgICBzdGF0ZS5wb3NpdGlvbnMubGVuZ3RoLnNob3VsZC5lcXVhbCgwKTtcbiAgICBzdGF0ZS5vblBvc2l0aW9uVXBkYXRlZCgnMTpwcy1tcGEtMScsIHtpZDogJzEnLCBwcm9maXQ6IDEwfSk7XG4gICAgc3RhdGUub25Qb3NpdGlvblVwZGF0ZWQoJzE6cHMtbXBhLTEnLCB7aWQ6ICcyJ30pO1xuICAgIHN0YXRlLm9uUG9zaXRpb25VcGRhdGVkKCcxOnBzLW1wYS0xJywge2lkOiAnMScsIHByb2ZpdDogMTF9KTtcbiAgICBzdGF0ZS5vblBvc2l0aW9uUmVtb3ZlZCgnMTpwcy1tcGEtMScsICcyJyk7XG4gICAgc3RhdGUucG9zaXRpb25zLmxlbmd0aC5zaG91bGQuZXF1YWwoMSk7XG4gICAgc3RhdGUucG9zaXRpb25zLnNob3VsZC5tYXRjaChbe2lkOiAnMScsIHByb2ZpdDogMTF9XSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7VGVybWluYWxTdGF0ZSNvbk9yZGVyVXBkYXRlZH1cbiAgICogQHRlc3Qge1Rlcm1pbmFsU3RhdGUjb25PcmRlckNvbXBsZXRlZH1cbiAgICogQHRlc3Qge1Rlcm1pbmFsU3RhdGUjb3JkZXJzfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZXR1cm4gb3JkZXJzJywgYXN5bmMgKCkgPT4ge1xuICAgIHN0YXRlLm9yZGVycy5sZW5ndGguc2hvdWxkLmVxdWFsKDApO1xuICAgIGF3YWl0IHN0YXRlLm9uT3JkZXJVcGRhdGVkKCcxOnBzLW1wYS0xJywge2lkOiAnMScsIG9wZW5QcmljZTogMTB9KTtcbiAgICBhd2FpdCBzdGF0ZS5vbk9yZGVyVXBkYXRlZCgnMTpwcy1tcGEtMScsIHtpZDogJzInfSk7XG4gICAgYXdhaXQgc3RhdGUub25PcmRlclVwZGF0ZWQoJzE6cHMtbXBhLTEnLCB7aWQ6ICcxJywgb3BlblByaWNlOiAxMX0pO1xuICAgIHN0YXRlLm9yZGVycy5sZW5ndGguc2hvdWxkLmVxdWFsKDIpO1xuICAgIGF3YWl0IHN0YXRlLm9uT3JkZXJDb21wbGV0ZWQoJzE6cHMtbXBhLTEnLCAnMicpO1xuICAgIHN0YXRlLm9yZGVycy5sZW5ndGguc2hvdWxkLmVxdWFsKDEpO1xuICAgIHN0YXRlLm9yZGVycy5zaG91bGQubWF0Y2goW3tpZDogJzEnLCBvcGVuUHJpY2U6IDExfV0pO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1Rlcm1pbmFsU3RhdGUjb25TeW1ib2xTcGVjaWZpY2F0aW9uc1VwZGF0ZWR9XG4gICAqIEB0ZXN0IHtUZXJtaW5hbFN0YXRlI3NwZWNpZmljYXRpb25zfVxuICAgKiBAdGVzdCB7VGVybWluYWxTdGF0ZSNzcGVjaWZpY2F0aW9ufVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZXR1cm4gc3BlY2lmaWNhdGlvbnMnLCAoKSA9PiB7XG4gICAgc3RhdGUuc3BlY2lmaWNhdGlvbnMubGVuZ3RoLnNob3VsZC5lcXVhbCgwKTtcbiAgICBzdGF0ZS5vblN5bWJvbFNwZWNpZmljYXRpb25zVXBkYXRlZCgnMTpwcy1tcGEtMScsIFt7c3ltYm9sOiAnRVVSVVNEJywgdGlja1NpemU6IDAuMDAwMDF9LCB7c3ltYm9sOiAnR0JQVVNEJ31dLCBbXSk7XG4gICAgc3RhdGUub25TeW1ib2xTcGVjaWZpY2F0aW9uc1VwZGF0ZWQoJzE6cHMtbXBhLTEnLCBbe3N5bWJvbDogJ0FVRE5aRCd9LCB7c3ltYm9sOiAnRVVSVVNEJywgXG4gICAgICB0aWNrU2l6ZTogMC4wMDAxfV0sIFsnQVVETlpEJ10pO1xuICAgIHN0YXRlLnNwZWNpZmljYXRpb25zLmxlbmd0aC5zaG91bGQuZXF1YWwoMik7XG4gICAgc3RhdGUuc3BlY2lmaWNhdGlvbnMuc2hvdWxkLm1hdGNoKFt7c3ltYm9sOiAnRVVSVVNEJywgdGlja1NpemU6IDAuMDAwMX0sIHtzeW1ib2w6ICdHQlBVU0QnfV0pO1xuICAgIHN0YXRlLnNwZWNpZmljYXRpb24oJ0VVUlVTRCcpLnNob3VsZC5tYXRjaCh7c3ltYm9sOiAnRVVSVVNEJywgdGlja1NpemU6IDAuMDAwMX0pO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1Rlcm1pbmFsU3RhdGUjb25TeW1ib2xQcmljZXNVcGRhdGVkfVxuICAgKiBAdGVzdCB7VGVybWluYWxTdGF0ZSNwcmljZX1cbiAgICovXG4gIGl0KCdzaG91bGQgcmV0dXJuIHByaWNlJywgKCkgPT4ge1xuICAgIHNob3VsZC5ub3QuZXhpc3Qoc3RhdGUucHJpY2UoJ0VVUlVTRCcpKTtcbiAgICBzdGF0ZS5vblN5bWJvbFByaWNlc1VwZGF0ZWQoJzE6cHMtbXBhLTEnLCBbe3RpbWU6IG5ldyBEYXRlKCksIHN5bWJvbDogJ0VVUlVTRCcsIGJpZDogMSwgYXNrOiAxLjF9XSk7XG4gICAgc3RhdGUub25TeW1ib2xQcmljZXNVcGRhdGVkKCcxOnBzLW1wYS0xJywgW3t0aW1lOiBuZXcgRGF0ZSgpLCBzeW1ib2w6ICdHQlBVU0QnfV0pO1xuICAgIHN0YXRlLm9uU3ltYm9sUHJpY2VzVXBkYXRlZCgnMTpwcy1tcGEtMScsIFt7dGltZTogbmV3IERhdGUoKSwgc3ltYm9sOiAnRVVSVVNEJywgYmlkOiAxLCBhc2s6IDEuMn1dKTtcbiAgICBzdGF0ZS5wcmljZSgnRVVSVVNEJykuc2hvdWxkLm1hdGNoKHtzeW1ib2w6ICdFVVJVU0QnLCBiaWQ6IDEsIGFzazogMS4yfSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7VGVybWluYWxTdGF0ZSNvblN5bWJvbFByaWNlc1VwZGF0ZWR9XG4gICAqIEB0ZXN0IHtUZXJtaW5hbFN0YXRlI3ByaWNlfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCB3YWl0IGZvciBwcmljZScsIGFzeW5jICgpID0+IHtcbiAgICBzaG91bGQubm90LmV4aXN0KHN0YXRlLnByaWNlKCdFVVJVU0QnKSk7XG4gICAgbGV0IHByb21pc2UgPSBzdGF0ZS53YWl0Rm9yUHJpY2UoJ0VVUlVTRCcpO1xuICAgIHN0YXRlLm9uU3ltYm9sUHJpY2VzVXBkYXRlZCgnMTpwcy1tcGEtMScsIFt7dGltZTogbmV3IERhdGUoKSwgc3ltYm9sOiAnRVVSVVNEJywgYmlkOiAxLCBhc2s6IDEuMX1dKTtcbiAgICAoYXdhaXQgcHJvbWlzZSkuc2hvdWxkLm1hdGNoKHtzeW1ib2w6ICdFVVJVU0QnLCBiaWQ6IDEsIGFzazogMS4xfSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7VGVybWluYWxTdGF0ZSNvblN5bWJvbFByaWNlc1VwZGF0ZWR9XG4gICAqIEB0ZXN0IHtUZXJtaW5hbFN0YXRlI2FjY291bnRJbmZvcm1hdGlvbn1cbiAgICogQHRlc3Qge1Rlcm1pbmFsU3RhdGUjcG9zaXRpb25zfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCB1cGRhdGUgYWNjb3VudCBlcXVpdHkgYW5kIHBvc2l0aW9uIHByb2ZpdCBvbiBwcmljZSB1cGRhdGUnLCAoKSA9PiB7XG4gICAgc3RhdGUub25BY2NvdW50SW5mb3JtYXRpb25VcGRhdGVkKCcxOnBzLW1wYS0xJywge2VxdWl0eTogMTAwMCwgYmFsYW5jZTogODAwfSk7XG4gICAgc3RhdGUub25Qb3NpdGlvbnNSZXBsYWNlZCgnMTpwcy1tcGEtMScsIFt7XG4gICAgICBpZDogJzEnLFxuICAgICAgc3ltYm9sOiAnRVVSVVNEJyxcbiAgICAgIHR5cGU6ICdQT1NJVElPTl9UWVBFX0JVWScsXG4gICAgICBjdXJyZW50UHJpY2U6IDksXG4gICAgICBjdXJyZW50VGlja1ZhbHVlOiAwLjUsXG4gICAgICBvcGVuUHJpY2U6IDgsXG4gICAgICBwcm9maXQ6IDEwMCxcbiAgICAgIHZvbHVtZTogMlxuICAgIH1dKTtcbiAgICBzdGF0ZS5vblBvc2l0aW9uVXBkYXRlZCgnMTpwcy1tcGEtMScsIHtcbiAgICAgIGlkOiAnMicsXG4gICAgICBzeW1ib2w6ICdBVURVU0QnLFxuICAgICAgdHlwZTogJ1BPU0lUSU9OX1RZUEVfQlVZJyxcbiAgICAgIGN1cnJlbnRQcmljZTogOSxcbiAgICAgIGN1cnJlbnRUaWNrVmFsdWU6IDAuNSxcbiAgICAgIG9wZW5QcmljZTogOCxcbiAgICAgIHByb2ZpdDogMTAwLFxuICAgICAgdm9sdW1lOiAyXG4gICAgfSk7XG4gICAgc3RhdGUub25TeW1ib2xTcGVjaWZpY2F0aW9uc1VwZGF0ZWQoJzE6cHMtbXBhLTEnLCBbe3N5bWJvbDogJ0VVUlVTRCcsIHRpY2tTaXplOiAwLjAxLCBkaWdpdHM6IDV9LFxuICAgICAge3N5bWJvbDogJ0FVRFVTRCcsIHRpY2tTaXplOiAwLjAxLCBkaWdpdHM6IDV9XSwgW10pO1xuICAgIHN0YXRlLm9uU3ltYm9sUHJpY2VzVXBkYXRlZCgnMTpwcy1tcGEtMScsIFtcbiAgICAgIHtcbiAgICAgICAgdGltZTogbmV3IERhdGUoKSxcbiAgICAgICAgc3ltYm9sOiAnRVVSVVNEJyxcbiAgICAgICAgcHJvZml0VGlja1ZhbHVlOiAwLjUsXG4gICAgICAgIGxvc3NUaWNrVmFsdWU6IDAuNSxcbiAgICAgICAgYmlkOiAxMCxcbiAgICAgICAgYXNrOiAxMVxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdGltZTogbmV3IERhdGUoKSxcbiAgICAgICAgc3ltYm9sOiAnQVVEVVNEJyxcbiAgICAgICAgcHJvZml0VGlja1ZhbHVlOiAwLjUsXG4gICAgICAgIGxvc3NUaWNrVmFsdWU6IDAuNSxcbiAgICAgICAgYmlkOiAxMCxcbiAgICAgICAgYXNrOiAxMVxuICAgICAgfVxuICAgIF0pO1xuICAgIHN0YXRlLnBvc2l0aW9ucy5tYXAocCA9PiBwLnByb2ZpdCkuc2hvdWxkLm1hdGNoKFsyMDAsIDIwMF0pO1xuICAgIHN0YXRlLnBvc2l0aW9ucy5tYXAocCA9PiBwLnVucmVhbGl6ZWRQcm9maXQpLnNob3VsZC5tYXRjaChbMjAwLCAyMDBdKTtcbiAgICBzdGF0ZS5wb3NpdGlvbnMubWFwKHAgPT4gcC5jdXJyZW50UHJpY2UpLnNob3VsZC5tYXRjaChbMTAsIDEwXSk7XG4gICAgc3RhdGUuYWNjb3VudEluZm9ybWF0aW9uLmVxdWl0eS5zaG91bGQuZXF1YWwoMTIwMCk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7VGVybWluYWxTdGF0ZSNvblN5bWJvbFByaWNlc1VwZGF0ZWR9XG4gICAqIEB0ZXN0IHtUZXJtaW5hbFN0YXRlI2FjY291bnRJbmZvcm1hdGlvbn1cbiAgICogQHRlc3Qge1Rlcm1pbmFsU3RhdGUjcG9zaXRpb25zfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCB1cGRhdGUgbWFyZ2luIGZpZWxkcyBvbiBwcmljZSB1cGRhdGUnLCAoKSA9PiB7XG4gICAgc3RhdGUub25BY2NvdW50SW5mb3JtYXRpb25VcGRhdGVkKCcxOnBzLW1wYS0xJywge2VxdWl0eTogMTAwMCwgYmFsYW5jZTogODAwfSk7XG4gICAgc3RhdGUub25TeW1ib2xQcmljZXNVcGRhdGVkKCcxOnBzLW1wYS0xJywgW10sIDEwMCwgMjAwLCA0MDAsIDQwMDAwKTtcbiAgICBzdGF0ZS5hY2NvdW50SW5mb3JtYXRpb24uZXF1aXR5LnNob3VsZC5lcXVhbCgxMDApO1xuICAgIHN0YXRlLmFjY291bnRJbmZvcm1hdGlvbi5tYXJnaW4uc2hvdWxkLmVxdWFsKDIwMCk7XG4gICAgc3RhdGUuYWNjb3VudEluZm9ybWF0aW9uLmZyZWVNYXJnaW4uc2hvdWxkLmVxdWFsKDQwMCk7XG4gICAgc3RhdGUuYWNjb3VudEluZm9ybWF0aW9uLm1hcmdpbkxldmVsLnNob3VsZC5lcXVhbCg0MDAwMCk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7VGVybWluYWxTdGF0ZSNvblN5bWJvbFByaWNlVXBkYXRlZH1cbiAgICogQHRlc3Qge1Rlcm1pbmFsU3RhdGUjb3JkZXJzfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCB1cGRhdGUgb3JkZXIgY3VycmVudFByaWNlIG9uIHByaWNlIHVwZGF0ZScsICgpID0+IHtcbiAgICBzdGF0ZS5vbk9yZGVyVXBkYXRlZCgnMTpwcy1tcGEtMScsIHtcbiAgICAgIGlkOiAnMScsXG4gICAgICBzeW1ib2w6ICdFVVJVU0QnLFxuICAgICAgdHlwZTogJ09SREVSX1RZUEVfQlVZX0xJTUlUJyxcbiAgICAgIGN1cnJlbnRQcmljZTogOVxuICAgIH0pO1xuICAgIHN0YXRlLm9uT3JkZXJVcGRhdGVkKCcxOnBzLW1wYS0xJywge1xuICAgICAgaWQ6ICcyJyxcbiAgICAgIHN5bWJvbDogJ0FVRFVTRCcsXG4gICAgICB0eXBlOiAnT1JERVJfVFlQRV9TRUxMX0xJTUlUJyxcbiAgICAgIGN1cnJlbnRQcmljZTogOVxuICAgIH0pO1xuICAgIHN0YXRlLm9uU3ltYm9sU3BlY2lmaWNhdGlvbnNVcGRhdGVkKCcxOnBzLW1wYS0xJywgW3tzeW1ib2w6ICdFVVJVU0QnLCB0aWNrU2l6ZTogMC4wMX1dLCBbXSk7XG4gICAgc3RhdGUub25TeW1ib2xQcmljZXNVcGRhdGVkKCcxOnBzLW1wYS0xJywgW3tcbiAgICAgIHRpbWU6IG5ldyBEYXRlKCksXG4gICAgICBzeW1ib2w6ICdFVVJVU0QnLFxuICAgICAgcHJvZml0VGlja1ZhbHVlOiAwLjUsXG4gICAgICBsb3NzVGlja1ZhbHVlOiAwLjUsXG4gICAgICBiaWQ6IDEwLFxuICAgICAgYXNrOiAxMVxuICAgIH1dKTtcbiAgICBzdGF0ZS5vcmRlcnMubWFwKG8gPT4gby5jdXJyZW50UHJpY2UpLnNob3VsZC5tYXRjaChbMTEsIDldKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtUZXJtaW5hbFN0YXRlI29uU3RyZWFtQ2xvc2VkfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZW1vdmUgc3RhdGUgb24gY2xvc2VkIHN0cmVhbScsIGFzeW5jICgpID0+IHtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2goc3RhdGUucHJpY2UoJ0VVUlVTRCcpLCB1bmRlZmluZWQpO1xuICAgIGF3YWl0IHN0YXRlLm9uU3ltYm9sUHJpY2VzVXBkYXRlZCgnMTpwcy1tcGEtMScsIFt7dGltZTogbmV3IERhdGUoKSwgc3ltYm9sOiAnRVVSVVNEJywgYmlkOiAxLCBhc2s6IDEuMX1dKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2goc3RhdGUucHJpY2UoJ0VVUlVTRCcpLCB7dGltZTogbmV3IERhdGUoKSwgc3ltYm9sOiAnRVVSVVNEJywgYmlkOiAxLCBhc2s6IDEuMX0pO1xuICAgIGF3YWl0IHN0YXRlLm9uU3RyZWFtQ2xvc2VkKCcxOnBzLW1wYS0xJyk7XG4gICAgc2lub24uYXNzZXJ0Lm1hdGNoKHN0YXRlLnByaWNlKCdFVVJVU0QnKSwgdW5kZWZpbmVkKTtcbiAgfSk7XG5cbn0pO1xuIl19