'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

var _synchronizationListener = require('../clients/metaApi/synchronizationListener');

var _synchronizationListener2 = _interopRequireDefault(_synchronizationListener);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Abstract class which defines MetaTrader history storage interface.
 */
class HistoryStorage extends _synchronizationListener2.default {

  /**
   * Constructs the history storage
   */
  constructor() {
    super();
    this._orderSynchronizationFinished = {};
    this._dealSynchronizationFinished = {};
  }

  /**
   * Initializes the storage and loads required data from a persistent storage
   */
  async initialize() {}

  /**
   * Returns flag indicating whether order history synchronization have finished
   * @return {Boolean} flag indicating whether order history synchronization have finished
   */
  get orderSynchronizationFinished() {
    return (0, _values2.default)(this._orderSynchronizationFinished).reduce((acc, r) => acc || r, false);
  }

  /**
   * Returns flag indicating whether deal history synchronization have finished
   * @return {Boolean} flag indicating whether deal history synchronization have finished
   */
  get dealSynchronizationFinished() {
    return (0, _values2.default)(this._dealSynchronizationFinished).reduce((acc, r) => acc || r, false);
  }

  /**
   * Clears the storage and deletes persistent data
   */
  async clear() {
    throw Error('Abstract method clear has no implementation');
  }

  /**
   * Returns the time of the last history order record stored in the history storage
   * @param {String} [instanceIndex] index of an account instance connected
   * @returns {Date} the time of the last history order record stored in the history storage
   */
  async lastHistoryOrderTime(instanceIndex) {
    throw Error('Abstract method lastHistoryOrderTime has no implementation');
  }

  /**
   * Returns the time of the last history deal record stored in the history storage
   * @param {String} [instanceIndex] index of an account instance connected
   * @returns {Date} the time of the last history deal record stored in the history storage
   */
  async lastDealTime(instanceIndex) {
    throw Error('Abstract method lastDealTime has no implementation');
  }

  /**
   * Invoked when a new MetaTrader history order is added
   * @param {String} instanceIndex index of an account instance connected
   * @param {MetatraderOrder} historyOrder new MetaTrader history order
   * @return {Promise} promise which resolves when the asynchronous event is processed
   */
  async onHistoryOrderAdded(instanceIndex, historyOrder) {
    throw Error('Abstract method onHistoryOrderAdded has no implementation');
  }

  /**
   * Invoked when a new MetaTrader history deal is added
   * @param {String} instanceIndex index of an account instance connected
   * @param {MetatraderDeal} deal new MetaTrader history deal
   * @return {Promise} promise which resolves when the asynchronous event is processed
   */
  async onDealAdded(instanceIndex, deal) {
    throw Error('Abstract method onDealAdded has no implementation');
  }

  /**
   * Invoked when a synchronization of history deals on a MetaTrader account have finished
   * @param {String} instanceIndex index of an account instance connected
   */
  onDealSynchronizationFinished(instanceIndex) {
    const instance = this.getInstanceNumber(instanceIndex);
    this._dealSynchronizationFinished['' + instance] = true;
  }

  /**
   * Invoked when a synchronization of history orders on a MetaTrader account have finished
   * @param {String} instanceIndex index of an account instance connected
   */
  onOrderSynchronizationFinished(instanceIndex) {
    const instance = this.getInstanceNumber(instanceIndex);
    this._orderSynchronizationFinished['' + instance] = true;
  }

  /**
   * Invoked when connection to MetaTrader terminal established
   * @param {String} instanceIndex index of an account instance connected
   */
  onConnected(instanceIndex) {
    const instance = this.getInstanceNumber(instanceIndex);
    this._orderSynchronizationFinished['' + instance] = false;
    this._dealSynchronizationFinished['' + instance] = false;
  }

}
exports.default = HistoryStorage;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL2hpc3RvcnlTdG9yYWdlLmVzNiJdLCJuYW1lcyI6WyJIaXN0b3J5U3RvcmFnZSIsIlN5bmNocm9uaXphdGlvbkxpc3RlbmVyIiwiY29uc3RydWN0b3IiLCJfb3JkZXJTeW5jaHJvbml6YXRpb25GaW5pc2hlZCIsIl9kZWFsU3luY2hyb25pemF0aW9uRmluaXNoZWQiLCJpbml0aWFsaXplIiwib3JkZXJTeW5jaHJvbml6YXRpb25GaW5pc2hlZCIsInJlZHVjZSIsImFjYyIsInIiLCJkZWFsU3luY2hyb25pemF0aW9uRmluaXNoZWQiLCJjbGVhciIsIkVycm9yIiwibGFzdEhpc3RvcnlPcmRlclRpbWUiLCJpbnN0YW5jZUluZGV4IiwibGFzdERlYWxUaW1lIiwib25IaXN0b3J5T3JkZXJBZGRlZCIsImhpc3RvcnlPcmRlciIsIm9uRGVhbEFkZGVkIiwiZGVhbCIsIm9uRGVhbFN5bmNocm9uaXphdGlvbkZpbmlzaGVkIiwiaW5zdGFuY2UiLCJnZXRJbnN0YW5jZU51bWJlciIsIm9uT3JkZXJTeW5jaHJvbml6YXRpb25GaW5pc2hlZCIsIm9uQ29ubmVjdGVkIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7OztBQUVBOzs7Ozs7QUFFQTs7O0FBR2UsTUFBTUEsY0FBTixTQUE2QkMsaUNBQTdCLENBQXFEOztBQUVsRTs7O0FBR0FDLGdCQUFjO0FBQ1o7QUFDQSxTQUFLQyw2QkFBTCxHQUFxQyxFQUFyQztBQUNBLFNBQUtDLDRCQUFMLEdBQW9DLEVBQXBDO0FBQ0Q7O0FBRUQ7OztBQUdBLFFBQU1DLFVBQU4sR0FBbUIsQ0FBRTs7QUFFckI7Ozs7QUFJQSxNQUFJQyw0QkFBSixHQUFtQztBQUNqQyxXQUFPLHNCQUFjLEtBQUtILDZCQUFuQixFQUFrREksTUFBbEQsQ0FBeUQsQ0FBQ0MsR0FBRCxFQUFNQyxDQUFOLEtBQVlELE9BQU9DLENBQTVFLEVBQStFLEtBQS9FLENBQVA7QUFDRDs7QUFFRDs7OztBQUlBLE1BQUlDLDJCQUFKLEdBQWtDO0FBQ2hDLFdBQU8sc0JBQWMsS0FBS04sNEJBQW5CLEVBQWlERyxNQUFqRCxDQUF3RCxDQUFDQyxHQUFELEVBQU1DLENBQU4sS0FBWUQsT0FBT0MsQ0FBM0UsRUFBOEUsS0FBOUUsQ0FBUDtBQUNEOztBQUVEOzs7QUFHQSxRQUFNRSxLQUFOLEdBQWE7QUFDWCxVQUFNQyxNQUFNLDZDQUFOLENBQU47QUFDRDs7QUFFRDs7Ozs7QUFLQSxRQUFNQyxvQkFBTixDQUEyQkMsYUFBM0IsRUFBMEM7QUFDeEMsVUFBTUYsTUFBTSw0REFBTixDQUFOO0FBQ0Q7O0FBRUQ7Ozs7O0FBS0EsUUFBTUcsWUFBTixDQUFtQkQsYUFBbkIsRUFBa0M7QUFDaEMsVUFBTUYsTUFBTSxvREFBTixDQUFOO0FBQ0Q7O0FBRUQ7Ozs7OztBQU1BLFFBQU1JLG1CQUFOLENBQTBCRixhQUExQixFQUF5Q0csWUFBekMsRUFBdUQ7QUFDckQsVUFBTUwsTUFBTSwyREFBTixDQUFOO0FBQ0Q7O0FBRUQ7Ozs7OztBQU1BLFFBQU1NLFdBQU4sQ0FBa0JKLGFBQWxCLEVBQWlDSyxJQUFqQyxFQUF1QztBQUNyQyxVQUFNUCxNQUFNLG1EQUFOLENBQU47QUFDRDs7QUFFRDs7OztBQUlBUSxnQ0FBOEJOLGFBQTlCLEVBQTZDO0FBQzNDLFVBQU1PLFdBQVcsS0FBS0MsaUJBQUwsQ0FBdUJSLGFBQXZCLENBQWpCO0FBQ0EsU0FBS1YsNEJBQUwsQ0FBa0MsS0FBS2lCLFFBQXZDLElBQW1ELElBQW5EO0FBQ0Q7O0FBRUQ7Ozs7QUFJQUUsaUNBQStCVCxhQUEvQixFQUE4QztBQUM1QyxVQUFNTyxXQUFXLEtBQUtDLGlCQUFMLENBQXVCUixhQUF2QixDQUFqQjtBQUNBLFNBQUtYLDZCQUFMLENBQW1DLEtBQUtrQixRQUF4QyxJQUFvRCxJQUFwRDtBQUNEOztBQUVEOzs7O0FBSUFHLGNBQVlWLGFBQVosRUFBMkI7QUFDekIsVUFBTU8sV0FBVyxLQUFLQyxpQkFBTCxDQUF1QlIsYUFBdkIsQ0FBakI7QUFDQSxTQUFLWCw2QkFBTCxDQUFtQyxLQUFLa0IsUUFBeEMsSUFBb0QsS0FBcEQ7QUFDQSxTQUFLakIsNEJBQUwsQ0FBa0MsS0FBS2lCLFFBQXZDLElBQW1ELEtBQW5EO0FBQ0Q7O0FBdkdpRTtrQkFBL0NyQixjIiwiZmlsZSI6Imhpc3RvcnlTdG9yYWdlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgU3luY2hyb25pemF0aW9uTGlzdGVuZXIgZnJvbSAnLi4vY2xpZW50cy9tZXRhQXBpL3N5bmNocm9uaXphdGlvbkxpc3RlbmVyJztcblxuLyoqXG4gKiBBYnN0cmFjdCBjbGFzcyB3aGljaCBkZWZpbmVzIE1ldGFUcmFkZXIgaGlzdG9yeSBzdG9yYWdlIGludGVyZmFjZS5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSGlzdG9yeVN0b3JhZ2UgZXh0ZW5kcyBTeW5jaHJvbml6YXRpb25MaXN0ZW5lciB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgdGhlIGhpc3Rvcnkgc3RvcmFnZVxuICAgKi9cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9vcmRlclN5bmNocm9uaXphdGlvbkZpbmlzaGVkID0ge307XG4gICAgdGhpcy5fZGVhbFN5bmNocm9uaXphdGlvbkZpbmlzaGVkID0ge307XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZXMgdGhlIHN0b3JhZ2UgYW5kIGxvYWRzIHJlcXVpcmVkIGRhdGEgZnJvbSBhIHBlcnNpc3RlbnQgc3RvcmFnZVxuICAgKi9cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpIHt9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgZmxhZyBpbmRpY2F0aW5nIHdoZXRoZXIgb3JkZXIgaGlzdG9yeSBzeW5jaHJvbml6YXRpb24gaGF2ZSBmaW5pc2hlZFxuICAgKiBAcmV0dXJuIHtCb29sZWFufSBmbGFnIGluZGljYXRpbmcgd2hldGhlciBvcmRlciBoaXN0b3J5IHN5bmNocm9uaXphdGlvbiBoYXZlIGZpbmlzaGVkXG4gICAqL1xuICBnZXQgb3JkZXJTeW5jaHJvbml6YXRpb25GaW5pc2hlZCgpIHtcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLl9vcmRlclN5bmNocm9uaXphdGlvbkZpbmlzaGVkKS5yZWR1Y2UoKGFjYywgcikgPT4gYWNjIHx8IHIsIGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGZsYWcgaW5kaWNhdGluZyB3aGV0aGVyIGRlYWwgaGlzdG9yeSBzeW5jaHJvbml6YXRpb24gaGF2ZSBmaW5pc2hlZFxuICAgKiBAcmV0dXJuIHtCb29sZWFufSBmbGFnIGluZGljYXRpbmcgd2hldGhlciBkZWFsIGhpc3Rvcnkgc3luY2hyb25pemF0aW9uIGhhdmUgZmluaXNoZWRcbiAgICovXG4gIGdldCBkZWFsU3luY2hyb25pemF0aW9uRmluaXNoZWQoKSB7XG4gICAgcmV0dXJuIE9iamVjdC52YWx1ZXModGhpcy5fZGVhbFN5bmNocm9uaXphdGlvbkZpbmlzaGVkKS5yZWR1Y2UoKGFjYywgcikgPT4gYWNjIHx8IHIsIGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhcnMgdGhlIHN0b3JhZ2UgYW5kIGRlbGV0ZXMgcGVyc2lzdGVudCBkYXRhXG4gICAqL1xuICBhc3luYyBjbGVhcigpe1xuICAgIHRocm93IEVycm9yKCdBYnN0cmFjdCBtZXRob2QgY2xlYXIgaGFzIG5vIGltcGxlbWVudGF0aW9uJyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgdGltZSBvZiB0aGUgbGFzdCBoaXN0b3J5IG9yZGVyIHJlY29yZCBzdG9yZWQgaW4gdGhlIGhpc3Rvcnkgc3RvcmFnZVxuICAgKiBAcGFyYW0ge1N0cmluZ30gW2luc3RhbmNlSW5kZXhdIGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqIEByZXR1cm5zIHtEYXRlfSB0aGUgdGltZSBvZiB0aGUgbGFzdCBoaXN0b3J5IG9yZGVyIHJlY29yZCBzdG9yZWQgaW4gdGhlIGhpc3Rvcnkgc3RvcmFnZVxuICAgKi9cbiAgYXN5bmMgbGFzdEhpc3RvcnlPcmRlclRpbWUoaW5zdGFuY2VJbmRleCkge1xuICAgIHRocm93IEVycm9yKCdBYnN0cmFjdCBtZXRob2QgbGFzdEhpc3RvcnlPcmRlclRpbWUgaGFzIG5vIGltcGxlbWVudGF0aW9uJyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgdGltZSBvZiB0aGUgbGFzdCBoaXN0b3J5IGRlYWwgcmVjb3JkIHN0b3JlZCBpbiB0aGUgaGlzdG9yeSBzdG9yYWdlXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBbaW5zdGFuY2VJbmRleF0gaW5kZXggb2YgYW4gYWNjb3VudCBpbnN0YW5jZSBjb25uZWN0ZWRcbiAgICogQHJldHVybnMge0RhdGV9IHRoZSB0aW1lIG9mIHRoZSBsYXN0IGhpc3RvcnkgZGVhbCByZWNvcmQgc3RvcmVkIGluIHRoZSBoaXN0b3J5IHN0b3JhZ2VcbiAgICovXG4gIGFzeW5jIGxhc3REZWFsVGltZShpbnN0YW5jZUluZGV4KSB7XG4gICAgdGhyb3cgRXJyb3IoJ0Fic3RyYWN0IG1ldGhvZCBsYXN0RGVhbFRpbWUgaGFzIG5vIGltcGxlbWVudGF0aW9uJyk7XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGEgbmV3IE1ldGFUcmFkZXIgaGlzdG9yeSBvcmRlciBpcyBhZGRlZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJbmRleCBpbmRleCBvZiBhbiBhY2NvdW50IGluc3RhbmNlIGNvbm5lY3RlZFxuICAgKiBAcGFyYW0ge01ldGF0cmFkZXJPcmRlcn0gaGlzdG9yeU9yZGVyIG5ldyBNZXRhVHJhZGVyIGhpc3Rvcnkgb3JkZXJcbiAgICogQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB3aGljaCByZXNvbHZlcyB3aGVuIHRoZSBhc3luY2hyb25vdXMgZXZlbnQgaXMgcHJvY2Vzc2VkXG4gICAqL1xuICBhc3luYyBvbkhpc3RvcnlPcmRlckFkZGVkKGluc3RhbmNlSW5kZXgsIGhpc3RvcnlPcmRlcikge1xuICAgIHRocm93IEVycm9yKCdBYnN0cmFjdCBtZXRob2Qgb25IaXN0b3J5T3JkZXJBZGRlZCBoYXMgbm8gaW1wbGVtZW50YXRpb24nKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gYSBuZXcgTWV0YVRyYWRlciBoaXN0b3J5IGRlYWwgaXMgYWRkZWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlSW5kZXggaW5kZXggb2YgYW4gYWNjb3VudCBpbnN0YW5jZSBjb25uZWN0ZWRcbiAgICogQHBhcmFtIHtNZXRhdHJhZGVyRGVhbH0gZGVhbCBuZXcgTWV0YVRyYWRlciBoaXN0b3J5IGRlYWxcbiAgICogQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB3aGljaCByZXNvbHZlcyB3aGVuIHRoZSBhc3luY2hyb25vdXMgZXZlbnQgaXMgcHJvY2Vzc2VkXG4gICAqL1xuICBhc3luYyBvbkRlYWxBZGRlZChpbnN0YW5jZUluZGV4LCBkZWFsKSB7XG4gICAgdGhyb3cgRXJyb3IoJ0Fic3RyYWN0IG1ldGhvZCBvbkRlYWxBZGRlZCBoYXMgbm8gaW1wbGVtZW50YXRpb24nKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gYSBzeW5jaHJvbml6YXRpb24gb2YgaGlzdG9yeSBkZWFscyBvbiBhIE1ldGFUcmFkZXIgYWNjb3VudCBoYXZlIGZpbmlzaGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZUluZGV4IGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqL1xuICBvbkRlYWxTeW5jaHJvbml6YXRpb25GaW5pc2hlZChpbnN0YW5jZUluZGV4KSB7XG4gICAgY29uc3QgaW5zdGFuY2UgPSB0aGlzLmdldEluc3RhbmNlTnVtYmVyKGluc3RhbmNlSW5kZXgpO1xuICAgIHRoaXMuX2RlYWxTeW5jaHJvbml6YXRpb25GaW5pc2hlZFsnJyArIGluc3RhbmNlXSA9IHRydWU7XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGEgc3luY2hyb25pemF0aW9uIG9mIGhpc3Rvcnkgb3JkZXJzIG9uIGEgTWV0YVRyYWRlciBhY2NvdW50IGhhdmUgZmluaXNoZWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlSW5kZXggaW5kZXggb2YgYW4gYWNjb3VudCBpbnN0YW5jZSBjb25uZWN0ZWRcbiAgICovXG4gIG9uT3JkZXJTeW5jaHJvbml6YXRpb25GaW5pc2hlZChpbnN0YW5jZUluZGV4KSB7XG4gICAgY29uc3QgaW5zdGFuY2UgPSB0aGlzLmdldEluc3RhbmNlTnVtYmVyKGluc3RhbmNlSW5kZXgpO1xuICAgIHRoaXMuX29yZGVyU3luY2hyb25pemF0aW9uRmluaXNoZWRbJycgKyBpbnN0YW5jZV0gPSB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEludm9rZWQgd2hlbiBjb25uZWN0aW9uIHRvIE1ldGFUcmFkZXIgdGVybWluYWwgZXN0YWJsaXNoZWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlSW5kZXggaW5kZXggb2YgYW4gYWNjb3VudCBpbnN0YW5jZSBjb25uZWN0ZWRcbiAgICovXG4gIG9uQ29ubmVjdGVkKGluc3RhbmNlSW5kZXgpIHtcbiAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMuZ2V0SW5zdGFuY2VOdW1iZXIoaW5zdGFuY2VJbmRleCk7XG4gICAgdGhpcy5fb3JkZXJTeW5jaHJvbml6YXRpb25GaW5pc2hlZFsnJyArIGluc3RhbmNlXSA9IGZhbHNlO1xuICAgIHRoaXMuX2RlYWxTeW5jaHJvbml6YXRpb25GaW5pc2hlZFsnJyArIGluc3RhbmNlXSA9IGZhbHNlO1xuICB9XG5cbn1cbiJdfQ==