'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _moment = require('moment');

var _moment2 = _interopRequireDefault(_moment);

var _optionsValidator = require('../optionsValidator');

var _optionsValidator2 = _interopRequireDefault(_optionsValidator);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Packet logger options
 * @typedef {Object} PacketLoggerOpts
 * @property {Boolean} [enabled] whether packet logger is enabled
 * @property {Number} [fileNumberLimit] maximum amount of files per account, default value is 12
 * @property {Number} [logFileSizeInHours] amount of logged hours per account file, default value is 4
 * @property {Boolean} [compressSpecifications] whether to compress specifications packets, default value is true
 * @property {Boolean} [compressPrices] whether to compress specifications packets, default value is true
 */

/**
 * A class which records packets into log files
 */
class PacketLogger {

  /**
   * Constructs the class
   * @param {PacketLoggerOpts} opts packet logger options
   */
  constructor(opts) {
    const validator = new _optionsValidator2.default();
    opts = opts || {};
    this._fileNumberLimit = validator.validateNonZero(opts.fileNumberLimit, 12, 'packetLogger.fileNumberLimit');
    this._logFileSizeInHours = validator.validateNonZero(opts.logFileSizeInHours, 4, 'packetLogger.logFileSizeInHours');
    this._compressSpecifications = validator.validateBoolean(opts.compressSpecifications, true, 'packetLogger.compressSpecifications');
    this._compressPrices = validator.validateBoolean(opts.compressPrices, true, 'packetLogger.compressPrices');
    this._previousPrices = {};
    this._lastSNPacket = {};
    this._writeQueue = {};
    this._root = './.metaapi/logs';
    _fsExtra2.default.ensureDir(this._root);
  }

  _ensurePreviousPriceObject(accountId) {
    if (!this._previousPrices[accountId]) {
      this._previousPrices[accountId] = {};
    }
  }

  /**
   * Processes packets and pushes them into save queue
   * @param {Object} packet packet to log
   */
  // eslint-disable-next-line complexity
  logPacket(packet) {
    const instanceIndex = packet.instanceIndex || 0;
    if (!this._writeQueue[packet.accountId]) {
      this._writeQueue[packet.accountId] = { isWriting: false, queue: [] };
    }
    if (packet.type === 'status') {
      return;
    }
    if (!this._lastSNPacket[packet.accountId]) {
      this._lastSNPacket[packet.accountId] = {};
    }
    if (['keepalive', 'noop'].includes(packet.type)) {
      this._lastSNPacket[packet.accountId][instanceIndex] = packet;
      return;
    }
    const queue = this._writeQueue[packet.accountId].queue;
    if (!this._previousPrices[packet.accountId]) {
      this._previousPrices[packet.accountId] = {};
    }

    const prevPrice = this._previousPrices[packet.accountId][instanceIndex];

    if (packet.type !== 'prices') {
      if (prevPrice) {
        this._recordPrices(packet.accountId, instanceIndex);
      }
      if (packet.type === 'specifications' && this._compressSpecifications) {
        queue.push((0, _stringify2.default)({ type: packet.type, sequenceNumber: packet.sequenceNumber,
          sequenceTimestamp: packet.sequenceTimestamp, instanceIndex }));
      } else {
        queue.push((0, _stringify2.default)(packet));
      }
    } else {
      if (!this._compressPrices) {
        queue.push((0, _stringify2.default)(packet));
      } else {
        if (prevPrice) {
          const validSequenceNumbers = [prevPrice.last.sequenceNumber, prevPrice.last.sequenceNumber + 1];
          if (this._lastSNPacket[packet.accountId][instanceIndex]) {
            validSequenceNumbers.push(this._lastSNPacket[packet.accountId][instanceIndex].sequenceNumber + 1);
          }
          if (!validSequenceNumbers.includes(packet.sequenceNumber)) {
            this._recordPrices(packet.accountId, instanceIndex);
            this._ensurePreviousPriceObject(packet.accountId);
            this._previousPrices[packet.accountId][instanceIndex] = { first: packet, last: packet };
            queue.push((0, _stringify2.default)(packet));
          } else {
            this._previousPrices[packet.accountId][instanceIndex].last = packet;
          }
        } else {
          this._ensurePreviousPriceObject(packet.accountId);
          this._previousPrices[packet.accountId][instanceIndex] = { first: packet, last: packet };
          queue.push((0, _stringify2.default)(packet));
        }
      }
    }
  }

  /**
   * Returns log messages within date bounds as an array of objects
   * @param {String} accountId account id 
   * @param {Date} dateAfter date to get logs after
   * @param {Date} dateBefore date to get logs before
   * @returns {Array<Object>} log messages
   */
  async readLogs(accountId, dateAfter, dateBefore) {
    const folders = await _fsExtra2.default.readdir(this._root);
    const packets = [];
    for (let folder of folders) {
      const filePath = `${this._root}/${folder}/${accountId}.log`;
      if (await _fsExtra2.default.pathExists(filePath)) {
        const contents = await _fsExtra2.default.readFile(filePath, 'utf8');
        let messages = contents.split('\r\n').filter(message => message.length).map(message => {
          return { date: new Date(message.slice(1, 24)), message: message.slice(26) };
        });
        if (dateAfter) {
          messages = messages.filter(message => message.date > dateAfter);
        }
        if (dateBefore) {
          messages = messages.filter(message => message.date < dateBefore);
        }
        packets.push(...messages);
      }
    }

    return packets;
  }

  /**
   * Returns path for account log file
   * @param {String} accountId account id
   * @returns {String} file path
   */
  async getFilePath(accountId) {
    const fileIndex = Math.floor(new Date().getHours() / this._logFileSizeInHours);
    const folderName = `${(0, _moment2.default)().format('YYYY-MM-DD')}-${fileIndex > 9 ? fileIndex : '0' + fileIndex}`;
    await _fsExtra2.default.ensureDir(`${this._root}/${folderName}`);
    return `${this._root}/${folderName}/${accountId}.log`;
  }

  /**
   * Initializes the packet logger
   */
  start() {
    this._previousPrices = {};
    if (!this._recordInteval) {
      this._recordInteval = setInterval(() => this._appendLogs(), 1000);
      this._deleteOldLogsInterval = setInterval(() => this._deleteOldData(), 10000);
    }
  }

  /**
   * Deinitializes the packet logger
   */
  stop() {
    clearInterval(this._recordInteval);
    clearInterval(this._deleteOldLogsInterval);
  }

  /**
   * Records price packet messages to log files
   * @param {String} accountId account id
   */
  _recordPrices(accountId, instanceNumber) {
    const prevPrice = this._previousPrices[accountId][instanceNumber] || { first: {}, last: {} };
    const queue = this._writeQueue[accountId].queue;
    delete this._previousPrices[accountId][instanceNumber];
    if (!(0, _keys2.default)(this._previousPrices[accountId]).length) {
      delete this._previousPrices[accountId];
    }
    if (prevPrice.first.sequenceNumber !== prevPrice.last.sequenceNumber) {
      queue.push((0, _stringify2.default)(prevPrice.last));
      queue.push(`Recorded price packets ${prevPrice.first.sequenceNumber}` + `-${prevPrice.last.sequenceNumber}, instanceIndex: ${instanceNumber}`);
    }
  }

  /**
   * Writes logs to files
   */
  async _appendLogs() {
    (0, _keys2.default)(this._writeQueue).forEach(async key => {
      const queue = this._writeQueue[key];
      if (!queue.isWriting && queue.queue.length) {
        queue.isWriting = true;
        try {
          const filePath = await this.getFilePath(key);
          const writeString = queue.queue.reduce((a, b) => a + `[${(0, _moment2.default)().format('YYYY-MM-DD HH:mm:ss.SSS')}] ${b}\r\n`, '');
          queue.queue = [];
          await _fsExtra2.default.appendFile(filePath, writeString);
        } catch (err) {
          console.log('Error writing log', err);
        }
        queue.isWriting = false;
      }
    });
  }

  /**
   * Deletes folders when the folder limit is exceeded
   */
  async _deleteOldData() {
    const contents = await _fsExtra2.default.readdir(this._root);
    contents.reverse().slice(this._fileNumberLimit).forEach(async folderName => {
      await _fsExtra2.default.remove(`${this._root}/${folderName}`);
    });
  }

}
exports.default = PacketLogger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL21ldGFBcGkvcGFja2V0TG9nZ2VyLmVzNiJdLCJuYW1lcyI6WyJQYWNrZXRMb2dnZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJ2YWxpZGF0b3IiLCJPcHRpb25zVmFsaWRhdG9yIiwiX2ZpbGVOdW1iZXJMaW1pdCIsInZhbGlkYXRlTm9uWmVybyIsImZpbGVOdW1iZXJMaW1pdCIsIl9sb2dGaWxlU2l6ZUluSG91cnMiLCJsb2dGaWxlU2l6ZUluSG91cnMiLCJfY29tcHJlc3NTcGVjaWZpY2F0aW9ucyIsInZhbGlkYXRlQm9vbGVhbiIsImNvbXByZXNzU3BlY2lmaWNhdGlvbnMiLCJfY29tcHJlc3NQcmljZXMiLCJjb21wcmVzc1ByaWNlcyIsIl9wcmV2aW91c1ByaWNlcyIsIl9sYXN0U05QYWNrZXQiLCJfd3JpdGVRdWV1ZSIsIl9yb290IiwiZnMiLCJlbnN1cmVEaXIiLCJfZW5zdXJlUHJldmlvdXNQcmljZU9iamVjdCIsImFjY291bnRJZCIsImxvZ1BhY2tldCIsInBhY2tldCIsImluc3RhbmNlSW5kZXgiLCJpc1dyaXRpbmciLCJxdWV1ZSIsInR5cGUiLCJpbmNsdWRlcyIsInByZXZQcmljZSIsIl9yZWNvcmRQcmljZXMiLCJwdXNoIiwic2VxdWVuY2VOdW1iZXIiLCJzZXF1ZW5jZVRpbWVzdGFtcCIsInZhbGlkU2VxdWVuY2VOdW1iZXJzIiwibGFzdCIsImZpcnN0IiwicmVhZExvZ3MiLCJkYXRlQWZ0ZXIiLCJkYXRlQmVmb3JlIiwiZm9sZGVycyIsInJlYWRkaXIiLCJwYWNrZXRzIiwiZm9sZGVyIiwiZmlsZVBhdGgiLCJwYXRoRXhpc3RzIiwiY29udGVudHMiLCJyZWFkRmlsZSIsIm1lc3NhZ2VzIiwic3BsaXQiLCJmaWx0ZXIiLCJtZXNzYWdlIiwibGVuZ3RoIiwibWFwIiwiZGF0ZSIsIkRhdGUiLCJzbGljZSIsImdldEZpbGVQYXRoIiwiZmlsZUluZGV4IiwiTWF0aCIsImZsb29yIiwiZ2V0SG91cnMiLCJmb2xkZXJOYW1lIiwiZm9ybWF0Iiwic3RhcnQiLCJfcmVjb3JkSW50ZXZhbCIsInNldEludGVydmFsIiwiX2FwcGVuZExvZ3MiLCJfZGVsZXRlT2xkTG9nc0ludGVydmFsIiwiX2RlbGV0ZU9sZERhdGEiLCJzdG9wIiwiY2xlYXJJbnRlcnZhbCIsImluc3RhbmNlTnVtYmVyIiwiZm9yRWFjaCIsImtleSIsIndyaXRlU3RyaW5nIiwicmVkdWNlIiwiYSIsImIiLCJhcHBlbmRGaWxlIiwiZXJyIiwiY29uc29sZSIsImxvZyIsInJldmVyc2UiLCJyZW1vdmUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUE7Ozs7Ozs7Ozs7QUFVQTs7O0FBR2UsTUFBTUEsWUFBTixDQUFtQjs7QUFFaEM7Ozs7QUFJQUMsY0FBWUMsSUFBWixFQUFrQjtBQUNoQixVQUFNQyxZQUFZLElBQUlDLDBCQUFKLEVBQWxCO0FBQ0FGLFdBQU9BLFFBQVEsRUFBZjtBQUNBLFNBQUtHLGdCQUFMLEdBQXdCRixVQUFVRyxlQUFWLENBQTBCSixLQUFLSyxlQUEvQixFQUFnRCxFQUFoRCxFQUFvRCw4QkFBcEQsQ0FBeEI7QUFDQSxTQUFLQyxtQkFBTCxHQUEyQkwsVUFBVUcsZUFBVixDQUEwQkosS0FBS08sa0JBQS9CLEVBQW1ELENBQW5ELEVBQ3pCLGlDQUR5QixDQUEzQjtBQUVBLFNBQUtDLHVCQUFMLEdBQStCUCxVQUFVUSxlQUFWLENBQTBCVCxLQUFLVSxzQkFBL0IsRUFBdUQsSUFBdkQsRUFDN0IscUNBRDZCLENBQS9CO0FBRUEsU0FBS0MsZUFBTCxHQUF3QlYsVUFBVVEsZUFBVixDQUEwQlQsS0FBS1ksY0FBL0IsRUFBK0MsSUFBL0MsRUFBcUQsNkJBQXJELENBQXhCO0FBQ0EsU0FBS0MsZUFBTCxHQUF1QixFQUF2QjtBQUNBLFNBQUtDLGFBQUwsR0FBcUIsRUFBckI7QUFDQSxTQUFLQyxXQUFMLEdBQW1CLEVBQW5CO0FBQ0EsU0FBS0MsS0FBTCxHQUFhLGlCQUFiO0FB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b3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xuaW1wb3J0IE9wdGlvbnNWYWxpZGF0b3IgZnJvbSAnLi4vb3B0aW9uc1ZhbGlkYXRvcic7XG5cbi8qKlxuICogUGFja2V0IGxvZ2dlciBvcHRpb25zXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBQYWNrZXRMb2dnZXJPcHRzXG4gKiBAcHJvcGVydHkge0Jvb2xlYW59IFtlbmFibGVkXSB3aGV0aGVyIHBhY2tldCBsb2dnZXIgaXMgZW5hYmxlZFxuICogQHByb3BlcnR5IHtOdW1iZXJ9IFtmaWxlTnVtYmVyTGltaXRdIG1heGltdW0gYW1vdW50IG9mIGZpbGVzIHBlciBhY2NvdW50LCBkZWZhdWx0IHZhbHVlIGlzIDEyXG4gKiBAcHJvcGVydHkge051bWJlcn0gW2xvZ0ZpbGVTaXplSW5Ib3Vyc10gYW1vdW50IG9mIGxvZ2dlZCBob3VycyBwZXIgYWNjb3VudCBmaWxlLCBkZWZhdWx0IHZhbHVlIGlzIDRcbiAqIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gW2NvbXByZXNzU3BlY2lmaWNhdGlvbnNdIHdoZXRoZXIgdG8gY29tcHJlc3Mgc3BlY2lmaWNhdGlvbnMgcGFja2V0cywgZGVmYXVsdCB2YWx1ZSBpcyB0cnVlXG4gKiBAcHJvcGVydHkge0Jvb2xlYW59IFtjb21wcmVzc1ByaWNlc10gd2hldGhlciB0byBjb21wcmVzcyBzcGVjaWZpY2F0aW9ucyBwYWNrZXRzLCBkZWZhdWx0IHZhbHVlIGlzIHRydWVcbiAqL1xuXG4vKipcbiAqIEEgY2xhc3Mgd2hpY2ggcmVjb3JkcyBwYWNrZXRzIGludG8gbG9nIGZpbGVzXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBhY2tldExvZ2dlciB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgdGhlIGNsYXNzXG4gICAqIEBwYXJhbSB7UGFja2V0TG9nZ2VyT3B0c30gb3B0cyBwYWNrZXQgbG9nZ2VyIG9wdGlvbnNcbiAgICovXG4gIGNvbnN0cnVjdG9yKG9wdHMpIHtcbiAgICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgT3B0aW9uc1ZhbGlkYXRvcigpO1xuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xuICAgIHRoaXMuX2ZpbGVOdW1iZXJMaW1pdCA9IHZhbGlkYXRvci52YWxpZGF0ZU5vblplcm8ob3B0cy5maWxlTnVtYmVyTGltaXQsIDEyLCAncGFja2V0TG9nZ2VyLmZpbGVOdW1iZXJMaW1pdCcpO1xuICAgIHRoaXMuX2xvZ0ZpbGVTaXplSW5Ib3VycyA9IHZhbGlkYXRvci52YWxpZGF0ZU5vblplcm8ob3B0cy5sb2dGaWxlU2l6ZUluSG91cnMsIDQsXG4gICAgICAncGFja2V0TG9nZ2VyLmxvZ0ZpbGVTaXplSW5Ib3VycycpO1xuICAgIHRoaXMuX2NvbXByZXNzU3BlY2lmaWNhdGlvbnMgPSB2YWxpZGF0b3IudmFsaWRhdGVCb29sZWFuKG9wdHMuY29tcHJlc3NTcGVjaWZpY2F0aW9ucywgdHJ1ZSxcbiAgICAgICdwYWNrZXRMb2dnZXIuY29tcHJlc3NTcGVjaWZpY2F0aW9ucycpO1xuICAgIHRoaXMuX2NvbXByZXNzUHJpY2VzID0gIHZhbGlkYXRvci52YWxpZGF0ZUJvb2xlYW4ob3B0cy5jb21wcmVzc1ByaWNlcywgdHJ1ZSwgJ3BhY2tldExvZ2dlci5jb21wcmVzc1ByaWNlcycpO1xuICAgIHRoaXMuX3ByZXZpb3VzUHJpY2VzID0ge307XG4gICAgdGhpcy5fbGFzdFNOUGFja2V0ID0ge307XG4gICAgdGhpcy5fd3JpdGVRdWV1ZSA9IHt9O1xuICAgIHRoaXMuX3Jvb3QgPSAnLi8ubWV0YWFwaS9sb2dzJztcbiAgICBmcy5lbnN1cmVEaXIodGhpcy5fcm9vdCk7XG4gIH1cblxuICBfZW5zdXJlUHJldmlvdXNQcmljZU9iamVjdChhY2NvdW50SWQpIHtcbiAgICBpZighdGhpcy5fcHJldmlvdXNQcmljZXNbYWNjb3VudElkXSkge1xuICAgICAgdGhpcy5fcHJldmlvdXNQcmljZXNbYWNjb3VudElkXSA9IHt9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQcm9jZXNzZXMgcGFja2V0cyBhbmQgcHVzaGVzIHRoZW0gaW50byBzYXZlIHF1ZXVlXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwYWNrZXQgcGFja2V0IHRvIGxvZ1xuICAgKi9cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbXBsZXhpdHlcbiAgbG9nUGFja2V0KHBhY2tldCkge1xuICAgIGNvbnN0IGluc3RhbmNlSW5kZXggPSBwYWNrZXQuaW5zdGFuY2VJbmRleCB8fCAwO1xuICAgIGlmKCF0aGlzLl93cml0ZVF1ZXVlW3BhY2tldC5hY2NvdW50SWRdKSB7XG4gICAgICB0aGlzLl93cml0ZVF1ZXVlW3BhY2tldC5hY2NvdW50SWRdID0ge2lzV3JpdGluZzogZmFsc2UsIHF1ZXVlOiBbXX07XG4gICAgfVxuICAgIGlmKHBhY2tldC50eXBlID09PSAnc3RhdHVzJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZighdGhpcy5fbGFzdFNOUGFja2V0W3BhY2tldC5hY2NvdW50SWRdKSB7XG4gICAgICB0aGlzLl9sYXN0U05QYWNrZXRbcGFja2V0LmFjY291bnRJZF0gPSB7fTtcbiAgICB9XG4gICAgaWYoWydrZWVwYWxpdmUnLCAnbm9vcCddLmluY2x1ZGVzKHBhY2tldC50eXBlKSkge1xuICAgICAgdGhpcy5fbGFzdFNOUGFja2V0W3BhY2tldC5hY2NvdW50SWRdW2luc3RhbmNlSW5kZXhdID0gcGFja2V0O1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBxdWV1ZSA9IHRoaXMuX3dyaXRlUXVldWVbcGFja2V0LmFjY291bnRJZF0ucXVldWU7XG4gICAgaWYoIXRoaXMuX3ByZXZpb3VzUHJpY2VzW3BhY2tldC5hY2NvdW50SWRdKSB7XG4gICAgICB0aGlzLl9wcmV2aW91c1ByaWNlc1twYWNrZXQuYWNjb3VudElkXSA9IHt9O1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBwcmV2UHJpY2UgPSB0aGlzLl9wcmV2aW91c1ByaWNlc1twYWNrZXQuYWNjb3VudElkXVtpbnN0YW5jZUluZGV4XTtcbiAgICBcbiAgICBpZihwYWNrZXQudHlwZSAhPT0gJ3ByaWNlcycpIHtcbiAgICAgIGlmKHByZXZQcmljZSkge1xuICAgICAgICB0aGlzLl9yZWNvcmRQcmljZXMocGFja2V0LmFjY291bnRJZCwgaW5zdGFuY2VJbmRleCk7XG4gICAgICB9XG4gICAgICBpZihwYWNrZXQudHlwZSA9PT0gJ3NwZWNpZmljYXRpb25zJyAmJiB0aGlzLl9jb21wcmVzc1NwZWNpZmljYXRpb25zKSB7XG4gICAgICAgIHF1ZXVlLnB1c2goSlNPTi5zdHJpbmdpZnkoe3R5cGU6IHBhY2tldC50eXBlLCBzZXF1ZW5jZU51bWJlcjogcGFja2V0LnNlcXVlbmNlTnVtYmVyLCBcbiAgICAgICAgICBzZXF1ZW5jZVRpbWVzdGFtcDogcGFja2V0LnNlcXVlbmNlVGltZXN0YW1wLCBpbnN0YW5jZUluZGV4fSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcXVldWUucHVzaChKU09OLnN0cmluZ2lmeShwYWNrZXQpKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYoIXRoaXMuX2NvbXByZXNzUHJpY2VzKSB7XG4gICAgICAgIHF1ZXVlLnB1c2goSlNPTi5zdHJpbmdpZnkocGFja2V0KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZihwcmV2UHJpY2UpIHtcbiAgICAgICAgICBjb25zdCB2YWxpZFNlcXVlbmNlTnVtYmVycyA9IFtwcmV2UHJpY2UubGFzdC5zZXF1ZW5jZU51bWJlciwgcHJldlByaWNlLmxhc3Quc2VxdWVuY2VOdW1iZXIgKyAxXTtcbiAgICAgICAgICBpZih0aGlzLl9sYXN0U05QYWNrZXRbcGFja2V0LmFjY291bnRJZF1baW5zdGFuY2VJbmRleF0pIHtcbiAgICAgICAgICAgIHZhbGlkU2VxdWVuY2VOdW1iZXJzLnB1c2godGhpcy5fbGFzdFNOUGFja2V0W3BhY2tldC5hY2NvdW50SWRdW2luc3RhbmNlSW5kZXhdLnNlcXVlbmNlTnVtYmVyICsgMSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmKCF2YWxpZFNlcXVlbmNlTnVtYmVycy5pbmNsdWRlcyhwYWNrZXQuc2VxdWVuY2VOdW1iZXIpKSB7XG4gICAgICAgICAgICB0aGlzLl9yZWNvcmRQcmljZXMocGFja2V0LmFjY291bnRJZCwgaW5zdGFuY2VJbmRleCk7XG4gICAgICAgICAgICB0aGlzLl9lbnN1cmVQcmV2aW91c1ByaWNlT2JqZWN0KHBhY2tldC5hY2NvdW50SWQpO1xuICAgICAgICAgICAgdGhpcy5fcHJldmlvdXNQcmljZXNbcGFja2V0LmFjY291bnRJZF1baW5zdGFuY2VJbmRleF0gPSB7Zmlyc3Q6IHBhY2tldCwgbGFzdDogcGFja2V0fTtcbiAgICAgICAgICAgIHF1ZXVlLnB1c2goSlNPTi5zdHJpbmdpZnkocGFja2V0KSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3ByZXZpb3VzUHJpY2VzW3BhY2tldC5hY2NvdW50SWRdW2luc3RhbmNlSW5kZXhdLmxhc3QgPSBwYWNrZXQ7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuX2Vuc3VyZVByZXZpb3VzUHJpY2VPYmplY3QocGFja2V0LmFjY291bnRJZCk7XG4gICAgICAgICAgdGhpcy5fcHJldmlvdXNQcmljZXNbcGFja2V0LmFjY291bnRJZF1baW5zdGFuY2VJbmRleF0gPSB7Zmlyc3Q6IHBhY2tldCwgbGFzdDogcGFja2V0fTtcbiAgICAgICAgICBxdWV1ZS5wdXNoKEpTT04uc3RyaW5naWZ5KHBhY2tldCkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgbG9nIG1lc3NhZ2VzIHdpdGhpbiBkYXRlIGJvdW5kcyBhcyBhbiBhcnJheSBvZiBvYmplY3RzXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgYWNjb3VudCBpZCBcbiAgICogQHBhcmFtIHtEYXRlfSBkYXRlQWZ0ZXIgZGF0ZSB0byBnZXQgbG9ncyBhZnRlclxuICAgKiBAcGFyYW0ge0RhdGV9IGRhdGVCZWZvcmUgZGF0ZSB0byBnZXQgbG9ncyBiZWZvcmVcbiAgICogQHJldHVybnMge0FycmF5PE9iamVjdD59IGxvZyBtZXNzYWdlc1xuICAgKi9cbiAgYXN5bmMgcmVhZExvZ3MoYWNjb3VudElkLCBkYXRlQWZ0ZXIsIGRhdGVCZWZvcmUpIHtcbiAgICBjb25zdCBmb2xkZXJzID0gYXdhaXQgZnMucmVhZGRpcih0aGlzLl9yb290KTtcbiAgICBjb25zdCBwYWNrZXRzID0gW107XG4gICAgZm9yIChsZXQgZm9sZGVyIG9mIGZvbGRlcnMpIHtcbiAgICAgIGNvbnN0IGZpbGVQYXRoID0gYCR7dGhpcy5fcm9vdH0vJHtmb2xkZXJ9LyR7YWNjb3VudElkfS5sb2dgO1xuICAgICAgaWYoYXdhaXQgZnMucGF0aEV4aXN0cyhmaWxlUGF0aCkpIHtcbiAgICAgICAgY29uc3QgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShmaWxlUGF0aCwgJ3V0ZjgnKTtcbiAgICAgICAgbGV0IG1lc3NhZ2VzID0gY29udGVudHMuc3BsaXQoJ1xcclxcbicpLmZpbHRlcihtZXNzYWdlID0+IG1lc3NhZ2UubGVuZ3RoKS5tYXAobWVzc2FnZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtkYXRlOiBuZXcgRGF0ZShtZXNzYWdlLnNsaWNlKDEsIDI0KSksIG1lc3NhZ2U6IG1lc3NhZ2Uuc2xpY2UoMjYpfTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmKGRhdGVBZnRlcikge1xuICAgICAgICAgIG1lc3NhZ2VzID0gbWVzc2FnZXMuZmlsdGVyKG1lc3NhZ2UgPT4gbWVzc2FnZS5kYXRlID4gZGF0ZUFmdGVyKTtcbiAgICAgICAgfVxuICAgICAgICBpZihkYXRlQmVmb3JlKSB7XG4gICAgICAgICAgbWVzc2FnZXMgPSBtZXNzYWdlcy5maWx0ZXIobWVzc2FnZSA9PiBtZXNzYWdlLmRhdGUgPCBkYXRlQmVmb3JlKTtcbiAgICAgICAgfVxuICAgICAgICBwYWNrZXRzLnB1c2goLi4ubWVzc2FnZXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBwYWNrZXRzO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgcGF0aCBmb3IgYWNjb3VudCBsb2cgZmlsZVxuICAgKiBAcGFyYW0ge1N0cmluZ30gYWNjb3VudElkIGFjY291bnQgaWRcbiAgICogQHJldHVybnMge1N0cmluZ30gZmlsZSBwYXRoXG4gICAqL1xuICBhc3luYyBnZXRGaWxlUGF0aChhY2NvdW50SWQpIHtcbiAgICBjb25zdCBmaWxlSW5kZXggPSBNYXRoLmZsb29yKG5ldyBEYXRlKCkuZ2V0SG91cnMoKSAvIHRoaXMuX2xvZ0ZpbGVTaXplSW5Ib3Vycyk7XG4gICAgY29uc3QgZm9sZGVyTmFtZSA9IGAke21vbWVudCgpLmZvcm1hdCgnWVlZWS1NTS1ERCcpfS0ke2ZpbGVJbmRleCA+IDkgPyBmaWxlSW5kZXggOiAnMCcgKyBmaWxlSW5kZXh9YDtcbiAgICBhd2FpdCBmcy5lbnN1cmVEaXIoYCR7dGhpcy5fcm9vdH0vJHtmb2xkZXJOYW1lfWApO1xuICAgIHJldHVybiBgJHt0aGlzLl9yb290fS8ke2ZvbGRlck5hbWV9LyR7YWNjb3VudElkfS5sb2dgO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemVzIHRoZSBwYWNrZXQgbG9nZ2VyXG4gICAqL1xuICBzdGFydCgpIHtcbiAgICB0aGlzLl9wcmV2aW91c1ByaWNlcyA9IHt9O1xuICAgIGlmICghdGhpcy5fcmVjb3JkSW50ZXZhbCkge1xuICAgICAgdGhpcy5fcmVjb3JkSW50ZXZhbCA9IHNldEludGVydmFsKCgpID0+IHRoaXMuX2FwcGVuZExvZ3MoKSwgMTAwMCk7XG4gICAgICB0aGlzLl9kZWxldGVPbGRMb2dzSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzLl9kZWxldGVPbGREYXRhKCksIDEwMDAwKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGVpbml0aWFsaXplcyB0aGUgcGFja2V0IGxvZ2dlclxuICAgKi9cbiAgc3RvcCgpIHtcbiAgICBjbGVhckludGVydmFsKHRoaXMuX3JlY29yZEludGV2YWwpO1xuICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fZGVsZXRlT2xkTG9nc0ludGVydmFsKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWNvcmRzIHByaWNlIHBhY2tldCBtZXNzYWdlcyB0byBsb2cgZmlsZXNcbiAgICogQHBhcmFtIHtTdHJpbmd9IGFjY291bnRJZCBhY2NvdW50IGlkXG4gICAqL1xuICBfcmVjb3JkUHJpY2VzKGFjY291bnRJZCwgaW5zdGFuY2VOdW1iZXIpIHtcbiAgICBjb25zdCBwcmV2UHJpY2UgPSB0aGlzLl9wcmV2aW91c1ByaWNlc1thY2NvdW50SWRdW2luc3RhbmNlTnVtYmVyXSB8fCB7Zmlyc3Q6IHt9LCBsYXN0Ont9fTtcbiAgICBjb25zdCBxdWV1ZSA9IHRoaXMuX3dyaXRlUXVldWVbYWNjb3VudElkXS5xdWV1ZTtcbiAgICBkZWxldGUgdGhpcy5fcHJldmlvdXNQcmljZXNbYWNjb3VudElkXVtpbnN0YW5jZU51bWJlcl07XG4gICAgaWYoIU9iamVjdC5rZXlzKHRoaXMuX3ByZXZpb3VzUHJpY2VzW2FjY291bnRJZF0pLmxlbmd0aCkge1xuICAgICAgZGVsZXRlIHRoaXMuX3ByZXZpb3VzUHJpY2VzW2FjY291bnRJZF07XG4gICAgfVxuICAgIGlmKHByZXZQcmljZS5maXJzdC5zZXF1ZW5jZU51bWJlciAhPT0gcHJldlByaWNlLmxhc3Quc2VxdWVuY2VOdW1iZXIpIHtcbiAgICAgIHF1ZXVlLnB1c2goSlNPTi5zdHJpbmdpZnkocHJldlByaWNlLmxhc3QpKTtcbiAgICAgIHF1ZXVlLnB1c2goYFJlY29yZGVkIHByaWNlIHBhY2tldHMgJHtwcmV2UHJpY2UuZmlyc3Quc2VxdWVuY2VOdW1iZXJ9YCArXG4gICAgICAgIGAtJHtwcmV2UHJpY2UubGFzdC5zZXF1ZW5jZU51bWJlcn0sIGluc3RhbmNlSW5kZXg6ICR7aW5zdGFuY2VOdW1iZXJ9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFdyaXRlcyBsb2dzIHRvIGZpbGVzXG4gICAqL1xuICBhc3luYyBfYXBwZW5kTG9ncygpIHtcbiAgICBPYmplY3Qua2V5cyh0aGlzLl93cml0ZVF1ZXVlKS5mb3JFYWNoKGFzeW5jIGtleSA9PiB7XG4gICAgICBjb25zdCBxdWV1ZSA9IHRoaXMuX3dyaXRlUXVldWVba2V5XTtcbiAgICAgIGlmICghcXVldWUuaXNXcml0aW5nICYmIHF1ZXVlLnF1ZXVlLmxlbmd0aCkge1xuICAgICAgICBxdWV1ZS5pc1dyaXRpbmcgPSB0cnVlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gYXdhaXQgdGhpcy5nZXRGaWxlUGF0aChrZXkpO1xuICAgICAgICAgIGNvbnN0IHdyaXRlU3RyaW5nID0gcXVldWUucXVldWUucmVkdWNlKChhLGIpID0+IGEgKyBcbiAgICAgICAgICBgWyR7bW9tZW50KCkuZm9ybWF0KCdZWVlZLU1NLUREIEhIOm1tOnNzLlNTUycpfV0gJHtifVxcclxcbmAgLCcnKTtcbiAgICAgICAgICBxdWV1ZS5xdWV1ZSA9IFtdO1xuICAgICAgICAgIGF3YWl0IGZzLmFwcGVuZEZpbGUoZmlsZVBhdGgsIHdyaXRlU3RyaW5nKTsgIFxuICAgICAgICB9IGNhdGNoKGVycikge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciB3cml0aW5nIGxvZycsIGVycik7XG4gICAgICAgIH1cbiAgICAgICAgcXVldWUuaXNXcml0aW5nID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlcyBmb2xkZXJzIHdoZW4gdGhlIGZvbGRlciBsaW1pdCBpcyBleGNlZWRlZFxuICAgKi9cbiAgYXN5bmMgX2RlbGV0ZU9sZERhdGEoKSB7XG4gICAgY29uc3QgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkZGlyKHRoaXMuX3Jvb3QpO1xuICAgIGNvbnRlbnRzLnJldmVyc2UoKS5zbGljZSh0aGlzLl9maWxlTnVtYmVyTGltaXQpLmZvckVhY2goYXN5bmMgZm9sZGVyTmFtZSA9PiB7XG4gICAgICBhd2FpdCBmcy5yZW1vdmUoYCR7dGhpcy5fcm9vdH0vJHtmb2xkZXJOYW1lfWApOyBcbiAgICB9KTtcbiAgfVxuXG59XG4iXX0=